(function(d,f){if(typeof Object.defineProperty!=="function"){Object.defineProperty=function(h,j,i){if("value" in i){h[j]=i.value}if("get" in i){h.__defineGetter__(j,i.get)}if("set" in i){h.__defineSetter__(j,i.set)}return h}}if(typeof Object.defineProperties!=="function"){Object.defineProperties=function(i,h){for(var j in h){if(h.hasOwnProperty(j)){Object.defineProperty(i,j,h[j])}}return i}}if(typeof Object.create!=="function"){Object.create=function(h,j){function i(){}i.prototype=h;var k=new i();if(j!=null){Object.defineProperties(k,j)}return k}}if(typeof Object.getPrototypeOf!=="function"){Object.getPrototypeOf=function(h){return h.__proto__}}if(typeof Function.prototype.bind!=="function"){Function.prototype.bind=function(h){var l=this;var i=Array.prototype.slice.call(arguments,1);var k=function(){};var j=function(){var m=i.concat(Array.prototype.slice.call(arguments));return l.apply(this instanceof k?this:h||d,m)};k.prototype=l.prototype;j.prototype=new k();return j}}var g=function(i){if(i!=null){if(!(i instanceof Array)){i=Array.prototype.slice.call(arguments)}i=i.filter(function(j){return[j].join()})}(function h(m,n){var k=[],l,j;for(var o in m){if(m.hasOwnProperty(o)){if(typeof m[o]==="function"){d[o]=m[o]}else{if(typeof m[o]==="object"&&Object.getPrototypeOf(m[o])===Object.prototype){if(i==null){k.push(o)}else{l=i.indexOf(n+o);if(l!==-1){k.push(o);i.splice(l,1)}}}}}}for(l=0,j=k.length;l<j;l++){h(m[k[l]],n+k[l]+".")}}(g,""));d.Game=d.Core;if(i!=null&&i.length){throw new Error("Cannot load module: "+i.join(", "))}};d.enchant=g;d.addEventListener("message",function(k,h){try{var i=JSON.parse(k.data);if(i.type==="event"){g.Core.instance.dispatchEvent(new g.Event(i.value))}else{if(i.type==="debug"){switch(i.value){case"start":g.Core.instance.start();break;case"pause":g.Core.instance.pause();break;case"resume":g.Core.instance.resume();break;case"tick":g.Core.instance._tick();break;default:break}}}}catch(j){}},false);g.Class=function(i,h){return g.Class.create(i,h)};g.Class.create=function(n,k){if(n==null){throw new Error("superclass is undefined")}if(arguments.length===0){return g.Class.create(Object,k)}else{if(arguments.length===1&&typeof arguments[0]!=="function"){return g.Class.create(Object,arguments[0])}}for(var m in k){if(k.hasOwnProperty(m)){if(typeof k[m]==="object"&&k[m]!==null&&Object.getPrototypeOf(k[m])===Object.prototype){if(!("enumerable" in k[m])){k[m].enumerable=true}}else{k[m]={value:k[m],enumerable:true,writable:true}}}}var l=function(){if(this instanceof l){l.prototype.initialize.apply(this,arguments)}else{return new l()}};l.prototype=Object.create(n.prototype,k);l.prototype.constructor=l;if(l.prototype.initialize==null){l.prototype.initialize=function(){n.apply(this,arguments)}}var h=this.getInheritanceTree(n);for(var j=h.length-1;j>=0;j--){if(typeof h[j]._inherited==="function"){h[j]._inherited(l);break}}return l};g.Class.getInheritanceTree=function(k){var h=[];var j=k;var i=j.prototype;while(j!==Object){h.push(j);i=Object.getPrototypeOf(i);j=i.constructor}return h};g.ENV={VENDOR_PREFIX:(function(){var h=navigator.userAgent;if(h.indexOf("Opera")!==-1){return"O"}else{if(h.indexOf("MSIE")!==-1){return"ms"}else{if(h.indexOf("WebKit")!==-1){return"webkit"}else{if(navigator.product==="Gecko"){return"Moz"}else{return""}}}}}()),TOUCH_ENABLED:(function(){var h=document.createElement("div");h.setAttribute("ontouchstart","return");return typeof h.ontouchstart==="function"}()),RETINA_DISPLAY:(function(){if(navigator.userAgent.indexOf("iPhone")!==-1&&d.devicePixelRatio===2){var h=document.querySelector('meta[name="viewport"]');if(h==null){h=document.createElement("meta");document.head.appendChild(h)}h.setAttribute("content","width=640");return true}else{return false}}()),USE_FLASH_SOUND:(function(){var h=navigator.userAgent;var i=navigator.vendor||"";return(location.href.indexOf("http")===0&&h.indexOf("Mobile")===-1&&i.indexOf("Apple")!==-1)}()),USE_DEFAULT_EVENT_TAGS:["input","textarea","select","area"],CANVAS_DRAWING_METHODS:["putImageData","drawImage","drawFocusRing","fill","stroke","clearRect","fillRect","strokeRect","fillText","strokeText"],KEY_BIND_TABLE:{37:"left",38:"up",39:"right",40:"down"},PREVENT_DEFAULT_KEY_CODES:[37,38,39,40,32],SOUND_ENABLED_ON_MOBILE_SAFARI:false,USE_WEBAUDIO:(function(){return location.protocol!=="file:"}()),USE_ANIMATION:true};g.Event=g.Class.create({initialize:function(h){this.type=h;this.target=null;this.x=0;this.y=0;this.localX=0;this.localY=0},_initPosition:function(j,i){var h=g.Core.instance;this.x=this.localX=(j-h._pageX)/h.scale;this.y=this.localY=(i-h._pageY)/h.scale}});g.Event.LOAD="load";g.Event.PROGRESS="progress";g.Event.ENTER_FRAME="enterframe";g.Event.EXIT_FRAME="exitframe";g.Event.ENTER="enter";g.Event.EXIT="exit";g.Event.CHILD_ADDED="childadded";g.Event.ADDED="added";g.Event.ADDED_TO_SCENE="addedtoscene";g.Event.CHILD_REMOVED="childremoved";g.Event.REMOVED="removed";g.Event.REMOVED_FROM_SCENE="removedfromscene";g.Event.TOUCH_START="touchstart";g.Event.TOUCH_MOVE="touchmove";g.Event.TOUCH_END="touchend";g.Event.RENDER="render";g.Event.INPUT_START="inputstart";g.Event.INPUT_CHANGE="inputchange";g.Event.INPUT_END="inputend";g.Event.LEFT_BUTTON_DOWN="leftbuttondown";g.Event.LEFT_BUTTON_UP="leftbuttonup";g.Event.RIGHT_BUTTON_DOWN="rightbuttondown";g.Event.RIGHT_BUTTON_UP="rightbuttonup";g.Event.UP_BUTTON_DOWN="upbuttondown";g.Event.UP_BUTTON_UP="upbuttonup";g.Event.DOWN_BUTTON_DOWN="downbuttondown";g.Event.DOWN_BUTTON_UP="downbuttonup";g.Event.A_BUTTON_DOWN="abuttondown";g.Event.A_BUTTON_UP="abuttonup";g.Event.B_BUTTON_DOWN="bbuttondown";g.Event.B_BUTTON_UP="bbuttonup";g.Event.ADDED_TO_TIMELINE="addedtotimeline";g.Event.REMOVED_FROM_TIMELINE="removedfromtimeline";g.Event.ACTION_START="actionstart";g.Event.ACTION_END="actionend";g.Event.ACTION_TICK="actiontick";g.Event.ACTION_ADDED="actionadded";g.Event.ACTION_REMOVED="actionremoved";g.EventTarget=g.Class.create({initialize:function(){this._listeners={}},addEventListener:function(i,j){var h=this._listeners[i];if(h==null){this._listeners[i]=[j]}else{if(h.indexOf(j)===-1){h.unshift(j)}}},on:function(){this.addEventListener.apply(this,arguments)},removeEventListener:function(k,l){var j=this._listeners[k];if(j!=null){var h=j.indexOf(l);if(h!==-1){j.splice(h,1)}}},clearEventListener:function(h){if(h!=null){delete this._listeners[h]}else{this._listeners={}}},dispatchEvent:function(l){l.target=this;l.localX=l.x-this._offsetX;l.localY=l.y-this._offsetY;if(this["on"+l.type]!=null){this["on"+l.type](l)}var k=this._listeners[l.type];if(k!=null){k=k.slice();for(var j=0,h=k.length;j<h;j++){k[j].call(this,l)}}}});(function(){var h;g.Core=g.Class.create(g.EventTarget,{initialize:function(m,x){if(d.document.body===null){throw new Error("document.body is null. Please excute 'new Core()' in window.onload.")}g.EventTarget.call(this);var s=true;if(h){s=false;h.stop()}h=g.Core.instance=this;this.width=m||320;this.height=x||320;this.scale=1;var t=document.getElementById("enchant-stage");if(!t){t=document.createElement("div");t.id="enchant-stage";t.style.position="absolute";if(document.body.firstChild){document.body.insertBefore(t,document.body.firstChild)}else{document.body.appendChild(t)}this.scale=Math.min(d.innerWidth/this.width,d.innerHeight/this.height);this._pageX=0;this._pageY=0}else{var k=d.getComputedStyle(t);m=parseInt(k.width,10);x=parseInt(k.height,10);if(m&&x){this.scale=Math.min(m/this.width,x/this.height)}else{t.style.width=this.width+"px";t.style.height=this.height+"px"}while(t.firstChild){t.removeChild(t.firstChild)}t.style.position="relative";var j=t.getBoundingClientRect();this._pageX=Math.round(d.scrollX||d.pageXOffset+j.left);this._pageY=Math.round(d.scrollY||d.pageYOffset+j.top)}if(!this.scale){this.scale=1}t.style.fontSize="12px";t.style.webkitTextSizeAdjust="none";this._element=t;this.fps=30;this.frame=0;this.ready=null;this.running=false;this.assets={};var q=this._assets=[];(function n(z){if(z.assets instanceof Array){[].push.apply(q,z.assets)}for(var A in z){if(z.hasOwnProperty(A)){if(typeof z[A]==="object"&&Object.getPrototypeOf(z[A])===Object.prototype){n(z[A])}}}}(g));this._scenes=[];this.currentScene=null;this.rootScene=new g.Scene();this.pushScene(this.rootScene);this.loadingScene=new g.Scene();this.loadingScene.backgroundColor="#000";var y=this.width*0.4|0;var w=this.width*0.05|0;var p=y*0.03|0;var r=new g.Sprite(y,w);r.x=(this.width-y)/2;r.y=(this.height-w)/2;var o=new g.Surface(y,w);o.context.fillStyle="#fff";o.context.fillRect(0,0,y,w);o.context.fillStyle="#000";o.context.fillRect(p,p,y-p*2,w-p*2);r.image=o;var i=0,l=0;this.addEventListener("progress",function(z){i=z.loaded/z.total});r.addEventListener("enterframe",function(){l*=0.9;l+=i*0.1;o.context.fillStyle="#fff";o.context.fillRect(p,0,(y-p*2)*l,w)});this.loadingScene.addChild(r);this._mousedownID=0;this._surfaceID=0;this._soundID=0;this._intervalID=null;this._offsetX=0;this._offsetY=0;this.input={};this._keybind=g.ENV.KEY_BIND_TABLE||{};var u=0;["left","right","up","down","a","b"].forEach(function(z){this.addEventListener(z+"buttondown",function(A){var B;if(!this.input[z]){this.input[z]=true;B=new g.Event((u++)?"inputchange":"inputstart");this.dispatchEvent(B)}this.currentScene.dispatchEvent(A);if(B){this.currentScene.dispatchEvent(B)}});this.addEventListener(z+"buttonup",function(A){var B;if(this.input[z]){this.input[z]=false;B=new g.Event((--u)?"inputchange":"inputend");this.dispatchEvent(B)}this.currentScene.dispatchEvent(A);if(B){this.currentScene.dispatchEvent(B)}})},this);if(s){t=g.Core.instance._element;var v;document.addEventListener("keydown",function(A){h.dispatchEvent(new g.Event("keydown"));if(g.ENV.PREVENT_DEFAULT_KEY_CODES.indexOf(A.keyCode)!==-1){A.preventDefault();A.stopPropagation()}if(!h.running){return}var z=h._keybind[A.keyCode];if(z){v=new g.Event(z+"buttondown");h.dispatchEvent(v)}},true);document.addEventListener("keyup",function(A){if(!h.running){return}var z=h._keybind[A.keyCode];if(z){v=new g.Event(z+"buttonup");h.dispatchEvent(v)}},true);if(g.ENV.TOUCH_ENABLED){t.addEventListener("touchstart",function(A){var z=(A.target.tagName).toLowerCase();if(g.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(z)===-1){A.preventDefault();if(!h.running){A.stopPropagation()}}},true);t.addEventListener("touchmove",function(A){var z=(A.target.tagName).toLowerCase();if(g.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(z)===-1){A.preventDefault();if(!h.running){A.stopPropagation()}}},true);t.addEventListener("touchend",function(A){var z=(A.target.tagName).toLowerCase();if(g.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(z)===-1){A.preventDefault();if(!h.running){A.stopPropagation()}}},true)}t.addEventListener("mousedown",function(A){var z=(A.target.tagName).toLowerCase();if(g.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(z)===-1){A.preventDefault();h._mousedownID++;if(!h.running){A.stopPropagation()}}},true);t.addEventListener("mousemove",function(A){var z=(A.target.tagName).toLowerCase();if(g.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(z)===-1){A.preventDefault();if(!h.running){A.stopPropagation()}}},true);t.addEventListener("mouseup",function(A){var z=(A.target.tagName).toLowerCase();if(g.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(z)===-1){A.preventDefault();if(!h.running){A.stopPropagation()}}},true);h._touchEventTarget={};if(g.ENV.TOUCH_ENABLED){t.addEventListener("touchstart",function(F){var B=g.Core.instance;var A=new g.Event(g.Event.TOUCH_START);var E=F.changedTouches;var G,D;for(var C=0,z=E.length;C<z;C++){G=E[C];A._initPosition(G.pageX,G.pageY);D=B.currentScene._determineEventTarget(A);B._touchEventTarget[G.identifier]=D;D.dispatchEvent(A)}},false);t.addEventListener("touchmove",function(F){var B=g.Core.instance;var A=new g.Event(g.Event.TOUCH_MOVE);var E=F.changedTouches;var G,D;for(var C=0,z=E.length;C<z;C++){G=E[C];D=B._touchEventTarget[G.identifier];if(D){A._initPosition(G.pageX,G.pageY);D.dispatchEvent(A)}}},false);t.addEventListener("touchend",function(F){var B=g.Core.instance;var A=new g.Event(g.Event.TOUCH_END);var E=F.changedTouches;var G,D;for(var C=0,z=E.length;C<z;C++){G=E[C];D=B._touchEventTarget[G.identifier];if(D){A._initPosition(G.pageX,G.pageY);D.dispatchEvent(A);delete B._touchEventTarget[G.identifier]}}},false)}t.addEventListener("mousedown",function(C){var A=g.Core.instance;var z=new g.Event(g.Event.TOUCH_START);z._initPosition(C.pageX,C.pageY);var B=A.currentScene._determineEventTarget(z);A._touchEventTarget[A._mousedownID]=B;B.dispatchEvent(z)},false);t.addEventListener("mousemove",function(C){var A=g.Core.instance;var z=new g.Event(g.Event.TOUCH_MOVE);z._initPosition(C.pageX,C.pageY);var B=A._touchEventTarget[A._mousedownID];if(B){B.dispatchEvent(z)}},false);t.addEventListener("mouseup",function(B){var A=g.Core.instance;var z=new g.Event(g.Event.TOUCH_END);z._initPosition(B.pageX,B.pageY);A._touchEventTarget[A._mousedownID].dispatchEvent(z);delete A._touchEventTarget[A._mousedownID]},false)}},preload:function(i){if(!(i instanceof Array)){i=Array.prototype.slice.call(arguments)}[].push.apply(this._assets,i)},load:function(k,l){if(l==null){l=function(){}}var i=g.Core.findExt(k);if(g.Core._loadFuncs[i]){g.Core._loadFuncs[i].call(this,k,l,i)}else{var j=new XMLHttpRequest();j.open("GET",k,true);j.onreadystatechange=function(n){if(j.readyState===4){if(j.status!==200&&j.status!==0){throw new Error(j.status+": Cannot load an asset: "+k)}var m=j.getResponseHeader("Content-Type")||"";if(m.match(/^image/)){h.assets[k]=g.Surface.load(k);h.assets[k].addEventListener("load",l)}else{if(m.match(/^audio/)){h.assets[k]=g.Sound.load(k,m);h.assets[k].addEventListener("load",l)}else{h.assets[k]=j.responseText;l()}}}};j.send(null)}},start:function(){var l=function(){this.currentTime=this.getTime();this.removeEventListener("load",l);this._intervalID=d.setInterval(function(){h._tick()},1000/this.fps);this.running=true};this.addEventListener("load",l);if(this._intervalID){d.clearInterval(this._intervalID)}else{if(this._assets.length){if(g.Sound.enabledInMobileSafari&&!h._touched&&g.ENV.VENDOR_PREFIX==="webkit"&&g.ENV.TOUCH_ENABLED){var r=new g.Scene();r.backgroundColor="#000";var u=Math.round(h.width/10);var t=new g.Sprite(h.width,u);t.y=(h.height-u)/2;t.image=new g.Surface(h.width,u);t.image.context.fillStyle="#fff";t.image.context.font=(u-1)+"px bold Helvetica,Arial,sans-serif";var j=t.image.context.measureText("Touch to Start").width;t.image.context.fillText("Touch to Start",(h.width-j)/2,u-1);r.addChild(t);document.addEventListener("touchstart",function(){h._touched=true;h.removeScene(r);h.start()},true);h.pushScene(r);return}var k={};var n=this._assets.filter(function(i){return i in k?false:k[i]=true});var q=0,s=n.length,m=function(){var i=new g.Event("progress");i.loaded=++q;i.total=s;h.dispatchEvent(i);if(q===s){h.removeScene(h.loadingScene);h.dispatchEvent(new g.Event("load"))}};for(var p=0;p<s;p++){this.load(n[p],m)}this.pushScene(this.loadingScene)}else{this.dispatchEvent(new g.Event("load"))}}},debug:function(){this._debug=true;this.rootScene.addEventListener("enterframe",function(i){this._actualFps=(1/i)});this.start()},actualFps:{get:function(){return this._actualFps||this.fps}},_tick:function(){var k=this.getTime();var m=new g.Event("enterframe");m.elapsed=k-this.currentTime;this.currentTime=k;var i=this.currentScene.childNodes.slice();var j=Array.prototype.push;while(i.length){var l=i.pop();l.age++;l.dispatchEvent(m);if(l.childNodes){j.apply(i,l.childNodes)}}this.currentScene.age++;this.currentScene.dispatchEvent(m);this.dispatchEvent(m);this.dispatchEvent(new g.Event("exitframe"));this.frame++},getTime:function(){if(d.performance&&d.performance.now){return d.performance.now()}else{if(d.performance&&d.performance.webkitNow){return d.performance.webkitNow()}else{return Date.now()}}},stop:function(){if(this._intervalID){d.clearInterval(this._intervalID);this._intervalID=null}this.running=false},pause:function(){if(this._intervalID){d.clearInterval(this._intervalID);this._intervalID=null}},resume:function(){if(this._intervalID){return}this.currentTime=this.getTime();this._intervalID=d.setInterval(function(){h._tick()},1000/this.fps);this.running=true},pushScene:function(i){this._element.appendChild(i._element);if(this.currentScene){this.currentScene.dispatchEvent(new g.Event("exit"))}this.currentScene=i;this.currentScene.dispatchEvent(new g.Event("enter"));return this._scenes.push(i)},popScene:function(){if(this.currentScene===this.rootScene){return this.currentScene}this._element.removeChild(this.currentScene._element);this.currentScene.dispatchEvent(new g.Event("exit"));this.currentScene=this._scenes[this._scenes.length-2];this.currentScene.dispatchEvent(new g.Event("enter"));return this._scenes.pop()},replaceScene:function(i){this.popScene();return this.pushScene(i)},removeScene:function(k){if(this.currentScene===k){return this.popScene()}else{var j=this._scenes.indexOf(k);if(j!==-1){this._scenes.splice(j,1);this._element.removeChild(k._element);return k}else{return null}}},keybind:function(j,i){this._keybind[j]=i},getElapsedTime:function(){return this.frame/this.fps}});g.Core._loadFuncs={};g.Core._loadFuncs.jpg=g.Core._loadFuncs.jpeg=g.Core._loadFuncs.gif=g.Core._loadFuncs.png=g.Core._loadFuncs.bmp=function(i,j){this.assets[i]=g.Surface.load(i);this.assets[i].addEventListener("load",j)};g.Core._loadFuncs.mp3=g.Core._loadFuncs.aac=g.Core._loadFuncs.m4a=g.Core._loadFuncs.wav=g.Core._loadFuncs.ogg=function(j,k,i){this.assets[j]=g.Sound.load(j,"audio/"+i);this.assets[j].addEventListener("load",k)};g.Core.findExt=function(j){var i=j.match(/\.\w+$/);if(i&&i.length>0){return i[0].slice(1).toLowerCase()}if(j.indexOf("data:")===0){return j.split(/[\/;]/)[1].toLowerCase()}return null};g.Core.instance=null}());g.Game=g.Core;g.Node=g.Class.create(g.EventTarget,{initialize:function(){g.EventTarget.call(this);this._dirty=false;this._matrix=[1,0,0,1,0,0];this._x=0;this._y=0;this._offsetX=0;this._offsetY=0;this.age=0;this.parentNode=null;this.scene=null;this.addEventListener("touchstart",function(i){if(this.parentNode){this.parentNode.dispatchEvent(i)}});this.addEventListener("touchmove",function(i){if(this.parentNode){this.parentNode.dispatchEvent(i)}});this.addEventListener("touchend",function(i){if(this.parentNode){this.parentNode.dispatchEvent(i)}});if(g.ENV.USE_ANIMATION){var h=this.tl=new g.Timeline(this)}},moveTo:function(h,i){this._x=h;this._y=i;this._dirty=true},moveBy:function(h,i){this._x+=h;this._y+=i;this._dirty=true},x:{get:function(){return this._x},set:function(h){this._x=h;this._dirty=true}},y:{get:function(){return this._y},set:function(h){this._y=h;this._dirty=true}},_updateCoordinate:function(){var m=this;var v=[m];var s=m.parentNode;var p=this.scene;while(s&&m._dirty){v.unshift(s);m=m.parentNode;s=m.parentNode}var r=g.Matrix.instance;var q=r.stack;var u=[];var t,j,h;q.push(v[0]._matrix);for(var o=1,n=v.length;o<n;o++){m=v[o];t=[];r.makeTransformMatrix(m,u);r.multiply(q[q.length-1],u,t);m._matrix=t;q.push(t);j=(typeof m._originX==="number")?m._originX:m._width/2||0;h=(typeof m._originY==="number")?m._originY:m._height/2||0;var k=[j,h];r.multiplyVec(t,k,k);m._offsetX=k[0]-j;m._offsetY=k[1]-h;m._dirty=false}r.reset()},remove:function(){if(this._listener){this.clearEventListener()}if(this.parentNode){this.parentNode.removeChild(this)}}});var a=function(k,h){var m=[];var o;for(var n=0,j=k.collection.length;n<j;n++){o=k.collection[n];if(h._intersectone(o)){m.push(o)}}return m};var e=function(q,p){var r=[];var n,k;for(var o=0,h=q.collection.length;o<h;o++){n=q.collection[o];for(var m=0,s=p.collection.length;m<s;m++){k=p.collection[m];if(n._intersectone(k)){r.push([n,k])}}}return r};var b=function(h){if(h instanceof g.Entity){return a(this,h)}else{if(typeof h==="function"&&h.collection){return e(this,h)}}return false};g.Entity=g.Class.create(g.Node,{initialize:function(){var h=g.Core.instance;g.Node.call(this);this._rotation=0;this._scaleX=1;this._scaleY=1;this._touchEnabled=true;this._clipping=false;this._originX=null;this._originY=null;this._width=0;this._height=0;this._backgroundColor=null;this._opacity=1;this._visible=true;this._buttonMode=null;this._style={};this.__styleStatus={};this.compositeOperation=null;this.buttonMode=null;this.buttonPressed=false;this.addEventListener("touchstart",function(){if(!this.buttonMode){return}this.buttonPressed=true;var i=new g.Event(this.buttonMode+"buttondown");this.dispatchEvent(i);h.dispatchEvent(i)});this.addEventListener("touchend",function(){if(!this.buttonMode){return}this.buttonPressed=false;var i=new g.Event(this.buttonMode+"buttonup");this.dispatchEvent(i);h.dispatchEvent(i)});this.enableCollection()},width:{get:function(){return this._width},set:function(h){this._width=h;this._dirty=true}},height:{get:function(){return this._height},set:function(h){this._height=h;this._dirty=true}},backgroundColor:{get:function(){return this._backgroundColor},set:function(h){this._backgroundColor=h}},opacity:{get:function(){return this._opacity},set:function(h){this._opacity=h}},visible:{get:function(){return this._visible},set:function(h){this._visible=h}},touchEnabled:{get:function(){return this._touchEnabled},set:function(h){this._touchEnabled=h;if(this._touchEnabled=h){this._style.pointerEvents="all"}else{this._style.pointerEvents="none"}}},intersect:function(h){if(h instanceof g.Entity){return this._intersectone(h)}else{if(typeof h==="function"&&h.collection){return a(h,this)}}return false},_intersectone:function(h){if(this._dirty){this._updateCoordinate()}if(h._dirty){h._updateCoordinate()}return this._offsetX<h._offsetX+h.width&&h._offsetX<this._offsetX+this.width&&this._offsetY<h._offsetY+h.height&&h._offsetY<this._offsetY+this.height},within:function(h,j){if(this._dirty){this._updateCoordinate()}if(h._dirty){h._updateCoordinate()}if(j==null){j=(this.width+this.height+h.width+h.height)/4}var i;return(i=this._offsetX-h._offsetX+(this.width-h.width)/2)*i+(i=this._offsetY-h._offsetY+(this.height-h.height)/2)*i<j*j},scale:function(h,i){this._scaleX*=h;this._scaleY*=(i!=null)?i:h;this._dirty=true},rotate:function(h){this._rotation+=h;this._dirty=true},scaleX:{get:function(){return this._scaleX},set:function(h){this._scaleX=h;this._dirty=true}},scaleY:{get:function(){return this._scaleY},set:function(h){this._scaleY=h;this._dirty=true}},rotation:{get:function(){return this._rotation},set:function(h){this._rotation=h;this._dirty=true}},originX:{get:function(){return this._originX},set:function(h){this._originX=h;this._dirty=true}},originY:{get:function(){return this._originY},set:function(h){this._originY=h;this._dirty=true}},enableCollection:function(){this.addEventListener("addedtoscene",this._addSelfToCollection);this.addEventListener("removedfromscene",this._removeSelfFromCollection);if(this.scene){this._addSelfToCollection()}},disableCollection:function(){this.removeEventListener("addedtoscene",this._addSelfToCollection);this.removeEventListener("removedfromscene",this._removeSelfFromCollection);if(this.scene){this._removeSelfFromCollection()}},_addSelfToCollection:function(){var h=this.getConstructor();h._collectionTarget.forEach(function(i){i.collection.push(this)},this)},_removeSelfFromCollection:function(){var h=this.getConstructor();h._collectionTarget.forEach(function(k){var j=k.collection.indexOf(this);if(j!==-1){k.collection.splice(j,1)}},this)},getConstructor:function(){return Object.getPrototypeOf(this).constructor}});var c=function(k){if(k._collective){return}var h=g.Class.getInheritanceTree(k);var j=h.indexOf(g.Entity);if(j!==-1){k._collectionTarget=h.splice(0,j+1)}else{k._collectionTarget=[]}k.intersect=b;k.collection=[];k._collective=true};c(g.Entity);g.Entity._inherited=function(h){c(h)};g.Sprite=g.Class.create(g.Entity,{initialize:function(i,h){g.Entity.call(this);this.width=i;this.height=h;this._image=null;this._frameLeft=0;this._frameTop=0;this._frame=0;this._frameSequence=[];this.addEventListener("enterframe",function(){if(this._frameSequence.length!==0){var j=this._frameSequence.shift();if(j===null){this._frameSequence=[]}else{this._setFrame(j);this._frameSequence.push(j)}}})},image:{get:function(){return this._image},set:function(h){if(h===this._image){return}this._image=h;this._setFrame(this._frame)}},frame:{get:function(){return this._frame},set:function(j){if(this._frame===j){return}if(j instanceof Array){var h=j;var i=h.shift();this._setFrame(i);h.push(i);this._frameSequence=h}else{this._setFrame(j);this._frameSequence=[];this._frame=j}}},_setFrame:function(k){var i=this._image;var j,h;if(i!=null){this._frame=k;j=i.width/this._width|0;this._frameLeft=(k%j|0)*this._width;this._frameTop=(k/j|0)*this._height%i.height}},width:{get:function(){return this._width},set:function(h){this._width=h;this._setFrame();this._dirty=true}},height:{get:function(){return this._height},set:function(h){this._height=h;this._setFrame();this._dirty=true}},cvsRender:function(u){if(this._image==null||this._width===0||this._height===0){return}var j=this._image;var k=j._element;var r=this._frameLeft;var p=this._frameTop;var t=Math.min(this.width,j.width-r);var m=Math.min(this.height,j.height-p);var i=Math.min(j.width,this.width);var n=Math.min(j.height,this.height);var q,o,s,l;for(o=0;o<this.height;o+=n){l=(this.height<o+n)?this.height-o:n;for(q=0;q<this.width;q+=i){s=(this.width<q+i)?this.width-q:i;u.drawImage(k,r,p,t*s/i,m*l/n,q,o,s,l)}}},domRender:function(h){if(this._image){if(this._image._css){this._style["background-image"]=this._image._css;this._style["background-position"]=-this._frameLeft+"px "+-this._frameTop+"px"}else{if(this._image._element){}}}}});g.Label=g.Class.create(g.Entity,{initialize:function(h){g.Entity.call(this);this.width=300;this.font="14px serif";this.text=h||"";this.textAlign="left"},text:{get:function(){return this._text},set:function(m){if(this._text===m){return}this._text=m;m=m.replace(/<(br|BR) ?\/?>/g,"<br/>");this._splitText=m.split("<br/>");var k=this.getMetrics();this._boundWidth=k.width;this._boundHeight=k.height;for(var j=0,h=this._splitText.length;j<h;j++){m=this._splitText[j];k=this.getMetrics(m);this._splitText[j]={};this._splitText[j].text=m;this._splitText[j].height=k.height}}},textAlign:{get:function(){return this._style["text-align"]},set:function(h){this._style["text-align"]=h}},font:{get:function(){return this._style.font},set:function(h){this._style.font=h}},color:{get:function(){return this._style.color},set:function(h){this._style.color=h}},cvsRender:function(s){var q=0;var r,h,o;if(this._splitText){s.textBaseline="top";s.font=this.font;s.fillStyle=this.color||"#000000";for(var n=0,k=this._splitText.length;n<k;n++){r=this._splitText[n];h="";for(var m=0,p=r.text.length;m<p;m++){o=r.text[m];if(s.measureText(h).width>this.width){s.fillText(h,0,q);q+=r.height-1;h=""}h+=o}s.fillText(h,0,q);q+=r.height-1}}},domRender:function(h){if(h.innerHTML!==this._text){h.innerHTML=this._text}},detectRender:function(h){h.fillRect(0,0,this._boundWidth,this._boundHeight)}});g.Label.prototype.getMetrics=function(k){var i={};var m,j,h;if(document.body){m=document.createElement("div");for(var l in this._style){if(l!=="width"&&l!=="height"){m.style[l]=this._style[l]}}m.innerHTML=k||this._text;document.body.appendChild(m);i.height=parseInt(getComputedStyle(m).height,10)+1;m.style.position="absolute";i.width=parseInt(getComputedStyle(m).width,10)+1;document.body.removeChild(m)}else{i.width=this.width;i.height=this.height}return i};g.Map=g.Class.create(g.Entity,{initialize:function(l,j){var i=g.Core.instance;g.Entity.call(this);var h=new g.Surface(i.width,i.height);this._surface=h;var k=h._element;k.style.position="absolute";if(g.ENV.RETINA_DISPLAY&&i.scale===2){k.width=i.width*2;k.height=i.height*2;this._style.webkitTransformOrigin="0 0";this._style.webkitTransform="scale(0.5)"}else{k.width=i.width;k.height=i.height}this._context=k.getContext("2d");this._tileWidth=l||0;this._tileHeight=j||0;this._image=null;this._data=[[[]]];this._dirty=false;this._tight=false;this.touchEnabled=false;this.collisionData=null;this._listeners.render=null;this.addEventListener("render",function(){if(this._dirty||this._previousOffsetX==null){this.redraw(0,0,i.width,i.height)}else{if(this._offsetX!==this._previousOffsetX||this._offsetY!==this._previousOffsetY){if(this._tight){var w=-this._offsetX;var t=-this._offsetY;var A=-this._previousOffsetX;var v=-this._previousOffsetY;var p=w-A+i.width;var n=A-w+i.width;var r=t-v+i.height;var q=v-t+i.height;if(p>this._tileWidth&&n>this._tileWidth&&r>this._tileHeight&&q>this._tileHeight){var u,s,C,B,z,o;if(p<n){u=0;C=A-w;z=p}else{u=w-A;C=0;z=n}if(r<q){s=0;B=v-t;o=r}else{s=t-v;B=0;o=q}if(i._buffer==null){i._buffer=document.createElement("canvas");i._buffer.width=this._context.canvas.width;i._buffer.height=this._context.canvas.height}var m=i._buffer.getContext("2d");if(this._doubledImage){m.clearRect(0,0,z*2,o*2);m.drawImage(this._context.canvas,u*2,s*2,z*2,o*2,0,0,z*2,o*2);m=this._context;m.clearRect(C*2,B*2,z*2,o*2);m.drawImage(i._buffer,0,0,z*2,o*2,C*2,B*2,z*2,o*2)}else{m.clearRect(0,0,z,o);m.drawImage(this._context.canvas,u,s,z,o,0,0,z,o);m=this._context;m.clearRect(C,B,z,o);m.drawImage(i._buffer,0,0,z,o,C,B,z,o)}if(C===0){this.redraw(z,0,i.width-z,i.height)}else{this.redraw(0,0,i.width-z,i.height)}if(B===0){this.redraw(0,o,i.width,i.height-o)}else{this.redraw(0,0,i.width,i.height-o)}}else{this.redraw(0,0,i.width,i.height)}}else{this.redraw(0,0,i.width,i.height)}}}this._previousOffsetX=this._offsetX;this._previousOffsetY=this._offsetY})},loadData:function(n){this._data=Array.prototype.slice.apply(arguments);this._dirty=true;this._tight=false;for(var m=0,j=this._data.length;m<j;m++){var q=0;n=this._data[m];for(var p=0,k=n.length;p<k;p++){for(var h=0,o=n[p].length;h<o;h++){if(n[p][h]>=0){q++}}}if(q/(n.length*n[0].length)>0.2){this._tight=true;break}}},checkTile:function(i,n){if(i<0||this.width<=i||n<0||this.height<=n){return false}var k=this._image.width;var h=this._image.height;var m=this._tileWidth||k;var j=this._tileHeight||h;i=i/m|0;n=n/j|0;var l=this._data[0];return l[n][i]},hitTest:function(r,p){if(r<0||this.width<=r||p<0||this.height<=p){return false}var h=this._image.width;var s=this._image.height;var q=this._tileWidth||h;var m=this._tileHeight||s;r=r/q|0;p=p/m|0;if(this.collisionData!=null){return this.collisionData[p]&&!!this.collisionData[p][r]}else{for(var l=0,o=this._data.length;l<o;l++){var k=this._data[l];var j;if(k[p]!=null&&(j=k[p][r])!=null&&0<=j&&j<(h/q|0)*(s/m|0)){return true}}return false}},image:{get:function(){return this._image},set:function(j){var i=g.Core.instance;this._image=j;if(g.ENV.RETINA_DISPLAY&&i.scale===2){var k=new g.Surface(j.width*2,j.height*2);var o=this._tileWidth||j.width;var l=this._tileHeight||j.height;var p=j.width/o|0;var h=j.height/l|0;for(var m=0;m<h;m++){for(var n=0;n<p;n++){k.draw(j,n*o,m*l,o,l,n*o*2,m*l*2,o*2,l*2)}}this._doubledImage=k}this._dirty=true}},tileWidth:{get:function(){return this._tileWidth},set:function(h){this._tileWidth=h;this._dirty=true}},tileHeight:{get:function(){return this._tileHeight},set:function(h){this._tileHeight=h;this._dirty=true}},width:{get:function(){return this._tileWidth*this._data[0][0].length}},height:{get:function(){return this._tileHeight*this._data[0].length}},redraw:function(t,s,F,C){if(this._image==null){return}var D,h,q,v,u;if(this._doubledImage){D=this._doubledImage;h=this._tileWidth*2;q=this._tileHeight*2;v=-this._offsetX*2;u=-this._offsetY*2;t*=2;s*=2;F*=2;C*=2}else{D=this._image;h=this._tileWidth;q=this._tileHeight;v=-this._offsetX;u=-this._offsetY}var o=D.width/h|0;var m=D.height/q|0;var l=Math.max((t+v)/h|0,0);var A=Math.max((s+u)/q|0,0);var J=Math.ceil((t+v+F)/h);var p=Math.ceil((s+u+C)/q);var G=D._element;var j=this._context;var k=j.canvas;j.clearRect(t,s,F,C);for(var H=0,I=this._data.length;H<I;H++){var L=this._data[H];var z=Math.min(J,L[0].length);var K=Math.min(p,L.length);for(s=A;s<K;s++){for(t=l;t<z;t++){var E=L[s][t];if(0<=E&&E<o*m){var B=(E%o)*h;var w=(E/o|0)*q;j.drawImage(G,B,w,h,q,t*h-v,s*q-u,h,q)}}}}},cvsRender:function(h){var i=g.Game.instance;if(this.width!==0&&this.height!==0){h.save();h.setTransform(1,0,0,1,0,0);var j=this._context.canvas;h.drawImage(j,0,0,i.width,i.height);h.restore()}},domRender:function(h){if(this._image){this._style["background-image"]=this._surface._css;this._style[g.ENV.VENDOR_PREFIX+"Transform"]="matrix(1, 0, 0, 1, 0, 0)"}}});g.Group=g.Class.create(g.Node,{initialize:function(){this.childNodes=[];g.Node.call(this);this._rotation=0;this._scaleX=1;this._scaleY=1;this._originX=null;this._originY=null;this.__dirty=false;[g.Event.ADDED_TO_SCENE,g.Event.REMOVED_FROM_SCENE].forEach(function(h){this.addEventListener(h,function(i){this.childNodes.forEach(function(j){j.scene=this.scene;j.dispatchEvent(i)},this)})},this)},addChild:function(j){this.childNodes.push(j);j.parentNode=this;var h=new g.Event("childadded");h.node=j;h.next=null;this.dispatchEvent(h);j.dispatchEvent(new g.Event("added"));if(this.scene){j.scene=this.scene;var i=new g.Event("addedtoscene");j.dispatchEvent(i)}},insertBefore:function(m,h){var l=this.childNodes.indexOf(h);if(l!==-1){this.childNodes.splice(l,0,m);m.parentNode=this;var j=new g.Event("childadded");j.node=m;j.next=h;this.dispatchEvent(j);m.dispatchEvent(new g.Event("added"));if(this.scene){m.scene=this.scene;var k=new g.Event("addedtoscene");m.dispatchEvent(k)}}else{this.addChild(m)}},removeChild:function(j){var h;if((h=this.childNodes.indexOf(j))!==-1){this.childNodes.splice(h,1);j.parentNode=null;var k=new g.Event("childremoved");k.node=j;this.dispatchEvent(k);j.dispatchEvent(new g.Event("removed"));if(this.scene){j.scene=null;var l=new g.Event("removedfromscene");j.dispatchEvent(l)}}},firstChild:{get:function(){return this.childNodes[0]}},lastChild:{get:function(){return this.childNodes[this.childNodes.length-1]}},rotation:{get:function(){return this._rotation},set:function(h){this._rotation=h;this._dirty=true}},scaleX:{get:function(){return this._scaleX},set:function(h){this._scaleX=h;this._dirty=true}},scaleY:{get:function(){return this._scaleY},set:function(h){this._scaleY=h;this._dirty=true}},originX:{get:function(){return this._originX},set:function(h){this._originX=h;this._dirty=true}},originY:{get:function(){return this._originY},set:function(h){this._originY=h;this._dirty=true}},_dirty:{get:function(){return this.__dirty},set:function(k){k=!!k;this.__dirty=k;if(k){for(var j=0,h=this.childNodes.length;j<h;j++){this.childNodes[j]._dirty=true}}}}});g.Matrix=g.Class.create({initialize:function(){if(g.Matrix.instance){return g.Matrix.instance}this.reset()},reset:function(){this.stack=[];this.stack.push([1,0,0,1,0,0])},makeTransformMatrix:function(r,m){var n=r._x;var l=r._y;var q=r.width||0;var p=r.height||0;var s=r._rotation||0;var A=(typeof r._scaleX==="number")?r._scaleX:1;var v=(typeof r._scaleY==="number")?r._scaleY:1;var k=s*Math.PI/180;var j=Math.cos(k);var i=Math.sin(k);var o=(typeof r._originX==="number")?r._originX:q/2;var t=(typeof r._originY==="number")?r._originY:p/2;var C=A*j;var B=A*i;var z=v*i;var u=v*j;m[0]=C;m[1]=B;m[2]=-z;m[3]=u;m[4]=(-C*o+z*t+n+o);m[5]=(-B*o-u*t+l+t)},multiply:function(v,t,r){var u=v[0],o=v[2],j=v[4],s=v[1],n=v[3],h=v[5];var k=t[0],q=t[2],m=t[4],i=t[1],p=t[3],l=t[5];r[0]=u*k+o*i;r[1]=s*k+n*i;r[2]=u*q+o*p;r[3]=s*q+n*p;r[4]=u*m+o*l+j;r[5]=s*m+n*l+h},multiplyVec:function(r,j,q){var p=j[0],o=j[1];var l=r[0],i=r[2],n=r[4],k=r[1],h=r[3],m=r[5];q[0]=l*p+i*o+n;q[1]=k*p+h*o+m}});g.Matrix.instance=new g.Matrix();g.DetectColorManager=g.Class.create({initialize:function(m,h){this.reference=[];this.colorResolution=m||16;this.max=h||1;this.capacity=Math.pow(this.colorResolution,3);for(var k=1,j=this.capacity;k<j;k++){this.reference[k]=null}},attachDetectColor:function(j){var h=this.reference.indexOf(null);if(h===-1){h=1}this.reference[h]=j;return this._getColor(h)},detachDetectColor:function(j){var h=this.reference.indexOf(j);if(h!==-1){this.reference[h]=null}},_getColor:function(j){var i=this.colorResolution;var h=i/this.max;return[parseInt((j/i/i)%i,10)/h,parseInt((j/i)%i,10)/h,parseInt(j%i,10)/h,1]},_decodeDetectColor:function(h){var i=this.colorResolution;return ~~(h[0]*i*i*i/256)+~~(h[1]*i*i/256)+~~(h[2]*i/256)},getSpriteByColor:function(h){return this.reference[this._decodeDetectColor(h)]}});g.DomManager=g.Class.create({initialize:function(j,k){var h=g.Game.instance;this.layer=null;this.targetNode=j;if(typeof k==="string"){this.element=document.createElement(k)}else{if(k instanceof HTMLElement){this.element=k}}this.style=this.element.style;this.style.position="absolute";this.style[g.ENV.VENDOR_PREFIX+"TransformOrigin"]="0px 0px";if(h._debug){this.style.border="1px solid blue";this.style.margin="-1px"}var i=this;this._setDomTarget=function(){i.layer._touchEventTarget=i.targetNode};this._attachEvent()},getDomElement:function(){return this.element},getDomElementAsNext:function(){return this.element},getNextManager:function(j){var h=this.targetNode.parentNode.childNodes.indexOf(j.targetNode);if(h!==this.targetNode.parentNode.childNodes.length-1){return this.targetNode.parentNode.childNodes[h+1]._domManager}else{return null}},addManager:function(h,k){var j;if(k){j=k.getDomElementAsNext()}var i=h.getDomElement();if(i instanceof Array){i.forEach(function(l){this.element.insertBefore(l,j)},this)}else{this.element.insertBefore(i,j)}this.setLayer(this.layer)},removeManager:function(h){if(h instanceof g.DomlessManager){h._domRef.forEach(function(i){this.element.removeChild(i)},this)}else{this.element.removeChild(h.element)}this.setLayer(this.layer)},setLayer:function(m){this.layer=m;var n=this.targetNode;var k;if(n.childNodes){for(var j=0,h=n.childNodes.length;j<h;j++){k=n.childNodes[j]._domManager;if(k){k.setLayer(m)}}}},render:function(o){var n=this.targetNode;var k=g.Matrix.instance;var h=k.stack;var l=[];k.makeTransformMatrix(n,l);k.multiply(h[h.length-1],l,l);k.multiply(o,l,o);n._matrix=o;var j=(typeof n._originX==="number")?n._originX:n.width/2||0;var i=(typeof n._originY==="number")?n._originY:n.height/2||0;var m=[j,i];k.multiplyVec(l,m,m);n._offsetX=m[0]-j;n._offsetY=m[1]-i;if(n.parentNode&&!(n.parentNode instanceof g.Group)){n._offsetX+=n.parentNode._offsetX;n._offsetY+=n.parentNode._offsetY}this.style[g.ENV.VENDOR_PREFIX+"Transform"]="matrix("+l[0].toFixed(10)+","+l[1].toFixed(10)+","+l[2].toFixed(10)+","+l[3].toFixed(10)+","+l[4].toFixed(10)+","+l[5].toFixed(10)+")";this.domRender()},domRender:function(){var h=this.targetNode;if(!h._style){h._style={}}if(!h.__styleStatus){h.__styleStatus={}}h._style.width=h.width+"px";h._style.height=h.height+"px";h._style.opacity=h._opacity;h._style["background-color"]=h._backgroundColor;if(typeof h._visible!=="undefined"){h._style.display=h._visible?"block":"none"}if(typeof h.domRender==="function"){h.domRender(this.element)}for(var i in h._style){if(h.__styleStatus[i]!==h._style[i]){this.style.setProperty(i,h._style[i]);h.__styleStatus[i]=h._style[i]}}},_attachEvent:function(){if(g.ENV.TOUCH_ENABLED){this.element.addEventListener("touchstart",this._setDomTarget,true)}this.element.addEventListener("mousedown",this._setDomTarget,true)},_detachEvent:function(){if(g.ENV.TOUCH_ENABLED){this.element.removeEventListener("touchstart",this._setDomTarget,true)}this.element.removeEventListener("mousedown",this._setDomTarget,true)},remove:function(){this._detachEvent();this.element=this.style=this.targetNode=null}});g.DomlessManager=g.Class.create({initialize:function(h){this._domRef=[];this.targetNode=h},_register:function(k,j){var h=this._domRef.indexOf(j);var l;if(k instanceof Array){if(h===-1){Array.prototype.push.apply(this._domRef,k)}else{Array.prototype.splice.apply(this._domRef,[h,0].concat(k))}}else{if(h===-1){this._domRef.push(k)}else{this._domRef.splice(h,0,k)}}},getNextManager:function(j){var h=this.targetNode.parentNode.childNodes.indexOf(j.targetNode);if(h!==this.targetNode.parentNode.childNodes.length-1){return this.targetNode.parentNode.childNodes[h+1]._domManager}else{return null}},getDomElement:function(){var h=[];this.targetNode.childNodes.forEach(function(i){h=h.concat(i._domManager.getDomElement())});return h},getDomElementAsNext:function(){if(this._domRef.length){return this._domRef[0]}else{var h=this.getNextManager(this);if(h){return h.element}else{return null}}},addManager:function(i,k){var h=this.targetNode.parentNode;if(h){if(k===null){k=this.getNextManager(this)}if(h instanceof g.Scene){h._layers.Dom._domManager.addManager(i,k)}else{h._domManager.addManager(i,k)}}var j=k?k.getDomElementAsNext():null;this._register(i.getDomElement(),j);this.setLayer(this.layer)},removeManager:function(h){var k;var j=this._domRef.indexOf(h.element);if(j!==-1){k=this._domRef[j];k.parentNode.removeChild(k);this._domRef.splice(j,1)}this.setLayer(this.layer)},setLayer:function(m){this.layer=m;var n=this.targetNode;var k;if(n.childNodes){for(var j=0,h=n.childNodes.length;j<h;j++){k=n.childNodes[j]._domManager;if(k){k.setLayer(m)}}}},render:function(o){var k=g.Matrix.instance;var h=k.stack;var n=this.targetNode;var l=[];k.makeTransformMatrix(n,l);k.multiply(h[h.length-1],l,l);k.multiply(o,l,o);n._matrix=o;var j=(typeof n._originX==="number")?n._originX:n.width/2||0;var i=(typeof n._originY==="number")?n._originY:n.height/2||0;var m=[j,i];k.multiplyVec(l,m,m);n._offsetX=m[0]-j;n._offsetY=m[1]-i;h.push(l)},remove:function(){this._domRef=[];this.targetNode=null}});g.DomLayer=g.Class.create(g.Group,{initialize:function(){var h=g.Game.instance;g.Group.call(this);this.width=this._width=h.width;this.height=this._height=h.height;this._touchEventTarget=null;this._element=document.createElement("div");this._element.style.width=this.width+"px";this._element.style.height=this.height+"px";this._element.style.position="absolute";this._domManager=new g.DomManager(this,this._element);this._domManager.layer=this;var k=[g.Event.TOUCH_START,g.Event.TOUCH_MOVE,g.Event.TOUCH_END];k.forEach(function(l){this.addEventListener(l,function(m){if(this._scene){this._scene.dispatchEvent(m)}})},this);var i=function(p){var q=p.node;var n=p.next;var l=p.target;var o=n?n._domManager:null;g.DomLayer._attachDomManager(q,i,j);l._domManager.addManager(q._domManager,o);var m=new g.Event(g.Event.RENDER);l._domManager.layer._rendering(q,m)};var j=function(m){var n=m.node;var l=m.target;l._domManager.removeManager(n._domManager);g.DomLayer._detachDomManager(n,i,j)};this.addEventListener("childremoved",j);this.addEventListener("childadded",i)},_startRendering:function(){this.addEventListener("exitframe",this._onexitframe);this._onexitframe()},_stopRendering:function(){this.removeEventListener("exitframe",this._onexitframe);this._onexitframe()},_onexitframe:function(){this._rendering(this,new g.Event(g.Event.RENDER))},_rendering:function(k,m,n){var o;if(!n){n=[1,0,0,1,0,0]}k.dispatchEvent(m);k._domManager.render(n);if(k.childNodes){for(var j=0,h=k.childNodes.length;j<h;j++){o=k.childNodes[j];this._rendering(o,m,n.slice())}}if(k._domManager instanceof g.DomlessManager){g.Matrix.instance.stack.pop()}k._dirty=false},_determineEventTarget:function(){if(this._touchEventTarget){if(this._touchEventTarget!==this){return this._touchEventTarget}}return null}});g.DomLayer._attachDomManager=function(n,m,k){var o;if(!n._domManager){n.addEventListener("childadded",m);n.addEventListener("childremoved",k);if(n instanceof g.Group){n._domManager=new g.DomlessManager(n)}else{if(n._element){n._domManager=new g.DomManager(n,n._element)}else{n._domManager=new g.DomManager(n,"div")}}}if(n.childNodes){for(var j=0,h=n.childNodes.length;j<h;j++){o=n.childNodes[j];g.DomLayer._attachDomManager(o,m,k);n._domManager.addManager(o._domManager,null)}}};g.DomLayer._detachDomManager=function(n,m,k){var o;n.removeEventListener("childadded",m);n.removeEventListener("childremoved",k);if(n.childNodes){for(var j=0,h=n.childNodes.length;j<h;j++){o=n.childNodes[j];n._domManager.removeManager(o._domManager,null);g.DomLayer._detachDomManager(o,m,k)}}n._domManager.remove();delete n._domManager};g.CanvasLayer=g.Class.create(g.Group,{initialize:function(){var h=g.Game.instance;g.Group.call(this);this._cvsCache={matrix:[1,0,0,1,0,0],detectColor:"#000000"};this._cvsCache.layer=this;this.width=h.width;this.height=h.height;this._element=document.createElement("canvas");this._element.width=h.width;this._element.height=h.height;this._element.style.position="absolute";this._detect=document.createElement("canvas");this._detect.width=h.width;this._detect.height=h.height;this._detect.style.position="absolute";this._lastDetected=0;this.context=this._element.getContext("2d");this._dctx=this._detect.getContext("2d");this._colorManager=new g.DetectColorManager(16,256);var k=[g.Event.TOUCH_START,g.Event.TOUCH_MOVE,g.Event.TOUCH_END];k.forEach(function(l){this.addEventListener(l,function(m){if(this._scene){this._scene.dispatchEvent(m)}})},this);var i=function(o){var p=o.node;var l=o.target;var m;if(l instanceof g.CanvasLayer){m=l._scene._layers.Canvas}else{m=l.scene._layers.Canvas}g.CanvasLayer._attachCache(p,m,i,j);var n=new g.Event(g.Event.RENDER);if(l._dirty){l._updateCoordinate()}g.Matrix.instance.stack.push(l._matrix);m._rendering(p,n);g.Matrix.instance.stack.pop(l._matrix)};var j=function(n){var o=n.node;var l=n.target;var m;if(l instanceof g.CanvasLayer){m=l._scene._layers.Canvas}else{m=l.scene._layers.Canvas}g.CanvasLayer._detachCache(o,m,i,j)};this.addEventListener("childremoved",j);this.addEventListener("childadded",i)},_startRendering:function(){this.addEventListener("exitframe",this._onexitframe);this._onexitframe(new g.Event(g.Event.RENDER))},_stopRendering:function(){this.removeEventListener("render",this._onexitframe);this._onexitframe(new g.Event(g.Event.RENDER))},_onexitframe:function(){var i=g.Game.instance;var h=this.context;h.clearRect(0,0,i.width,i.height);var j=new g.Event(g.Event.RENDER);this._rendering(this,j)},_rendering:function(j,n){var q=g.Game.instance;var p=g.Matrix.instance;var o=p.stack;var r=this.context;var h;r.save();j.dispatchEvent(n);if(j.compositeOperation){r.globalCompositeOperation=j.compositeOperation}else{r.globalCompositeOperation="source-over"}r.globalAlpha=(typeof j._opacity==="number")?j._opacity:1;this._transform(j,r);if(typeof j._visible==="undefined"||j._visible){if(j._backgroundColor){r.fillStyle=j._backgroundColor;r.fillRect(0,0,j._width,j._height)}if(j.cvsRender){j.cvsRender(r)}if(q._debug){if(j instanceof g.Label||j instanceof g.Sprite){r.strokeStyle="#ff0000"}else{r.strokeStyle="#0000ff"}r.strokeRect(0,0,j._width,j._height)}if(j._clipping){r.clip()}}if(j.childNodes){for(var m=0,k=j.childNodes.length;m<k;m++){h=j.childNodes[m];this._rendering(h,n)}}r.restore();g.Matrix.instance.stack.pop()},_detectrendering:function(m){var j=this._dctx;var n;j.save();this._transform(m,j);j.fillStyle=m._cvsCache.detectColor;if(m._touchEnabled){if(m.detectRender){m.detectRender(j)}else{j.fillRect(0,0,m.width,m.height)}}if(m._clipping){j.clip()}if(m.childNodes){for(var k=0,h=m.childNodes.length;k<h;k++){n=m.childNodes[k];this._detectrendering(n)}}j.restore();g.Matrix.instance.stack.pop()},_transform:function(o,j){var m=g.Matrix.instance;var h=m.stack;var l;if(o._dirty){m.makeTransformMatrix(o,o._cvsCache.matrix);l=[];m.multiply(h[h.length-1],o._cvsCache.matrix,l);o._matrix=l}else{l=o._matrix}h.push(l);j.setTransform.apply(j,l);var k=(typeof o._originX==="number")?o._originX:o._width/2||0;var i=(typeof o._originY==="number")?o._originY:o._height/2||0;var n=[k,i];m.multiplyVec(l,n,n);o._offsetX=n[0]-k;o._offsetY=n[1]-i;o._dirty=false},_determineEventTarget:function(h){return this._getEntityByPosition(h.x,h.y)},_getEntityByPosition:function(h,l){var k=g.Game.instance;var i=this._dctx;if(this._lastDetected<k.frame){i.clearRect(0,0,this.width,this.height);this._detectrendering(this);this._lastDetected=k.frame}var j=i.getImageData(h,l,1,1).data;return this._colorManager.getSpriteByColor(j)}});g.CanvasLayer._attachCache=function(o,m,n,k){var p;if(!o._cvsCache){o._cvsCache={};o._cvsCache.matrix=[1,0,0,1,0,0];o._cvsCache.detectColor="rgba("+m._colorManager.attachDetectColor(o)+")";o.addEventListener("childadded",n);o.addEventListener("childremoved",k)}if(o.childNodes){for(var j=0,h=o.childNodes.length;j<h;j++){p=o.childNodes[j];g.CanvasLayer._attachCache(p,m,n,k)}}};g.CanvasLayer._detachCache=function(o,m,n,k){var p;if(o._cvsCache){m._colorManager.detachDetectColor(o);o.removeEventListener("childadded",n);o.removeEventListener("childremoved",k);delete o._cvsCache}if(o.childNodes){for(var j=0,h=o.childNodes.length;j<h;j++){p=o.childNodes[j];g.CanvasLayer._detachCache(p,m,n,k)}}};g.Scene=g.Class.create(g.Group,{initialize:function(){var h=g.Game.instance;g.Group.call(this);this.width=h.width;this.height=h.height;this.scene=this;this._backgroundColor=null;this._element=document.createElement("div");this._element.style.width=this.width+"px";this._element.style.height=this.height+"px";this._element.style.position="absolute";this._element.style.overflow="hidden";this._element.style[g.ENV.VENDOR_PREFIX+"TransformOrigin"]="0 0";this._element.style[g.ENV.VENDOR_PREFIX+"Transform"]="scale("+g.Game.instance.scale+")";this._layers={};this._layerPriority=[];this.addLayer("Canvas");this.addLayer("Dom");this.addEventListener(g.Event.CHILD_ADDED,this._onchildadded);this.addEventListener(g.Event.CHILD_REMOVED,this._onchildremoved);this.addEventListener(g.Event.ENTER,this._onenter);this.addEventListener(g.Event.EXIT,this._onexit);var i=this;this._dispatchExitframe=function(){var j;for(var k in i._layers){j=i._layers[k];j.dispatchEvent(new g.Event(g.Event.EXIT_FRAME))}}},x:{get:function(){return this._x},set:function(h){this._x=h;for(var i in this._layers){this._layers[i].x=h}}},y:{get:function(){return this._y},set:function(i){this._y=i;for(var h in this._layers){this._layers[h].y=i}}},rotation:{get:function(){return this._rotation},set:function(h){this._rotation=h;for(var i in this._layers){this._layers[i].rotation=h}}},scaleX:{get:function(){return this._scaleX},set:function(h){this._scaleX=h;for(var i in this._layers){this._layers[i].scaleX=h}}},scaleY:{get:function(){return this._scaleY},set:function(h){this._scaleY=h;for(var i in this._layers){this._layers[i].scaleY=h}}},backgroundColor:{get:function(){return this._backgroundColor},set:function(h){this._backgroundColor=this._element.style.backgroundColor=h}},addLayer:function(m,l){var h=g.Game.instance;if(this._layers[m]){return}var k=new g[m+"Layer"]();if(h.currentScene===this){k._startRendering()}this._layers[m]=k;var j=k._element;if(typeof l==="number"){var n=this._element.childNodes.indexOf(l);this._element.insertBefore(j,n);this._layerPriority.splice(l,0,m)}else{this._element.appendChild(j);this._layerPriority.push(m)}k._scene=this},_determineEventTarget:function(l){var j,k;for(var h=this._layerPriority.length-1;h>=0;h--){j=this._layers[this._layerPriority[h]];k=j._determineEventTarget(l);if(k){break}}if(!k){k=this}return k},_onchildadded:function(i){var j=i.node;var h=i.next;if(j._element){this._layers.Dom.insertBefore(j,h);j._layer=this._layers.Dom}else{this._layers.Canvas.insertBefore(j,h);j._layer=this._layers.Canvas}j.parentNode=this},_onchildremoved:function(h){var i=h.node;i._layer.removeChild(i);i._layer=null},_onenter:function(){for(var h in this._layers){this._layers[h]._startRendering()}g.Game.instance.addEventListener("exitframe",this._dispatchExitframe)},_onexit:function(){for(var h in this._layers){this._layers[h]._stopRendering()}g.Game.instance.removeEventListener("exitframe",this._dispatchExitframe)}});g.Surface=g.Class.create(g.EventTarget,{initialize:function(k,h){g.EventTarget.call(this);var i=g.Core.instance;this.width=k;this.height=h;this.context=null;var l="enchant-surface"+i._surfaceID++;if(document.getCSSCanvasContext){this.context=document.getCSSCanvasContext("2d",l,k,h);this._element=this.context.canvas;this._css="-webkit-canvas("+l+")";var j=this.context}else{if(document.mozSetImageElement){this._element=document.createElement("canvas");this._element.width=k;this._element.height=h;this._css="-moz-element(#"+l+")";this.context=this._element.getContext("2d");document.mozSetImageElement(l,this._element)}else{this._element=document.createElement("canvas");this._element.width=k;this._element.height=h;this._element.style.position="absolute";this.context=this._element.getContext("2d");g.ENV.CANVAS_DRAWING_METHODS.forEach(function(m){var n=this.context[m];this.context[m]=function(){n.apply(this,arguments);this._dirty=true}},this)}}},getPixel:function(h,i){return this.context.getImageData(h,i,1,1).data},setPixel:function(i,n,m,l,h,j){var k=this.context.createImageData(1,1);k.data[0]=m;k.data[1]=l;k.data[2]=h;k.data[3]=j;this.context.putImageData(k,i,n)},clear:function(){this.context.clearRect(0,0,this.width,this.height)},draw:function(i){i=i._element;if(arguments.length===1){this.context.drawImage(i,0,0)}else{var h=arguments;h[0]=i;this.context.drawImage.apply(this.context,h)}},clone:function(){var h=new g.Surface(this.width,this.height);h.draw(this);return h},toDataURL:function(){var h=this._element.src;if(h){if(h.slice(0,5)==="data:"){return h}else{return this.clone().toDataURL()}}else{return this._element.toDataURL()}}});g.Surface.load=function(j,k){var i=new Image();var h=Object.create(g.Surface.prototype,{context:{value:null},_css:{value:"url("+j+")"},_element:{value:i}});g.EventTarget.call(h);i.src=j;i.onerror=function(){throw new Error("Cannot load an asset: "+i.src)};i.onload=function(){h.width=i.width;h.height=i.height;h.dispatchEvent(new g.Event("load"))};return h};if(d.webkitAudioContext&&g.ENV.USE_WEBAUDIO){g.Game._loadFuncs.mp3=g.Game._loadFuncs.aac=g.Game._loadFuncs.m4a=g.Game._loadFuncs.wav=g.Game._loadFuncs.ogg=function(i,j,h){this.assets[i]=g.Sound.load(i,"audio/"+h,j)};g.Sound=g.Class.create(g.EventTarget,{initialize:function(){var h=g.Sound.audioContext;g.EventTarget.call(this);this.src=h.createBufferSource();this.buffer=null;this._volume=1;this._currentTime=0;this._state=0;this.connectTarget=g.Sound.destination},play:function(i){var h=g.Sound.audioContext;if(this._state===2){this.src.connect(this.connectTarget)}else{if(this._state===1&&!i){this.src.disconnect(this.connectTarget)}this.src=h.createBufferSource();this.src.buffer=this.buffer;this.src.gain.value=this._volume;this.src.connect(this.connectTarget);this.src.noteOn(0)}this._state=1},pause:function(){var h=g.Sound.audioContext;this.src.disconnect(this.connectTarget);this._state=2},stop:function(){this.src.noteOff(0);this._state=0},clone:function(){var h=new g.Sound();h.buffer=this.buffer;return h},dulation:{get:function(){if(this.buffer){return this.buffer.dulation}else{return 0}}},volume:{get:function(){return this._volume},set:function(h){h=Math.max(0,Math.min(1,h));this._volume=h;if(this.src){this.src.gain.value=h}}},currentTime:{get:function(){d.console.log("currentTime is not allowed");return this._currentTime},set:function(h){d.console.log("currentTime is not allowed");this._currentTime=h}}});g.Sound.load=function(m,h,n){var i=g.Sound.audioContext;var l=new XMLHttpRequest();var j=new g.Sound();var k="audio/"+g.Game.findExt(m);l.responseType="arraybuffer";l.open("GET",m,true);l.onload=function(){i.decodeAudioData(l.response,function(o){j.buffer=o;n()},function(o){d.console.log(o)})};l.send(null);return j};g.Sound.audioContext=new webkitAudioContext();g.Sound.destination=g.Sound.audioContext.destination}else{g.Sound=g.Class.create(g.EventTarget,{initialize:function(){g.EventTarget.call(this);this.duration=0;throw new Error("Illegal Constructor")},play:function(){if(this._element){this._element.play()}},pause:function(){if(this._element){this._element.pause()}},stop:function(){this.pause();this.currentTime=0},clone:function(){var h;if(this._element instanceof Audio){h=Object.create(g.Sound.prototype,{_element:{value:this._element.cloneNode(false)},duration:{value:this.duration}})}else{if(g.ENV.USE_FLASH_SOUND){return this}else{h=Object.create(g.Sound.prototype)}}g.EventTarget.call(h);return h},currentTime:{get:function(){return this._element?this._element.currentTime:0},set:function(h){if(this._element){this._element.currentTime=h}}},volume:{get:function(){return this._element?this._element.volume:1},set:function(h){if(this._element){this._element.volume=h}}}});g.Sound.load=function(l,i){if(i==null){var h=g.Game.findExt(l);if(h){i="audio/"+h}else{i=""}}i=i.replace("mp3","mpeg").replace("m4a","mp4");var k=Object.create(g.Sound.prototype);g.EventTarget.call(k);var j=new Audio();if(!g.ENV.SOUND_ENABLED_ON_MOBILE_SAFARI&&g.ENV.VENDOR_PREFIX==="webkit"&&g.ENV.TOUCH_ENABLED){d.setTimeout(function(){k.dispatchEvent(new g.Event("load"))},0)}else{if(!g.ENV.USE_FLASH_SOUND&&j.canPlayType(i)){j.src=l;j.load();j.autoplay=false;j.onerror=function(){throw new Error("Cannot load an asset: "+j.src)};j.addEventListener("canplaythrough",function(){k.duration=j.duration;k.dispatchEvent(new g.Event("load"))},false);k._element=j}else{if(i==="audio/mpeg"){var n=document.createElement("embed");var m="enchant-audio"+g.Game.instance._soundID++;n.width=n.height=1;n.name=m;n.src="sound.swf?id="+m+"&src="+l;n.allowscriptaccess="always";n.style.position="absolute";n.style.left="-1px";k.addEventListener("load",function(){Object.defineProperties(n,{currentTime:{get:function(){return n.getCurrentTime()},set:function(o){n.setCurrentTime(o)}},volume:{get:function(){return n.getVolume()},set:function(o){n.setVolume(o)}}});k._element=n;k.duration=n.getDuration()});g.Game.instance._element.appendChild(n);g.Sound[m]=k}else{d.setTimeout(function(){k.dispatchEvent(new g.Event("load"))},0)}}}return k}}g.Easing={LINEAR:function(i,h,k,j){return k*i/j+h},SWING:function(i,h,k,j){return k*(0.5-Math.cos(((i/j)*Math.PI))/2)+h},QUAD_EASEIN:function(i,h,k,j){return k*(i/=j)*i+h},QUAD_EASEOUT:function(i,h,k,j){return -k*(i/=j)*(i-2)+h},QUAD_EASEINOUT:function(i,h,k,j){if((i/=j/2)<1){return k/2*i*i+h}return -k/2*((--i)*(i-2)-1)+h},CUBIC_EASEIN:function(i,h,k,j){return k*(i/=j)*i*i+h},CUBIC_EASEOUT:function(i,h,k,j){return k*((i=i/j-1)*i*i+1)+h},CUBIC_EASEINOUT:function(i,h,k,j){if((i/=j/2)<1){return k/2*i*i*i+h}return k/2*((i-=2)*i*i+2)+h},QUART_EASEIN:function(i,h,k,j){return k*(i/=j)*i*i*i+h},QUART_EASEOUT:function(i,h,k,j){return -k*((i=i/j-1)*i*i*i-1)+h},QUART_EASEINOUT:function(i,h,k,j){if((i/=j/2)<1){return k/2*i*i*i*i+h}return -k/2*((i-=2)*i*i*i-2)+h},QUINT_EASEIN:function(i,h,k,j){return k*(i/=j)*i*i*i*i+h},QUINT_EASEOUT:function(i,h,k,j){return k*((i=i/j-1)*i*i*i*i+1)+h},QUINT_EASEINOUT:function(i,h,k,j){if((i/=j/2)<1){return k/2*i*i*i*i*i+h}return k/2*((i-=2)*i*i*i*i+2)+h},SIN_EASEIN:function(i,h,k,j){return -k*Math.cos(i/j*(Math.PI/2))+k+h},SIN_EASEOUT:function(i,h,k,j){return k*Math.sin(i/j*(Math.PI/2))+h},SIN_EASEINOUT:function(i,h,k,j){return -k/2*(Math.cos(Math.PI*i/j)-1)+h},CIRC_EASEIN:function(i,h,k,j){return -k*(Math.sqrt(1-(i/=j)*i)-1)+h},CIRC_EASEOUT:function(i,h,k,j){return k*Math.sqrt(1-(i=i/j-1)*i)+h},CIRC_EASEINOUT:function(i,h,k,j){if((i/=j/2)<1){return -k/2*(Math.sqrt(1-i*i)-1)+h}return k/2*(Math.sqrt(1-(i-=2)*i)+1)+h},ELASTIC_EASEIN:function(j,h,n,m,i,l){if(j===0){return h}if((j/=m)===1){return h+n}if(!l){l=m*0.3}var k;if(!i||i<Math.abs(n)){i=n;k=l/4}else{k=l/(2*Math.PI)*Math.asin(n/i)}return -(i*Math.pow(2,10*(j-=1))*Math.sin((j*m-k)*(2*Math.PI)/l))+h},ELASTIC_EASEOUT:function(j,h,n,m,i,l){if(j===0){return h}if((j/=m)===1){return h+n}if(!l){l=m*0.3}var k;if(!i||i<Math.abs(n)){i=n;k=l/4}else{k=l/(2*Math.PI)*Math.asin(n/i)}return(i*Math.pow(2,-10*j)*Math.sin((j*m-k)*(2*Math.PI)/l)+n+h)},ELASTIC_EASEINOUT:function(j,h,n,m,i,l){if(j===0){return h}if((j/=m/2)===2){return h+n}if(!l){l=m*(0.3*1.5)}var k;if(!i||i<Math.abs(n)){i=n;k=l/4}else{k=l/(2*Math.PI)*Math.asin(n/i)}if(j<1){return -0.5*(i*Math.pow(2,10*(j-=1))*Math.sin((j*m-k)*(2*Math.PI)/l))+h}return i*Math.pow(2,-10*(j-=1))*Math.sin((j*m-k)*(2*Math.PI)/l)*0.5+n+h},BOUNCE_EASEOUT:function(i,h,k,j){if((i/=j)<(1/2.75)){return k*(7.5625*i*i)+h}else{if(i<(2/2.75)){return k*(7.5625*(i-=(1.5/2.75))*i+0.75)+h}else{if(i<(2.5/2.75)){return k*(7.5625*(i-=(2.25/2.75))*i+0.9375)+h}else{return k*(7.5625*(i-=(2.625/2.75))*i+0.984375)+h}}}},BOUNCE_EASEIN:function(i,h,k,j){return k-g.Easing.BOUNCE_EASEOUT(j-i,0,k,j)+h},BOUNCE_EASEINOUT:function(i,h,k,j){if(i<j/2){return g.Easing.BOUNCE_EASEIN(i*2,0,k,j)*0.5+h}else{return g.Easing.BOUNCE_EASEOUT(i*2-j,0,k,j)*0.5+k*0.5+h}},BACK_EASEIN:function(i,h,l,k,j){if(j===f){j=1.70158}return l*(i/=k)*i*((j+1)*i-j)+h},BACK_EASEOUT:function(i,h,l,k,j){if(j===f){j=1.70158}return l*((i=i/k-1)*i*((j+1)*i+j)+1)+h},BACK_EASEINOUT:function(i,h,l,k,j){if(j===f){j=1.70158}if((i/=k/2)<1){return l/2*(i*i*(((j*=(1.525))+1)*i-j))+h}return l/2*((i-=2)*i*(((j*=(1.525))+1)*i+j)+2)+h},EXPO_EASEIN:function(i,h,k,j){return(i===0)?h:k*Math.pow(2,10*(i/j-1))+h},EXPO_EASEOUT:function(i,h,k,j){return(i===j)?h+k:k*(-Math.pow(2,-10*i/j)+1)+h},EXPO_EASEINOUT:function(i,h,k,j){if(i===0){return h}if(i===j){return h+k}if((i/=j/2)<1){return k/2*Math.pow(2,10*(i-1))+h}return k/2*(-Math.pow(2,-10*--i)+2)+h}};g.ActionEventTarget=g.Class.create(g.EventTarget,{initialize:function(){g.EventTarget.apply(this,arguments)},dispatchEvent:function(m){var l;if(this.node){l=this.node;m.target=l;m.localX=m.x-l._offsetX;m.localY=m.y-l._offsetY}else{this.node=null}if(this["on"+m.type]!=null){this["on"+m.type].call(l,m)}var k=this._listeners[m.type];if(k!=null){k=k.slice();for(var j=0,h=k.length;j<h;j++){k[j].call(l,m)}}}});g.Timeline=g.Class.create(g.EventTarget,{initialize:function(h){g.EventTarget.call(this);this.node=h;this.queue=[];this.paused=false;this.looped=false;this.isFrameBased=true;this._parallel=null;this._activated=false;this.addEventListener(g.Event.ENTER_FRAME,this.tick)},_deactivateTimeline:function(){if(this._activated){this._activated=false;this.node.removeEventListener("enterframe",this._nodeEventListener)}},_activateTimeline:function(){if(!this._activated&&!this.paused){this.node.addEventListener("enterframe",this._nodeEventListener);this._activated=true}},setFrameBased:function(){this.isFrameBased=true},setTimeBased:function(){this.isFrameBased=false},next:function(h){var k,j=this.queue.shift();k=new g.Event("actionend");k.timeline=this;j.dispatchEvent(k);if(this.queue.length===0){this._activated=false;this.node.removeEventListener("enterframe",this._nodeEventListener);return}if(this.looped){k=new g.Event("removedfromtimeline");k.timeline=this;j.dispatchEvent(k);j.frame=0;this.add(j)}else{k=new g.Event("removedfromtimeline");k.timeline=this;j.dispatchEvent(k)}if(h>0||(this.queue[0]&&this.queue[0].time===0)){var i=new g.Event("enterframe");i.elapsed=h;this.dispatchEvent(i)}},tick:function(h){if(this.paused){return}if(this.queue.length>0){var j=this.queue[0];if(j.frame===0){var i;i=new g.Event("actionstart");i.timeline=this;j.dispatchEvent(i)}var k=new g.Event("actiontick");k.timeline=this;if(this.isFrameBased){k.elapsed=1}else{k.elapsed=h.elapsed}j.dispatchEvent(k)}},add:function(i){if(!this._activated){var h=this;this._nodeEventListener=function(k){h.dispatchEvent(k)};this.node.addEventListener("enterframe",this._nodeEventListener);this._activated=true}if(this._parallel){this._parallel.actions.push(i);this._parallel=null}else{this.queue.push(i)}i.frame=0;var j=new g.Event("addedtotimeline");j.timeline=this;i.dispatchEvent(j);j=new g.Event("actionadded");j.action=i;this.dispatchEvent(j);return this},action:function(h){return this.add(new g.Action(h))},tween:function(h){return this.add(new g.Tween(h))},clear:function(){var k=new g.Event("removedfromtimeline");k.timeline=this;for(var j=0,h=this.queue.length;j<h;j++){this.queue[j].dispatchEvent(k)}this.queue=[];this._deactivateTimeline();return this},skip:function(i){var h=new g.Event("enterframe");if(this.isFrameBased){h.elapsed=1}else{h.elapsed=i;i=1}while(i--){this.dispatchEvent(h)}return this},pause:function(){if(!this.paused){this.paused=true;this._deactivateTimeline()}return this},resume:function(){if(this.paused){this.paused=false;this._activateTimeline()}return this},loop:function(){this.looped=true;return this},unloop:function(){this.looped=false;return this},delay:function(h){this.add(new g.Action({time:h}));return this},wait:function(h){return this},then:function(i){var h=this;this.add(new g.Action({onactiontick:function(j){i.call(h.node)},time:0}));return this},exec:function(h){this.then(h)},cue:function(h){var j=0;for(var i in h){if(h.hasOwnProperty(i)){this.delay(i-j);this.then(h[i]);j=i}}},repeat:function(h,i){this.add(new g.Action({onactiontick:function(j){h.call(this)},time:i}));return this},and:function(){var i=this.queue.pop();if(i instanceof g.ParallelAction){this._parallel=i;this.queue.push(i)}else{var h=new g.ParallelAction();h.actions.push(i);this.queue.push(h);this._parallel=h}return this},or:function(){return this},doAll:function(h){return this},waitAll:function(){return this},waitUntil:function(i){var h=this;this.add(new g.Action({onactionstart:i,onactiontick:function(j){if(i.call(this)){h.next()}}}));return this},fadeTo:function(h,i,j){this.tween({opacity:h,time:i,easing:j});return this},fadeIn:function(h,i){return this.fadeTo(1,h,i)},fadeOut:function(h,i){return this.fadeTo(0,h,i)},moveTo:function(h,k,i,j){return this.tween({x:h,y:k,time:i,easing:j})},moveX:function(h,i,j){return this.tween({x:h,time:i,easing:j})},moveY:function(j,h,i){return this.tween({y:j,time:h,easing:i})},moveBy:function(h,k,i,j){return this.tween({x:function(){return this.x+h},y:function(){return this.y+k},time:i,easing:j})},hide:function(){return this.then(function(){this.opacity=0})},show:function(){return this.then(function(){this.opacity=1})},removeFromScene:function(){return this.then(function(){this.scene.removeChild(this)})},scaleTo:function(i,h,j){if(typeof j==="number"){return this.tween({scaleX:arguments[0],scaleY:arguments[1],time:arguments[2],easing:arguments[3]})}return this.tween({scaleX:i,scaleY:i,time:h,easing:j})},scaleBy:function(i,h,j){if(typeof j==="number"){return this.tween({scaleX:function(){return this.scaleX*arguments[0]},scaleY:function(){return this.scaleY*arguments[1]},time:arguments[2],easing:arguments[3]})}return this.tween({scaleX:function(){return this.scaleX*i},scaleY:function(){return this.scaleY*i},time:h,easing:j})},rotateTo:function(h,i,j){return this.tween({rotation:h,time:i,easing:j})},rotateBy:function(h,i,j){return this.tween({rotation:function(){return this.rotation+h},time:i,easing:j})}});g.Action=g.Class.create(g.ActionEventTarget,{initialize:function(j){g.ActionEventTarget.call(this);this.time=null;this.frame=0;for(var h in j){if(j.hasOwnProperty(h)){if(j[h]!=null){this[h]=j[h]}}}var i=this;this.timeline=null;this.node=null;this.addEventListener(g.Event.ADDED_TO_TIMELINE,function(k){i.timeline=k.timeline;i.node=k.timeline.node;i.frame=0});this.addEventListener(g.Event.REMOVED_FROM_TIMELINE,function(){i.timeline=null;i.node=null;i.frame=0});this.addEventListener(g.Event.ACTION_TICK,function(k){var l=i.time-(i.frame+k.elapsed);if(i.time!=null&&l<=0){i.frame=i.time;k.timeline.next(-l)}else{i.frame+=k.elapsed}})}});g.ParallelAction=g.Class.create(g.Action,{initialize:function(k){g.Action.call(this,k);var j=this.timeline;var i=this.node;this.actions=[];this.endedActions=[];var h=this;this.addEventListener(g.Event.ACTION_START,function(m){for(var n=0,l=h.actions.length;n<l;n++){h.actions[n].dispatchEvent(m)}});this.addEventListener(g.Event.ACTION_TICK,function(m){var n,l,o={next:function(q){var r=h.actions[n];h.actions.splice(n--,1);l=h.actions.length;h.endedActions.push(r);var s=new g.Event("actionend");s.timeline=this;r.dispatchEvent(s);s=new g.Event("removedfromtimeline");s.timeline=this;r.dispatchEvent(s)}};var p=new g.Event("actiontick");p.timeline=o;p.elapsed=m.elapsed;for(n=0,l=h.actions.length;n<l;n++){h.actions[n].dispatchEvent(p)}if(h.actions.length===0){m.timeline.next()}});this.addEventListener(g.Event.ADDED_TO_TIMELINE,function(m){for(var n=0,l=h.actions.length;n<l;n++){h.actions[n].dispatchEvent(m)}});this.addEventListener(g.Event.REMOVED_FROM_TIMELINE,function(){this.actions=this.endedActions;this.endedActions=[]})}});g.Tween=g.Class.create(g.Action,{initialize:function(k){var h={};var j={};g.Action.call(this,k);if(this.easing==null){this.easing=function(m,l,o,n){return o*m/n+l}}var i=this;this.addEventListener(g.Event.ACTION_START,function(){var l=["frame","time","callback","onactiontick","onactionstart","onactionend"];for(var n in k){if(k.hasOwnProperty(n)){var m;if(typeof k[n]==="function"){m=k[n].call(i.node)}else{m=k[n]}if(l.indexOf(n)===-1){h[n]=i.node[n];j[n]=m}}}});this.addEventListener(g.Event.ACTION_TICK,function(l){var m=i.time===0?1:i.easing(Math.min(i.time,i.frame+l.elapsed),0,1,i.time)-i.easing(i.frame,0,1,i.time);for(var n in j){if(j.hasOwnProperty(n)){if(typeof this[n]==="undefined"){continue}i.node[n]+=(j[n]-h[n])*m;if(Math.abs(i.node[n])<1e-7){i.node[n]=0}}}})}})}(window));