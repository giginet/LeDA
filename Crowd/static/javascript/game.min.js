(function(){var d,b,n,k,p,c,s,t,i,f,q,v,j,m,h,l,e,r,a,o={}.hasOwnProperty,u=function(z,x){for(var w in x){if(o.call(x,w)){z[w]=x[w]}}function y(){this.constructor=z}y.prototype=x.prototype;z.prototype=new y();z.__super__=x.prototype;return z},g=[].indexOf||function(y){for(var x=0,w=this.length;x<w;x++){if(x in this&&this[x]===y){return x}}return -1};a=(function(){function w(z,A){if(z==null){z=0}if(A==null){A=0}this.set(z,A)}w.prototype.set=function(z,A){if(z==null){z=0}if(A==null){A=0}this.x=z;this.y=A;return this};w.prototype.add=function(x){this.x+=x.x;this.y+=x.y;return this};w.prototype.sub=function(x){this.x-=x.x;this.y-=x.y;return this};w.prototype.scale=function(x){this.x*=x;this.y*=x;return this};w.prototype.div=function(x){this.x/=x;this.y/=x;return this};w.prototype.product=function(x){return this.x*x.x+this.y*x.y};w.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};w.prototype.resize=function(x){if(this.length()){this.scale(x/this.length())}return this};w.prototype.normalize=function(){return this.resize(1)};w.prototype.angle=function(){return(180*Math.atan2(this.y,this.x))/Math.PI};w.prototype.rotate=function(C){var A,B,z,D;A=(C*Math.PI)/180;B=this.length();z=this.x;D=this.y;this.x=Math.sin(A)*D+Math.cos(A)*z;this.y=Math.cos(A)*D-Math.sin(A)*z;return this.resize(B)};w.prototype.clone=function(){return new w(this.x,this.y)};w.prototype.reverse=function(){this.x*=-1;this.y*=-1;return this};w.prototype.max=function(x){if(this.length()<=x){return this}return this.resize(x)};w.prototype.min=function(x){if(this.length()>=x){return this}return this.resize(x)};w.prototype.isZero=function(){return this.x===0&&this.y===0};return w})();Array.prototype._index=function(w){var x;if(w<0){x=this.length;return x+w}return w};Array.prototype.at=function(w){return this[this._index(w)]};Array.prototype.map=function(w){var y,x;return([].splice.apply(this,[0,this.length-0].concat(x=(function(){var B,A,z;z=[];for(B=0,A=this.length;B<A;B++){y=this[B];z.push(w(y))}return z}).call(this))),x)};Array.prototype.clone=function(){return this.dup()};Array.prototype.dup=function(){return this.slice(0,this.length)};Array.prototype.each=function(x){var w,z,y;for(w=z=0,y=this.length;0<=y?z<y:z>y;w=0<=y?++z:--z){x(this[w],w)}return this};Array.prototype.deleteAt=function(w){w=this._index(w);if(w>=this.length){return void 0}return this.splice(w,1)};Array.prototype.deleteIf=function(x){var w;return this.replace((function(){var A,z,y;y=[];for(w=A=0,z=this.length;0<=z?A<z:A>z;w=0<=z?++A:--A){if(!x(this[w],w)){y.push(this[w])}}return y}).call(this))};Array.prototype.reject=function(w){var x;x=this.length;this.deleteIf(w);if(x===this.length){return void 0}return this};Array.prototype.isEmpty=function(){return this.length===0};Array.prototype.isEql=function(w,A){var x,z,y;if(A==null){A=function(C,B){return C===B}}if(this.length!==w.length){return false}for(x=z=0,y=this.length;0<=y?z<y:z>y;x=0<=y?++z:--z){if(!A(this[x],w[x])){return false}}return true};Array.prototype.fill=function(z,A,w){var x,y;if(A==null){A=0}if(w==null){w=this.length-1}A=this._index(A);w=this._index(w);[].splice.apply(this,[A,w-A+1].concat(y=(function(){var C,B;B=[];for(x=C=A;A<=w?C<=w:C>=w;x=A<=w?++C:--C){B.push(z)}return B})())),y;return this};Array.prototype.first=function(){return this[0]};Array.prototype.last=function(){var w;w=this._index(-1);return this[w]};Array.prototype.uniq=function(A){var z,y,x,w;if(A==null){A=function(C,B){return C===B}}z=[];for(x=0,w=this.length;x<w;x++){y=this[x];if(!z.isInclude(y,A)){z.push(y)}}return this.replace(z)};Array.prototype.index=function(z,A){var w,y,x;if(A==null){A=function(C,B){return C===B}}for(w=y=0,x=this.length;0<=x?y<x:y>x;w=0<=x?++y:--y){if(A(this[w],z)){return w}}return void 0};Array.prototype.indexes=function(){var y,z,x,w;w=[];for(z=0,x=arguments.length;z<x;z++){y=arguments[z];w.push(this.at(y))}return w};Array.prototype.rindex=function(z,A){var w,y,x;if(A==null){A=function(C,B){return C===B}}for(w=y=x=this.length;x<=0?y<0:y>0;w=x<=0?++y:--y){if(A(this[w],z)){return w}}return void 0};Array.prototype.flatten=function(){return this.replace(this.reduce(function(x,w){return x.concat(w instanceof Array?w.flatten():w)},[]))};Array.prototype.transpose=function(){var D,C,B,A,z,G,F,E;A=this.isEmpty()?0:this.length;D=this.first() instanceof Array?this.first().length:0;if(!A||!D){return this}B=(function(){var x,w;w=[];for(C=x=0;0<=D?x<D:x>D;C=0<=D?++x:--x){w.push([])}return w})();for(z=F=0;0<=A?F<A:F>A;z=0<=A?++F:--F){for(G=E=0;0<=D?E<D:E>D;G=0<=D?++E:--E){B[G][z]=this[z][G]}}return this.replace(B)};Array.prototype.compact=function(){return this.deleteIf(function(w){return w===void 0})};Array.prototype.isInclude=function(z,A){var x,y,w;if(A==null){A=function(C,B){return C===B}}for(y=0,w=this.length;y<w;y++){x=this[y];if(A(x,z)){return true}}return false};Array.prototype.size=function(){return this.length};Array.prototype.swap=function(x,w){var y;x=this._index(x);w=this._index(w);y=this[x];this[x]=this[w];this[w]=y;return this};Array.prototype.shuffle=function(){var w,y,x;for(w=y=0,x=this.length;0<=x?y<x:y>x;w=0<=x?++y:--y){this.swap(w,Math.floor(Math.random()*this.length))}return this};Array.prototype.choice=function(){return this[Math.floor(Math.random()*this.length)]};Array.prototype.count=function(A,B){var w,x,z,y;if(B==null){B=function(D,C){return D===C}}x=0;for(w=z=0,y=this.length;0<=y?z<y:z>y;w=0<=y?++z:--z){if(B(this[w],A)){++x}}return x};Array.prototype.replace=function(w){var y,z,x;this.clear();for(z=0,x=w.length;z<x;z++){y=w[z];this.push(y)}return this};Array.prototype.nitems=function(){return this.clone().compact().size()};Array.prototype.insert=function(){var y,z,x,w,B,A;y=Array.prototype.slice.call(arguments,0,arguments.length);if(y.size()<=1){return this}x=this._index(y[0]);w=y.slice(1,this.length);for(z=B=0,A=w.length;0<=A?B<A:B>A;z=0<=A?++B:--B){this.splice(x+z,0,w[z])}return this};Array.prototype.clear=function(){var w;w=[];while(!this.isEmpty()){w.push(this.deleteAt(0))}return w};Array.prototype.max=function(x){var w;if(x==null){x=function(z,y){if(z===y){return 0}if(z<y){return -1}else{return 1}}}w=this.first();this.reduce(function(z,y){if(x(w,y)<0){return w=y}});return w};Array.prototype.min=function(x){var w;if(x==null){x=function(z,y){if(z===y){return 0}if(z<y){return -1}else{return 1}}}w=this.first();this.reduce(function(z,y){if(x(w,y)>=0){return w=y}});return w};r=(function(){function w(x,z,B,A,y){if(z==null){z=false}if(B==null){B=0}if(A==null){A=false}if(y==null){y=void 0}this.set(x);this._time=B;this._active=A;this._onComplete=y;this._onUpdate=void 0;this._repeat=z}w.prototype.set=function(x){if(x==null){x=0}this._max=x;return this};w.prototype.play=function(){this._active=true;return this};w.prototype.stop=function(){this._active=false;this._time=0;return this};w.prototype.pause=function(){this._active=false;return this};w.prototype.reset=function(){this._time=0;return this};w.prototype.tick=function(){if(this._time<this._max&&this._active){++this._time;if(this._onUpdate!=null){this._onUpdate(this)}if(this._time===this._max){if(this._onComplete!=null){this._onComplete(this)}if(this._repeat){this._time=0}}}return this};w.prototype.now=function(){return this._time};w.prototype.max=function(){return this._max};w.prototype.setNow=function(x){this._time=x;return this};w.prototype.setOnComplete=function(x){this._onComplete=x;return this};w.prototype.setOnUpdate=function(x){return this._onUpdate=x};w.prototype.setRepeat=function(x){this._repeat=x;return this};w.prototype.isActive=function(){return this._active};w.prototype.isOver=function(){return this._time>=this._max};return w})();p=(function(){function w(){}w._sounds=[];w.root="";w.load=function(){var B,x,A,z,y;x=Array.prototype.slice.call(arguments);y=[];for(A=0,z=x.length;A<z;A++){B=x[A];y.push(w._loadSound(B))}return y};w.play=function(x){if(!(w._sounds[x]!=null)){w._loadSound(x)}w.stop(x);return w._sounds[x].play()};w.pause=function(x){if(x!=null){return w._sounds[x].pause()}};w.stop=function(x){if(x!=null){return w._sounds[x].stop()}};w._loadSound=function(y,x){if(!(w._sounds[y]!=null)){if(x!=null){return w._sounds[y]=Sound.load(""+w.root+y,x)}else{return w._sounds[y]=Sound.load(""+w.root+y)}}};return w})();enchant();s=(function(x){u(w,x);w.prototype.config={WIDTH:640,HEIGHT:480,FPS:30,FONT:"Helvetica",IMAGE_PATH:"image/",IMAGES:["kawaz.png","characters/player.png","chips/grass/ground.png","chips/grass/goal.png","chips/grass/hole.png","chips/grass/rock.png","chips/cave/ground.png","chips/cave/goal.png","chips/cave/hole.png","chips/cave/rock.png","chips/cave/needle.png","chips/cave/broken.png","chips/ice.png","chips/none.png","cursor0.png"],SOUND_PATH:"/sound/",SOUNDS:[],INITIAL_LEVEL:1,LAST_LEVEL:7,LEVEL_TIME:30};function w(){var C,z,B,y,A;w.__super__.constructor.call(this,this.config.WIDTH,this.config.HEIGHT);this.fps=this.config.FPS;this.keybind(90,"a");this.keybind(88,"b");w.game=this;w.config=this.config;A=this.config.IMAGES;for(B=0,y=A.length;B<y;B++){C=A[B];this.preload(""+this.config.IMAGE_PATH+C)}z=new c();this.onload=function(){z.setup();return this.pushScene(z)};this.start()}return w})(Game);window.onload=function(){return new s()};v=(function(){w.CSRF="csrfmiddlewaretoken";function w(y,x,A){var z;z=$("input[name="+w.CSRF+"]").val();x[w.CSRF]=z;$.post(y,x,A)}return w})();n=(function(w){u(x,w);function x(A,B,z,C){if(z==null){z=0}if(C==null){C=0}x.__super__.constructor.call(this,A,B);this.removeEventListener("enterframe");this.x=z;this.y=C;this.velocity=new a();this.speed=7}x.prototype.update=function(y){this.x+=this.velocity.x;return this.y+=this.velocity.y};x.prototype.setImage=function(y){return this.image=s.game.assets[""+s.config.IMAGE_PATH+y]};x.prototype.getPosition=function(){return new a(this.x,this.y)};x.prototype.getCenter=function(){return new a(this.x+this.width/2,this.y+this.height/2)};x.prototype.setPosition=function(y){this.x=y.x;return this.y=y.y};return x})(Sprite);f=(function(w){u(x,w);function x(y,z){x.__super__.constructor.call(this,y,z);this.addEventListener("enterframe",this.update)}x.prototype.update=function(A){var z,y;if((z=this.timer)!=null){z.tick()}if((y=this.timer)!=null?y.isOver():void 0){return this}};x.prototype.setMoveAnimation=function(B,A,z){var y;if(!(this.timer!=null)||this.timer.isOver()){this.timer=new r(z);this.timer.play();y=this;this.timer.setOnUpdate(function(){var C,D;C=A.clone().sub(B);D=C.div(z);y.x+=D.x;return y.y+=D.y});return this.timer.setOnComplete(function(){return y.setPosition(A)})}};x.prototype.isMoving=function(){var y;return(this.timer!=null)&&!((y=this.timer)!=null?y.isOver():void 0)};return x})(n);b={Up:0,Right:1,Down:2,Left:3};d=(function(w){u(x,w);function x(y){x.__super__.constructor.call(this,48,48);this.maxFrame=y;this.fps=10;this.setDirection(b.Right)}x.prototype.setDirection=function(G){var E,D,B,F,A,z,C,y;G=(G+4)%4;F=this.maxFrame*((G+2)%4);E=[];for(D=A=F,C=F+this.maxFrame;F<=C?A<C:A>C;D=F<=C?++A:--A){for(B=z=0,y=this.fps;0<=y?z<y:z>y;B=0<=y?++z:--z){E.push(D)}}this.frame=E;return this.direction=G};return x})(f);q=(function(x){u(w,x);function w(){w.__super__.constructor.call(this,3);this.setImage("characters/player.png");this.setDirection(b.Up)}return w})(d);m={Grass:0,Lake:1,Tower:2,Castle:3,Cave:4,Forest:5};e={None:0,Ground:1,Goal:2,Wall:3,BrokenGround:4,Hole:5,Rock:6,Ice:7,NeedleLeft:224,NeedleUp:225,NeedleRight:226,NeedleDown:227};h=(function(x){u(w,x);w.WIDTH=48;w.HEIGHT=48;function w(z,y,A){w.__super__.constructor.call(this,w.WIDTH,w.HEIGHT);this.setImage(this.getFilePath(m.Cave,A));this.addEventListener("enterframe",this.update);this.localX=z;this.localY=y;this.x=z*w.WIDTH;this.y=y*w.HEIGHT;this.type=A;if(this.type===e.NeedleRight){this.setDirection(b.Right)}else{if(this.type===e.NeedleUp){this.setDirection(b.Up)}else{if(this.type===e.NeedleLeft){this.setDirection(b.Left)}else{this.setDirection(b.Down)}}}}w.prototype.update=function(y){return this.rotaiton=this.direction*90};w.prototype.getFilePath=function(y,A){var B,C,z;B="chips";C=["grass","lake","tower","castle","cave","forest"];if(A===e.None){return""+B+"/none.png"}else{if(A===e.Ice){return""+B+"/ice.png"}else{if(A===e.NeedleRight||A===e.NeedleDown||A===e.NeedleUp||A===e.NeedleLeft){return""+B+"/"+C[y]+"/needle.png"}else{z=["ground","goal","rock","broken","hole","rock"];return""+B+"/"+C[y]+"/"+z[A-1]+".png"}}}};w.prototype.getTileType=function(){return this.type};w.prototype.isDangerous=function(z){var A,y;if((A=this.type)===e.NeedleRight||A===e.NeedleDown||A===e.NeedleUp||A===e.NeedleLeft){return z===((this.direction+2)%4)}return(y=this.type)===e.Hole||y===e.Needle||y===e.None};w.prototype.isWalkable=function(z){var A,y;if((A=this.type)===e.NeedleRight||A===e.NeedleDown||A===e.NeedleUp||A===e.NeedleLeft){return z===(this.direction+2)%4}return !((y=this.type)===e.Rock||y===e.Wall)};w.prototype.isRotatable=function(){var y;return !((y=this.type)===e.None)};w.prototype.setDirection=function(y){this.originX=w.WIDTH*0.5;this.originY=w.HEIGHT*0.5;this.direction=y;return this.rotation=90*((y+2)%4)};return w})(n);j={Left:0,Right:1};l=(function(x){u(w,x);w.speed=10;function w(N,G,E,L){var K,I,J,P,O,H,B,z,M,Q,F,D,C,A;w.__super__.constructor.call(this);this.map=N;this.lu=this.map.getTile(G,E);this.ld=this.map.getTile(G,E+1);this.ru=this.map.getTile(G+1,E);this.rd=this.map.getTile(G+1,E+1);this.root=this.lu.getPosition().clone();this.end=this.lu.getPosition().clone().add(new a(h.WIDTH*2,h.HEIGHT*2));F=[this.lu,this.ld,this.ru,this.rd];for(B=0,M=F.length;B<M;B++){J=F[B];J.parentNode.removeChild(J);this.addChild(J);J.x-=this.root.x;J.y-=this.root.y}this.objects=[];D=this.map.objects;for(z=0,Q=D.length;z<Q;z++){P=D[z];if((this.root.x<=(C=P.x)&&C<this.end.x)&&(this.root.y<=(A=P.y)&&A<this.end.y)){I=this.map.globalToLocal(P.getPosition().x,P.getPosition().y);O=this.map.getTile(I.x,I.y);this.objects.push([P,O]);this.map.objectLayer.removeChild(P);this.addChild(P);P.setPosition(this.globalToNodePosition(P.getPosition()))}}H=h.WIDTH;K=h.HEIGHT;this.originX=H;this.originY=K;this.x=this.root.x;this.y=this.root.y;this.count=0;this.direction=L;this.addEventListener("enterframe",this.update)}w.prototype.update=function(G){var F,K,C,J,I,z,H,D,B,L,y,E,A;if(!this.isEnd()){if(this.direction===j.Left){z=-w.speed}else{z=w.speed}this.rotation+=z;this.count+=1}if(this.isEnd()){K=this.map.globalToLocal(this.root.x,this.root.y);J=K.x;I=K.y;if(this.direction===j.Left){this.map.setTile(J,I+1,this.lu);this.map.setTile(J,I,this.ru);this.map.setTile(J+1,I,this.rd);this.map.setTile(J+1,I+1,this.ld)}else{this.map.setTile(J,I+1,this.rd);this.map.setTile(J,I,this.ld);this.map.setTile(J+1,I,this.lu);this.map.setTile(J+1,I+1,this.ru)}E=[this.lu,this.ld,this.ru,this.rd];for(D=0,L=E.length;D<L;D++){H=E[D];H.rotation=0;H.originX=h.WIDTH*0.5;H.originY=h.HEIGHT*0.5;this.removeChild(H);this.map.tileLayer.addChild(H);if(this.direction===j.Left){H.setDirection((H.direction-1)%4)}else{H.setDirection((H.direction+1)%4)}}A=this.objects;for(B=0,y=A.length;B<y;B++){F=A[B];C=F[0];H=F[1];this.removeChild(C);this.map.objectLayer.addChild(C);if(this.direction===j.Left){C.setDirection((C.direction-1)%4)}else{C.setDirection((C.direction+1)%4)}C.setPosition(H.getPosition())}return this.map.removeChild(this)}};w.prototype.isEnd=function(){return this.count>=90/w.speed};w.prototype.globalToNodePosition=function(y){return y.clone().sub(this.root)};w.prototype.nodeToGlobalPosition=function(y){return y.clone().add(this.root)};return w})(Group);i=(function(x){u(w,x);function w(z,I,D){var G,A,E,H,F,C,B;w.__super__.constructor.apply(this,arguments);this.tileLayer=new Group();this.objectLayer=new Group();this.addChild(this.tileLayer);console.log(D);this._map=[];for(H=C=0;0<=z?C<z:C>z;H=0<=z?++C:--C){this._map.push([]);for(F=B=0;0<=I?B<I:B>I;F=0<=I?++B:--B){A=D.map[H][F];E=new h(H,F,A);this._map[H].push(E);this.tileLayer.addChild(E)}}this.width=z;this.height=I;this.player=new q();this.player.setPosition(this.localToGlobal(D.player[0],D.player[1]));G=((b.Left+D.player[2])+4)%4;console.log(G);this.player.setDirection(G);this.characters=[this.player];this.objects=[this.player];this.addChild(this.objectLayer);this.objectLayer.addChild(this.player)}w.prototype.getTile=function(z,A){if(z<0||A<0||z>=this.width||A>=this.height){return void 0}return this._map[z][A]};w.prototype.setTile=function(z,C,B){var A;A=this.localToGlobal(z,C);B.localX=z;B.localY=C;B.x=A.x;B.y=A.y;return this._map[z][C]=B};w.prototype.rotate=function(F,D,E){var C,z,B,I,A,H,G;if(F<0||F>=this.width-1||D<0||D>=this.height){return null}B=this.getTile(F,D);z=this.getTile(F,D+1);A=this.getTile(F+1,D);I=this.getTile(F+1,D+1);G=B.width;C=B.height;H=new l(this,F,D,E);return H};w.prototype.localToGlobal=function(z,A){return new a(z*h.WIDTH,A*h.HEIGHT)};w.prototype.globalToLocal=function(z,A){return new a(Math.floor(z/h.WIDTH),Math.floor(A/h.HEIGHT))};w.prototype.getPointWithDirection=function(y,z){switch(z){case b.Up:return new a(y.x,y.y-1);case b.Left:return new a(y.x-1,y.y);case b.Down:return new a(y.x,y.y+1);case b.Right:return new a(y.x+1,y.y)}};w.prototype.canRotate=function(A,E){var B,D,C,z;D=this.getTile(A,E);B=this.getTile(A,E+1);z=this.getTile(A+1,E);C=this.getTile(A+1,E+1);return D.isRotatable()&&B.isRotatable()&&z.isRotatable()&&C.isRotatable()};return w})(Group);k={Ready:0,Main:1,Rotation:2,Move:3,Goal:4,GameOver:5};t=(function(x){u(w,x);function w(A,z){var y;w.__super__.constructor.apply(this,arguments);this.metric_pk=z;this.map=new i(10,10,A);this.addChild(this.map);this.addEventListener("enterframe",this.update);this.cursor=new n(144,144);this.cursor.setImage("cursor0.png");this.cursor.x=0;this.cursor.y=100;y=document.getElementById("enchant-stage");y.scene=this;y.addEventListener("mousemove",this.updateMousePosition);y.addEventListener("mousedown",this.onMousePressed);y.oncontextmenu=function(){return false};this.addChild(this.cursor);this.rotationSet=void 0;this.state=k.Main}w.prototype.setup=function(){return this};w.prototype.update=function(y){if(this.state===k.Rotation){if(this.rotationSet.isEnd()){this.rotationSet=void 0;this.state=k.Move;if(!this.moveNext(this.map.player,this.map.player.direction)){return this.state=k.Main}}}else{if(this.state===k.Move){if(!this.map.player.isMoving()){return this.onMoveCompleted()}}}};w.prototype.onMoveCompleted=function(){var y,z;y=this.map.globalToLocal(this.map.player.getPosition().x,this.map.player.getPosition().y);z=this.map.getTile(y.x,y.y);if(!(z!=null)||z.isDangerous(this.map.player.direction)){this.state=k.GameOver;return alert("gameover")}else{if(z.getTileType()===e.Goal){this.state=k.Goal;return alert("goal")}else{if(z.type===e.Ice){if(!this.moveNext(this.map.player,this.map.player.direction)){return this.state=k.Main}}else{return this.state=k.Main}}}};w.prototype.moveNext=function(z,B){var A,y;A=this.map.getPointWithDirection(this.map.globalToLocal(z.x,z.y),B);y=this.map.getTile(A.x,A.y);if(!(y!=null)||((y!=null)&&y.isWalkable(B))){this.moveTo(z,B,10);return true}return false};w.prototype.updateMousePosition=function(z){var A,y;A=this.scene.cursor;y=this.scene.map.globalToLocal(z.clientX,z.clientY);A.x=h.WIDTH*y.x-144/2;return A.y=h.HEIGHT*y.y-144/2};w.prototype.onMousePressed=function(z){var B,A,y;y=this.scene.map.globalToLocal(z.clientX,z.clientY).sub(new a(1,1));if(this.scene.map.canRotate(y.x,y.y)){A=false;if(z.button===0){B="left";A=this.scene.rotate(y,j.Left)}else{B="right";A=this.scene.rotate(y,j.Right)}if(A){new v("/operations/create",{metric:this.scene.metric_pk,x:y.x,y:y.y,direction:B},function(C){return console.log(C)});return true}}return false};w.prototype.rotate=function(y,z){var A;if(this.state===k.Main){A=this.map.rotate(y.x,y.y,z);if(A!==null){this.rotationSet=A;this.map.addChild(A);this.state=k.Rotation;return true}}return false};w.prototype.moveTo=function(A,B,C){var E,z,y,D;if(g.call(this.map.characters,A)>=0){z=this.map.globalToLocal(A.x,A.y);E=this.map.localToGlobal(z.x,z.y);y=this.map.getPointWithDirection(z,B);D=this.map.localToGlobal(y.x,y.y);return A.setMoveAnimation(E,D,C)}};return w})(Scene);c=(function(x){u(w,x);function w(){return w.__super__.constructor.apply(this,arguments)}w.prototype.setup=function(){var z,y;y=$("#map_id").attr("mapurl");z=y.match(/[0-9]+/)[0];return $.getJSON(y,{},function(A){return new v("/metrics/create",{stage:z},function(B){var C;C=B.pk;return s.game.replaceScene(new t(A,C))})})};return w})(Scene)}).call(this);