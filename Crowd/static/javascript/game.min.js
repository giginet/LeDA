(function(){var d,b,n,k,p,c,s,t,i,f,q,j,m,h,l,e,r,a,o={}.hasOwnProperty,u=function(y,w){for(var v in w){if(o.call(w,v)){y[v]=w[v]}}function x(){this.constructor=y}x.prototype=w.prototype;y.prototype=new x();y.__super__=w.prototype;return y},g=[].indexOf||function(x){for(var w=0,v=this.length;w<v;w++){if(w in this&&this[w]===x){return w}}return -1};a=(function(){function v(w,z){if(w==null){w=0}if(z==null){z=0}this.set(w,z)}v.prototype.set=function(w,z){if(w==null){w=0}if(z==null){z=0}this.x=w;this.y=z;return this};v.prototype.add=function(w){this.x+=w.x;this.y+=w.y;return this};v.prototype.sub=function(w){this.x-=w.x;this.y-=w.y;return this};v.prototype.scale=function(w){this.x*=w;this.y*=w;return this};v.prototype.div=function(w){this.x/=w;this.y/=w;return this};v.prototype.product=function(w){return this.x*w.x+this.y*w.y};v.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};v.prototype.resize=function(w){if(this.length()){this.scale(w/this.length())}return this};v.prototype.normalize=function(){return this.resize(1)};v.prototype.angle=function(){return(180*Math.atan2(this.y,this.x))/Math.PI};v.prototype.rotate=function(B){var z,A,w,C;z=(B*Math.PI)/180;A=this.length();w=this.x;C=this.y;this.x=Math.sin(z)*C+Math.cos(z)*w;this.y=Math.cos(z)*C-Math.sin(z)*w;return this.resize(A)};v.prototype.clone=function(){return new v(this.x,this.y)};v.prototype.reverse=function(){this.x*=-1;this.y*=-1;return this};v.prototype.max=function(w){if(this.length()<=w){return this}return this.resize(w)};v.prototype.min=function(w){if(this.length()>=w){return this}return this.resize(w)};v.prototype.isZero=function(){return this.x===0&&this.y===0};return v})();Array.prototype._index=function(v){var w;if(v<0){w=this.length;return w+v}return v};Array.prototype.at=function(v){return this[this._index(v)]};Array.prototype.map=function(v){var x,w;return([].splice.apply(this,[0,this.length-0].concat(w=(function(){var A,z,y;y=[];for(A=0,z=this.length;A<z;A++){x=this[A];y.push(v(x))}return y}).call(this))),w)};Array.prototype.clone=function(){return this.dup()};Array.prototype.dup=function(){return this.slice(0,this.length)};Array.prototype.each=function(w){var v,y,x;for(v=y=0,x=this.length;0<=x?y<x:y>x;v=0<=x?++y:--y){w(this[v],v)}return this};Array.prototype.deleteAt=function(v){v=this._index(v);if(v>=this.length){return void 0}return this.splice(v,1)};Array.prototype.deleteIf=function(w){var v;return this.replace((function(){var z,y,x;x=[];for(v=z=0,y=this.length;0<=y?z<y:z>y;v=0<=y?++z:--z){if(!w(this[v],v)){x.push(this[v])}}return x}).call(this))};Array.prototype.reject=function(v){var w;w=this.length;this.deleteIf(v);if(w===this.length){return void 0}return this};Array.prototype.isEmpty=function(){return this.length===0};Array.prototype.isEql=function(v,z){var w,y,x;if(z==null){z=function(B,A){return B===A}}if(this.length!==v.length){return false}for(w=y=0,x=this.length;0<=x?y<x:y>x;w=0<=x?++y:--y){if(!z(this[w],v[w])){return false}}return true};Array.prototype.fill=function(y,z,v){var w,x;if(z==null){z=0}if(v==null){v=this.length-1}z=this._index(z);v=this._index(v);[].splice.apply(this,[z,v-z+1].concat(x=(function(){var B,A;A=[];for(w=B=z;z<=v?B<=v:B>=v;w=z<=v?++B:--B){A.push(y)}return A})())),x;return this};Array.prototype.first=function(){return this[0]};Array.prototype.last=function(){var v;v=this._index(-1);return this[v]};Array.prototype.uniq=function(z){var y,x,w,v;if(z==null){z=function(B,A){return B===A}}y=[];for(w=0,v=this.length;w<v;w++){x=this[w];if(!y.isInclude(x,z)){y.push(x)}}return this.replace(y)};Array.prototype.index=function(y,z){var v,x,w;if(z==null){z=function(B,A){return B===A}}for(v=x=0,w=this.length;0<=w?x<w:x>w;v=0<=w?++x:--x){if(z(this[v],y)){return v}}return void 0};Array.prototype.indexes=function(){var x,y,w,v;v=[];for(y=0,w=arguments.length;y<w;y++){x=arguments[y];v.push(this.at(x))}return v};Array.prototype.rindex=function(y,z){var v,x,w;if(z==null){z=function(B,A){return B===A}}for(v=x=w=this.length;w<=0?x<0:x>0;v=w<=0?++x:--x){if(z(this[v],y)){return v}}return void 0};Array.prototype.flatten=function(){return this.replace(this.reduce(function(w,v){return w.concat(v instanceof Array?v.flatten():v)},[]))};Array.prototype.transpose=function(){var C,B,A,z,v,F,E,D;z=this.isEmpty()?0:this.length;C=this.first() instanceof Array?this.first().length:0;if(!z||!C){return this}A=(function(){var x,w;w=[];for(B=x=0;0<=C?x<C:x>C;B=0<=C?++x:--x){w.push([])}return w})();for(v=E=0;0<=z?E<z:E>z;v=0<=z?++E:--E){for(F=D=0;0<=C?D<C:D>C;F=0<=C?++D:--D){A[F][v]=this[v][F]}}return this.replace(A)};Array.prototype.compact=function(){return this.deleteIf(function(v){return v===void 0})};Array.prototype.isInclude=function(y,z){var w,x,v;if(z==null){z=function(B,A){return B===A}}for(x=0,v=this.length;x<v;x++){w=this[x];if(z(w,y)){return true}}return false};Array.prototype.size=function(){return this.length};Array.prototype.swap=function(w,v){var x;w=this._index(w);v=this._index(v);x=this[w];this[w]=this[v];this[v]=x;return this};Array.prototype.shuffle=function(){var v,x,w;for(v=x=0,w=this.length;0<=w?x<w:x>w;v=0<=w?++x:--x){this.swap(v,Math.floor(Math.random()*this.length))}return this};Array.prototype.choice=function(){return this[Math.floor(Math.random()*this.length)]};Array.prototype.count=function(z,A){var v,w,y,x;if(A==null){A=function(C,B){return C===B}}w=0;for(v=y=0,x=this.length;0<=x?y<x:y>x;v=0<=x?++y:--y){if(A(this[v],z)){++w}}return w};Array.prototype.replace=function(v){var x,y,w;this.clear();for(y=0,w=v.length;y<w;y++){x=v[y];this.push(x)}return this};Array.prototype.nitems=function(){return this.clone().compact().size()};Array.prototype.insert=function(){var x,y,w,v,A,z;x=Array.prototype.slice.call(arguments,0,arguments.length);if(x.size()<=1){return this}w=this._index(x[0]);v=x.slice(1,this.length);for(y=A=0,z=v.length;0<=z?A<z:A>z;y=0<=z?++A:--A){this.splice(w+y,0,v[y])}return this};Array.prototype.clear=function(){var v;v=[];while(!this.isEmpty()){v.push(this.deleteAt(0))}return v};Array.prototype.max=function(w){var v;if(w==null){w=function(y,x){if(y===x){return 0}if(y<x){return -1}else{return 1}}}v=this.first();this.reduce(function(y,x){if(w(v,x)<0){return v=x}});return v};Array.prototype.min=function(w){var v;if(w==null){w=function(y,x){if(y===x){return 0}if(y<x){return -1}else{return 1}}}v=this.first();this.reduce(function(y,x){if(w(v,x)>=0){return v=x}});return v};r=(function(){function v(w,y,A,z,x){if(y==null){y=false}if(A==null){A=0}if(z==null){z=false}if(x==null){x=void 0}this.set(w);this._time=A;this._active=z;this._onComplete=x;this._onUpdate=void 0;this._repeat=y}v.prototype.set=function(w){if(w==null){w=0}this._max=w;return this};v.prototype.play=function(){this._active=true;return this};v.prototype.stop=function(){this._active=false;this._time=0;return this};v.prototype.pause=function(){this._active=false;return this};v.prototype.reset=function(){this._time=0;return this};v.prototype.tick=function(){if(this._time<this._max&&this._active){++this._time;if(this._onUpdate!=null){this._onUpdate(this)}if(this._time===this._max){if(this._onComplete!=null){this._onComplete(this)}if(this._repeat){this._time=0}}}return this};v.prototype.now=function(){return this._time};v.prototype.max=function(){return this._max};v.prototype.setNow=function(w){this._time=w;return this};v.prototype.setOnComplete=function(w){this._onComplete=w;return this};v.prototype.setOnUpdate=function(w){return this._onUpdate=w};v.prototype.setRepeat=function(w){this._repeat=w;return this};v.prototype.isActive=function(){return this._active};v.prototype.isOver=function(){return this._time>=this._max};return v})();p=(function(){function v(){}v._sounds=[];v.root="";v.load=function(){var A,w,z,y,x;w=Array.prototype.slice.call(arguments);x=[];for(z=0,y=w.length;z<y;z++){A=w[z];x.push(v._loadSound(A))}return x};v.play=function(w){if(!(v._sounds[w]!=null)){v._loadSound(w)}v.stop(w);return v._sounds[w].play()};v.pause=function(w){if(w!=null){return v._sounds[w].pause()}};v.stop=function(w){if(w!=null){return v._sounds[w].stop()}};v._loadSound=function(x,w){if(!(v._sounds[x]!=null)){if(w!=null){return v._sounds[x]=Sound.load(""+v.root+x,w)}else{return v._sounds[x]=Sound.load(""+v.root+x)}}};return v})();enchant();s=(function(w){u(v,w);v.prototype.config={WIDTH:640,HEIGHT:480,FPS:30,FONT:"Helvetica",IMAGE_PATH:"/image/",IMAGES:["kawaz.png","characters/player.png","chips/grass/ground.png","chips/grass/goal.png","chips/grass/hole.png","chips/grass/rock.png","chips/ice.png","cursor0.png"],SOUND_PATH:"/sound/",SOUNDS:[],INITIAL_LEVEL:1,LAST_LEVEL:7,LEVEL_TIME:30};function v(){var B,y,A,x,z;v.__super__.constructor.call(this,this.config.WIDTH,this.config.HEIGHT);this.fps=this.config.FPS;this.keybind(90,"a");this.keybind(88,"b");v.game=this;v.config=this.config;z=this.config.IMAGES;for(A=0,x=z.length;A<x;A++){B=z[A];this.preload(""+this.config.IMAGE_PATH+B)}y=new c();this.onload=function(){y.setup();return this.pushScene(y)};this.start()}return v})(Game);window.onload=function(){return new s()};n=(function(v){u(w,v);function w(A,B,z,C){if(z==null){z=0}if(C==null){C=0}w.__super__.constructor.call(this,A,B);this.removeEventListener("enterframe");this.x=z;this.y=C;this.velocity=new a();this.speed=7}w.prototype.update=function(x){this.x+=this.velocity.x;return this.y+=this.velocity.y};w.prototype.setImage=function(x){return this.image=s.game.assets[""+s.config.IMAGE_PATH+x]};w.prototype.getPosition=function(){return new a(this.x,this.y)};w.prototype.getCenter=function(){return new a(this.x+this.width/2,this.y+this.height/2)};w.prototype.setPosition=function(x){this.x=x.x;return this.y=x.y};return w})(Sprite);f=(function(v){u(w,v);function w(x,y){w.__super__.constructor.call(this,x,y);this.addEventListener("enterframe",this.update)}w.prototype.update=function(z){var y,x;if((y=this.timer)!=null){y.tick()}if((x=this.timer)!=null?x.isOver():void 0){return this}};w.prototype.setMoveAnimation=function(A,z,y){var x;if(!(this.timer!=null)||this.timer.isOver()){this.timer=new r(y);this.timer.play();x=this;this.timer.setOnUpdate(function(){var B,C;B=z.clone().sub(A);C=B.div(y);x.x+=C.x;return x.y+=C.y});return this.timer.setOnComplete(function(){return x.setPosition(z)})}};w.prototype.isMoving=function(){var x;return(this.timer!=null)&&!((x=this.timer)!=null?x.isOver():void 0)};return w})(n);b={Up:0,Right:1,Down:2,Left:3};d=(function(v){u(w,v);function w(x){w.__super__.constructor.call(this,48,48);this.maxFrame=x;this.fps=10;this.setDirection(b.Right)}w.prototype.setDirection=function(F){var D,C,A,E,z,y,B,x;F=(F+4)%4;E=this.maxFrame*((F+2)%4);D=[];for(C=z=E,B=E+this.maxFrame;E<=B?z<B:z>B;C=E<=B?++z:--z){for(A=y=0,x=this.fps;0<=x?y<x:y>x;A=0<=x?++y:--y){D.push(C)}}this.frame=D;return this.direction=F};return w})(f);q=(function(w){u(v,w);function v(){v.__super__.constructor.call(this,3);this.setImage("characters/player.png");this.setDirection(b.Up)}return v})(d);m={Grass:0,Lake:1,Tower:2,Castle:3,Cave:4,Forest:5};e={Ground:0,Goal:1,Hole:2,Jump:3,Needle:4,BrokenGround:5,Rock:6,Ice:7};h=(function(w){u(v,w);v.WIDTH=48;v.HEIGHT=48;function v(y,x,z){v.__super__.constructor.call(this,v.WIDTH,v.HEIGHT);this.setImage(this.getFilePath(m.Grass,z));this.direction=0;this.addEventListener("enterframe",this.update);this.localX=y;this.localY=x;this.x=y*v.WIDTH;this.y=x*v.HEIGHT;this.type=z}v.prototype.update=function(x){return this.rotaiton=this.direction*90};v.prototype.getFilePath=function(x,z){var A,B,y;A="chips";if(z===e.Ice){return""+A+"/ice.png"}else{B=["grass","lake","tower","castle","cave","forest"];y=["ground","goal","hole","jump","needle","brokenGround","rock"];return""+A+"/"+B[x]+"/"+y[z]+".png"}};v.prototype.getTileType=function(){return this.type};v.prototype.isDangerous=function(x){var y;return(y=this.type)===e.Hole||y===e.Needle};v.prototype.isWalkable=function(x){var y;return !((y=this.type)===e.Rock)};return v})(n);j={Left:0,Right:1};l=(function(w){u(v,w);v.speed=10;function v(N,G,E,L){var K,I,J,P,O,H,B,z,M,Q,F,D,C,A;v.__super__.constructor.call(this);this.map=N;this.lu=this.map.getTile(G,E);this.ld=this.map.getTile(G,E+1);this.ru=this.map.getTile(G+1,E);this.rd=this.map.getTile(G+1,E+1);this.root=this.lu.getPosition().clone();this.end=this.lu.getPosition().clone().add(new a(h.WIDTH*2,h.HEIGHT*2));F=[this.lu,this.ld,this.ru,this.rd];for(B=0,M=F.length;B<M;B++){J=F[B];J.parentNode.removeChild(J);this.addChild(J);J.x-=this.root.x;J.y-=this.root.y}this.objects=[];D=this.map.objects;for(z=0,Q=D.length;z<Q;z++){P=D[z];if((this.root.x<=(C=P.x)&&C<this.end.x)&&(this.root.y<=(A=P.y)&&A<this.end.y)){I=this.map.globalToLocal(P.getPosition().x,P.getPosition().y);O=this.map.getTile(I.x,I.y);this.objects.push([P,O]);this.map.objectLayer.removeChild(P);this.addChild(P);P.setPosition(this.globalToNodePosition(P.getPosition()))}}H=h.WIDTH;K=h.HEIGHT;this.originX=H;this.originY=K;this.x=this.root.x;this.y=this.root.y;this.count=0;this.direction=L;this.addEventListener("enterframe",this.update)}v.prototype.update=function(F){var E,J,B,I,H,y,G,C,A,K,x,D,z;if(!this.isEnd()){if(this.direction===j.Left){y=-v.speed}else{y=v.speed}this.rotation+=y;this.count+=1}if(this.isEnd()){J=this.map.globalToLocal(this.root.x,this.root.y);I=J.x;H=J.y;if(this.direction===j.Left){this.map.setTile(I,H+1,this.lu);this.map.setTile(I,H,this.ru);this.map.setTile(I+1,H,this.rd);this.map.setTile(I+1,H+1,this.ld)}else{this.map.setTile(I,H+1,this.rd);this.map.setTile(I,H,this.ld);this.map.setTile(I+1,H,this.lu);this.map.setTile(I+1,H+1,this.ru)}D=[this.lu,this.ld,this.ru,this.rd];for(C=0,K=D.length;C<K;C++){G=D[C];G.rotation=0;G.originX=h.WIDTH*0.5;G.originY=h.HEIGHT*0.5;G.direction=(G.direction+1)%4;this.removeChild(G);this.map.tileLayer.addChild(G)}z=this.objects;for(A=0,x=z.length;A<x;A++){E=z[A];B=E[0];G=E[1];this.removeChild(B);this.map.objectLayer.addChild(B);if(this.direction===j.Left){B.setDirection(B.direction-1)}else{B.setDirection(B.direction+1)}B.setPosition(G.getPosition())}return this.map.removeChild(this)}};v.prototype.isEnd=function(){return this.count>=90/v.speed};v.prototype.globalToNodePosition=function(x){return x.clone().sub(this.root)};v.prototype.nodeToGlobalPosition=function(x){return x.clone().add(this.root)};return v})(Group);i=(function(w){u(v,w);function v(B,A){var D,z,F,E,C;v.__super__.constructor.apply(this,arguments);this.tileLayer=new Group();this.objectLayer=new Group();this.addChild(this.tileLayer);this._map=[];for(z=E=0;0<=B?E<B:E>B;z=0<=B?++E:--E){this._map.push([]);for(F=C=0;0<=A?C<A:C>A;F=0<=A?++C:--C){if(z===5&&F===5){D=new h(z,F,e.Goal)}else{if(z===6&&F===6){D=new h(z,F,e.Rock)}else{if(z===7&&F===7){D=new h(z,F,e.Ice)}else{D=new h(z,F,e.Ground)}}}this._map[z].push(D);this.tileLayer.addChild(D)}}this.width=B;this.height=A;this.player=new q();this.player.setPosition(this.localToGlobal(1,1));this.characters=[this.player];this.objects=[this.player];this.addChild(this.objectLayer);this.objectLayer.addChild(this.player)}v.prototype.getTile=function(z,A){if(z<0||A<0||z>=this.width||A>=this.height){return void 0}return this._map[z][A]};v.prototype.setTile=function(z,C,B){var A;A=this.localToGlobal(z,C);B.localX=z;B.localY=C;B.x=A.x;B.y=A.y;return this._map[z][C]=B};v.prototype.rotate=function(F,D,E){var C,z,B,I,A,H,G;if(F<0||F>=this.width-1||D<0||D>=this.height){return null}B=this.getTile(F,D);z=this.getTile(F,D+1);A=this.getTile(F+1,D);I=this.getTile(F+1,D+1);G=B.width;C=B.height;H=new l(this,F,D,E);return H};v.prototype.localToGlobal=function(z,A){return new a(z*h.WIDTH,A*h.HEIGHT)};v.prototype.globalToLocal=function(z,A){return new a(Math.floor(z/h.WIDTH),Math.floor(A/h.HEIGHT))};v.prototype.getPointWithDirection=function(x,y){switch(y){case b.Up:return new a(x.x,x.y-1);case b.Left:return new a(x.x-1,x.y);case b.Down:return new a(x.x,x.y+1);case b.Right:return new a(x.x+1,x.y)}};return v})(Group);k={Ready:0,Main:1,Rotation:2,Move:3,Goal:4,GameOver:5};t=(function(w){u(v,w);function v(){var x;v.__super__.constructor.apply(this,arguments);this.map=new i(10,10);this.addChild(this.map);this.addEventListener("enterframe",this.update);this.cursor=new n(144,144);this.cursor.setImage("cursor0.png");this.cursor.x=0;this.cursor.y=100;x=document.getElementById("enchant-stage");x.scene=this;x.addEventListener("mousemove",this.updateMousePosition);x.addEventListener("mousedown",this.onMousePressed);x.oncontextmenu=function(){return false};this.addChild(this.cursor);this.rotationSet=void 0;this.state=k.Main}v.prototype.setup=function(){return this};v.prototype.update=function(z){var y,x;if(this.state===k.Rotation){if(this.rotationSet.isEnd()){this.rotationSet=void 0;this.state=k.Move;y=this.map.getPointWithDirection(this.map.globalToLocal(this.map.player.x,this.map.player.y),this.map.player.direction);x=this.map.getTile(y.x,y.y);if(!(x!=null)||((x!=null)&&x.isWalkable(this.map.player.direction))){return this.moveTo(this.map.player,this.map.player.direction,10)}}}else{if(this.state===k.Move){if(!this.map.player.isMoving()){return this.onMoveCompleted()}}}};v.prototype.onMoveCompleted=function(){var x,y;x=this.map.globalToLocal(this.map.player.getPosition().x,this.map.player.getPosition().y);y=this.map.getTile(x.x,x.y);if(!(y!=null)||y.isDangerous()){this.state=k.GameOver;return alert("gameover")}else{if(y.getTileType()===e.Goal){this.state=k.Goal;return alert("goal")}else{if(y.type===e.Ice){return this.moveTo(this.map.player,this.map.player.direction,10)}else{return this.state=k.Main}}}};v.prototype.updateMousePosition=function(y){var z,x;z=this.scene.cursor;x=this.scene.map.globalToLocal(y.clientX,y.clientY);z.x=h.WIDTH*x.x-144/2;return z.y=h.HEIGHT*x.y-144/2};v.prototype.onMousePressed=function(y){var x;x=this.scene.map.globalToLocal(y.clientX,y.clientY).sub(new a(1,1));if(y.button===0){this.scene.rotate(x,j.Left)}else{this.scene.rotate(x,j.Right)}return true};v.prototype.rotate=function(x,y){var z;if(this.state===k.Main){z=this.map.rotate(x.x,x.y,y);if(z!==null){this.rotationSet=z;this.map.addChild(z);return this.state=k.Rotation}}};v.prototype.moveTo=function(z,A,B){var D,y,x,C;if(g.call(this.map.characters,z)>=0){y=this.map.globalToLocal(z.x,z.y);D=this.map.localToGlobal(y.x,y.y);x=this.map.getPointWithDirection(y,A);C=this.map.localToGlobal(x.x,x.y);return z.setMoveAnimation(D,C,B)}};return v})(Scene);c=(function(w){u(v,w);function v(){return v.__super__.constructor.apply(this,arguments)}v.prototype.setup=function(){this.kawaz=new n(253,81);this.kawaz.setImage("kawaz.png");this.kawaz.x=193.5;this.kawaz.y=220;this.kawaz.opacity=0;this.addChild(this.kawaz);this.addEventListener("enterframe",this.update);this.timer=new r(180);this.timer.setOnComplete(function(){s.game.replaceScene(new t());return this});return this.timer.play()};v.prototype.update=function(){if(s.game.input.a){s.game.replaceScene(new t());this}this.timer.tick();if(this.timer.now()<60){return this.kawaz.opacity+=1/60}else{if(this.timer.now()>120){return this.kawaz.opacity-=1/60}}};return v})(Scene)}).call(this);