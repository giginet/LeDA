(function(){var i,m,n,p,c,o,j,b,a,g,l,q,e,k,f,h={}.hasOwnProperty,d=function(u,s){for(var r in s){if(h.call(s,r)){u[r]=s[r]}}function t(){this.constructor=u}t.prototype=s.prototype;u.prototype=new t();u.__super__=s.prototype;return u};f=(function(){function r(s,t){if(s==null){s=0}if(t==null){t=0}this.set(s,t)}r.prototype.set=function(s,t){if(s==null){s=0}if(t==null){t=0}this.x=s;this.y=t;return this};r.prototype.add=function(s){this.x+=s.x;this.y+=s.y;return this};r.prototype.sub=function(s){this.x-=s.x;this.y-=s.y;return this};r.prototype.scale=function(s){this.x*=s;this.y*=s;return this};r.prototype.div=function(s){this.x/=s;this.y/=s;return this};r.prototype.product=function(s){return this.x*s.x+this.y*s.y};r.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};r.prototype.resize=function(s){if(this.length()){this.scale(s/this.length())}return this};r.prototype.normalize=function(){return this.resize(1)};r.prototype.angle=function(){return(180*Math.atan2(this.y,this.x))/Math.PI};r.prototype.rotate=function(v){var t,u,s,w;t=(v*Math.PI)/180;u=this.length();s=this.x;w=this.y;this.x=Math.sin(t)*w+Math.cos(t)*s;this.y=Math.cos(t)*w-Math.sin(t)*s;return this.resize(u)};r.prototype.clone=function(){return new r(this.x,this.y)};r.prototype.reverse=function(){this.x*=-1;this.y*=-1;return this};r.prototype.max=function(s){if(this.length()<=s){return this}return this.resize(s)};r.prototype.min=function(s){if(this.length()>=s){return this}return this.resize(s)};r.prototype.isZero=function(){return this.x===0&&this.y===0};return r})();Array.prototype._index=function(r){var s;if(r<0){s=this.length;return s+r}return r};Array.prototype.at=function(r){return this[this._index(r)]};Array.prototype.map=function(r){var t,s;return([].splice.apply(this,[0,this.length-0].concat(s=(function(){var w,v,u;u=[];for(w=0,v=this.length;w<v;w++){t=this[w];u.push(r(t))}return u}).call(this))),s)};Array.prototype.clone=function(){return this.dup()};Array.prototype.dup=function(){return this.slice(0,this.length)};Array.prototype.each=function(s){var r,u,t;for(r=u=0,t=this.length;0<=t?u<t:u>t;r=0<=t?++u:--u){s(this[r],r)}return this};Array.prototype.deleteAt=function(r){r=this._index(r);if(r>=this.length){return void 0}return this.splice(r,1)};Array.prototype.deleteIf=function(s){var r;return this.replace((function(){var v,u,t;t=[];for(r=v=0,u=this.length;0<=u?v<u:v>u;r=0<=u?++v:--v){if(!s(this[r],r)){t.push(this[r])}}return t}).call(this))};Array.prototype.reject=function(r){var s;s=this.length;this.deleteIf(r);if(s===this.length){return void 0}return this};Array.prototype.isEmpty=function(){return this.length===0};Array.prototype.isEql=function(r,v){var s,u,t;if(v==null){v=function(x,w){return x===w}}if(this.length!==r.length){return false}for(s=u=0,t=this.length;0<=t?u<t:u>t;s=0<=t?++u:--u){if(!v(this[s],r[s])){return false}}return true};Array.prototype.fill=function(u,v,r){var s,t;if(v==null){v=0}if(r==null){r=this.length-1}v=this._index(v);r=this._index(r);[].splice.apply(this,[v,r-v+1].concat(t=(function(){var x,w;w=[];for(s=x=v;v<=r?x<=r:x>=r;s=v<=r?++x:--x){w.push(u)}return w})())),t;return this};Array.prototype.first=function(){return this[0]};Array.prototype.last=function(){var r;r=this._index(-1);return this[r]};Array.prototype.uniq=function(v){var u,t,s,r;if(v==null){v=function(x,w){return x===w}}u=[];for(s=0,r=this.length;s<r;s++){t=this[s];if(!u.isInclude(t,v)){u.push(t)}}return this.replace(u)};Array.prototype.index=function(u,v){var r,t,s;if(v==null){v=function(x,w){return x===w}}for(r=t=0,s=this.length;0<=s?t<s:t>s;r=0<=s?++t:--t){if(v(this[r],u)){return r}}return void 0};Array.prototype.indexes=function(){var t,u,s,r;r=[];for(u=0,s=arguments.length;u<s;u++){t=arguments[u];r.push(this.at(t))}return r};Array.prototype.rindex=function(u,v){var r,t,s;if(v==null){v=function(x,w){return x===w}}for(r=t=s=this.length;s<=0?t<0:t>0;r=s<=0?++t:--t){if(v(this[r],u)){return r}}return void 0};Array.prototype.flatten=function(){return this.replace(this.reduce(function(s,r){return s.concat(r instanceof Array?r.flatten():r)},[]))};Array.prototype.transpose=function(){var z,v,u,s,r,C,B,A;s=this.isEmpty()?0:this.length;z=this.first() instanceof Array?this.first().length:0;if(!s||!z){return this}u=(function(){var w,t;t=[];for(v=w=0;0<=z?w<z:w>z;v=0<=z?++w:--w){t.push([])}return t})();for(r=B=0;0<=s?B<s:B>s;r=0<=s?++B:--B){for(C=A=0;0<=z?A<z:A>z;C=0<=z?++A:--A){u[C][r]=this[r][C]}}return this.replace(u)};Array.prototype.compact=function(){return this.deleteIf(function(r){return r===void 0})};Array.prototype.isInclude=function(u,v){var s,t,r;if(v==null){v=function(x,w){return x===w}}for(t=0,r=this.length;t<r;t++){s=this[t];if(v(s,u)){return true}}return false};Array.prototype.size=function(){return this.length};Array.prototype.swap=function(s,r){var t;s=this._index(s);r=this._index(r);t=this[s];this[s]=this[r];this[r]=t;return this};Array.prototype.shuffle=function(){var r,t,s;for(r=t=0,s=this.length;0<=s?t<s:t>s;r=0<=s?++t:--t){this.swap(r,Math.floor(Math.random()*this.length))}return this};Array.prototype.choice=function(){return this[Math.floor(Math.random()*this.length)]};Array.prototype.count=function(v,w){var r,s,u,t;if(w==null){w=function(y,x){return y===x}}s=0;for(r=u=0,t=this.length;0<=t?u<t:u>t;r=0<=t?++u:--u){if(w(this[r],v)){++s}}return s};Array.prototype.replace=function(r){var t,u,s;this.clear();for(u=0,s=r.length;u<s;u++){t=r[u];this.push(t)}return this};Array.prototype.nitems=function(){return this.clone().compact().size()};Array.prototype.insert=function(){var t,u,s,r,w,v;t=Array.prototype.slice.call(arguments,0,arguments.length);if(t.size()<=1){return this}s=this._index(t[0]);r=t.slice(1,this.length);for(u=w=0,v=r.length;0<=v?w<v:w>v;u=0<=v?++w:--w){this.splice(s+u,0,r[u])}return this};Array.prototype.clear=function(){var r;r=[];while(!this.isEmpty()){r.push(this.deleteAt(0))}return r};Array.prototype.max=function(s){var r;if(s==null){s=function(u,t){if(u===t){return 0}if(u<t){return -1}else{return 1}}}r=this.first();this.reduce(function(u,t){if(s(r,t)<0){return r=t}});return r};Array.prototype.min=function(s){var r;if(s==null){s=function(u,t){if(u===t){return 0}if(u<t){return -1}else{return 1}}}r=this.first();this.reduce(function(u,t){if(s(r,t)>=0){return r=t}});return r};k=(function(){function r(s,u,w,v,t){if(u==null){u=false}if(w==null){w=0}if(v==null){v=false}if(t==null){t=void 0}this.set(s);this._time=w;this._active=v;this._complete=t;this._repeat=u}r.prototype.set=function(s){if(s==null){s=0}this._max=s;return this};r.prototype.play=function(){this._active=true;return this};r.prototype.stop=function(){this._active=false;this._time=0;return this};r.prototype.pause=function(){this._active=false;return this};r.prototype.reset=function(){this._time=0;return this};r.prototype.tick=function(){if(this._time<this._max&&this._active){++this._time;if(this._time===this._max){if(this._complete!=null){this._complete()}if(this._repeat){this._time=0}}}return this};r.prototype.now=function(){return this._time};r.prototype.max=function(){return this._max};r.prototype.setNow=function(s){this._time=s;return this};r.prototype.setComplete=function(s){this._complete=s;return this};r.prototype.setRepeat=function(s){this._repeat=s;return this};r.prototype.isActive=function(){return this._active};r.prototype.isOver=function(){return this._time>=this._max};return r})();p=(function(){function r(){}r._sounds=[];r.root="";r.load=function(){var w,s,v,u,t;s=Array.prototype.slice.call(arguments);t=[];for(v=0,u=s.length;v<u;v++){w=s[v];t.push(r._loadSound(w))}return t};r.play=function(s){if(!(r._sounds[s]!=null)){r._loadSound(s)}r.stop(s);return r._sounds[s].play()};r.pause=function(s){if(s!=null){return r._sounds[s].pause()}};r.stop=function(s){if(s!=null){return r._sounds[s].stop()}};r._loadSound=function(t,s){if(!(r._sounds[t]!=null)){if(s!=null){return r._sounds[t]=Sound.load(""+r.root+t,s)}else{return r._sounds[t]=Sound.load(""+r.root+t)}}};return r})();enchant();o=(function(s){d(r,s);r.prototype.config={WIDTH:640,HEIGHT:480,FPS:30,FONT:"Helvetica",IMAGE_PATH:"/image/",IMAGES:["kawaz.png","characters/player.png","chips/grass.png","cursor0.png"],SOUND_PATH:"/sound/",SOUNDS:[],INITIAL_LEVEL:1,LAST_LEVEL:7,LEVEL_TIME:30};function r(){var x,u,w,t,v;r.__super__.constructor.call(this,this.config.WIDTH,this.config.HEIGHT);this.fps=this.config.FPS;this.keybind(90,"a");this.keybind(88,"b");r.game=this;r.config=this.config;v=this.config.IMAGES;for(w=0,t=v.length;w<t;w++){x=v[w];this.preload(""+this.config.IMAGE_PATH+x)}u=new c();this.onload=function(){u.setup();return this.pushScene(u)};this.start()}return r})(Game);window.onload=function(){return new o()};n=(function(r){d(s,r);function s(u,v,t,z){if(t==null){t=0}if(z==null){z=0}s.__super__.constructor.call(this,u,v);this.removeEventListener("enterframe");this.x=t;this.y=z;this.velocity=new f();this.speed=7}s.prototype.update=function(t){this.x+=this.velocity.x;return this.y+=this.velocity.y};s.prototype.setImage=function(t){return this.image=o.game.assets[""+o.config.IMAGE_PATH+t]};s.prototype.getPosition=function(){return new f(this.x,this.y)};s.prototype.getCenter=function(){return new f(this.x+this.width/2,this.y+this.height/2)};s.prototype.setPosition=function(t){this.x=t.x;return this.y=t.y};return s})(Sprite);m={Up:0,Right:1,Down:2,Left:3};i=(function(r){d(s,r);function s(t){s.__super__.constructor.call(this,48,48);this.maxFrame=t}s.prototype.setDirection=function(z){var A,v,u,t,y,w,x;t=this.maxFrame*((z+2)%4);A=[];for(v=y=t,x=t+this.maxFrame;t<=x?y<x:y>x;v=t<=x?++y:--y){for(u=w=0;w<10;u=++w){A.push(v)}}return this.frame=A};return s})(n);a=(function(s){d(r,s);function r(){r.__super__.constructor.call(this,3);this.setImage("characters/player.png");this.setDirection(m.Down)}return r})(i);e={None:0,Floor:1,Wall:2};l=(function(s){d(r,s);r.WIDTH=48;r.HEIGHT=48;function r(){r.__super__.constructor.call(this,r.WIDTH,r.HEIGHT);this.setImage("chips/grass.png");this.direction=0;this.addEventListener("enterframe",this.update)}r.prototype.update=function(t){return this.rotaiton=this.direction*90};return r})(n);g={Left:0,Right:1};q=(function(){function r(z,s,A,v){var u,t;this.map=z;this.lu=this.map.getTile(s,A);this.ld=this.map.getTile(s,A+1);this.ru=this.map.getTile(s+1,A);this.rd=this.map.getTile(s+1,A+1);t=l.WIDTH;u=l.HEIGHT;this.rootx=s;this.rooty=A;this.lu.originX=t*1;this.lu.originY=u*1;this.ld.originX=t*1;this.ld.originY=0;this.ru.originX=0;this.ru.originY=u*1;this.rd.originX=0;this.rd.originY=0;this.count=0;this.direction=v}r.prototype.update=function(){var x,u,w,t,v,s;if(!this.isEnd()){if(this.direction===g.Left){x=-10}else{x=10}this.lu.rotation+=x;this.ld.rotation+=x;this.ru.rotation+=x;this.rd.rotation+=x;this.count+=1}if(this.isEnd()){if(this.direction===g.Left){this.map.setTile(this.rootx,this.rooty+1,this.lu);this.map.setTile(this.rootx,this.rooty,this.ru);this.map.setTile(this.rootx+1,this.rooty,this.rd);this.map.setTile(this.rootx+1,this.rooty+1,this.ld)}else{this.map.setTile(this.rootx,this.rooty+1,this.rd);this.map.setTile(this.rootx,this.rooty,this.ld);this.map.setTile(this.rootx+1,this.rooty,this.lu);this.map.setTile(this.rootx+1,this.rooty+1,this.ru)}v=[this.lu,this.ld,this.ru,this.rd];s=[];for(w=0,t=v.length;w<t;w++){u=v[w];u.rotation=0;u.originX=l.WIDTH*0.5;u.originY=l.HEIGHT*0.5;s.push(u.direction=(u.direction+1)%4)}return s}};r.prototype.isEnd=function(){return this.count>=9};return r})();b=(function(s){d(r,s);function r(v,u){var z,t,B,A,w;r.__super__.constructor.apply(this,arguments);this._map=[];for(t=A=0;0<=v?A<v:A>v;t=0<=v?++A:--A){this._map.push([]);for(B=w=0;0<=u?w<u:w>u;B=0<=u?++w:--w){z=new l();z.x=t*48;z.y=B*48;this._map[t].push(z);this.addChild(z)}}this.width=v;this.height=u;this.player=new a();this.player.setPosition(this.localToGlobal(1,1));this.addChild(this.player)}r.prototype.getTile=function(t,u){return this._map[t][u]};r.prototype.setTile=function(t,z,w){var u;u=this.localToGlobal(t,z);w.x=u.x;w.y=u.y;return this._map[t][z]=w};r.prototype.rotate=function(C,A,B){var z,t,v,F,u,E,D;if(C<0||C>=this.width-1||A<0||A>=this.height){return null}v=this.getTile(C,A);t=this.getTile(C,A+1);u=this.getTile(C+1,A);F=this.getTile(C+1,A+1);D=v.width;z=v.height;E=new q(this,C,A,B);return E};r.prototype.localToGlobal=function(t,u){return new f(t*l.WIDTH,u*l.HEIGHT)};r.prototype.globalToLocal=function(t,u){return new f(Math.floor(t/l.WIDTH),Math.floor(u/l.HEIGHT))};return r})(Group);j=(function(s){d(r,s);function r(){var t;r.__super__.constructor.apply(this,arguments);this.stage=new b(10,10);this.addChild(this.stage);this.addEventListener("enterframe",this.update);this.cursor=new n(144,144);this.cursor.setImage("cursor0.png");this.cursor.x=0;this.cursor.y=100;t=document.getElementById("enchant-stage");t.scene=this;t.addEventListener("mousemove",this.updateMousePosition);this.addEventListener("touchstart",this.onMousePressed);this.addChild(this.cursor);this.tileSetQueue=[]}r.prototype.setup=function(){return this};r.prototype.update=function(x){var y,w,u,v,t;v=this.tileSetQueue;t=[];for(w=0,u=v.length;w<u;w++){y=v[w];y.update();if(y.isEnd()){t.push(this.tileSetQueue.deleteAt(this.tileSetQueue.index(y)))}else{t.push(void 0)}}return t};r.prototype.updateMousePosition=function(u){var w,t;w=this.scene.cursor;t=this.scene.stage.globalToLocal(u.clientX,u.clientY);w.x=l.WIDTH*t.x-144/2;return w.y=l.HEIGHT*t.y-144/2};r.prototype.onMousePressed=function(u){var w,t;t=this.stage.globalToLocal(u.x-l.WIDTH,u.y-l.HEIGHT);w=this.stage.rotate(t.x,t.y,g.Left);if(w!==null){return this.tileSetQueue.push(w)}};r.prototype.rotate=function(t){return this};return r})(Scene);c=(function(s){d(r,s);function r(){return r.__super__.constructor.apply(this,arguments)}r.prototype.setup=function(){this.kawaz=new n(253,81);this.kawaz.setImage("kawaz.png");this.kawaz.x=193.5;this.kawaz.y=220;this.kawaz.opacity=0;this.addChild(this.kawaz);this.addEventListener("enterframe",this.update);this.timer=new k(180);this.timer.setComplete(function(){o.game.replaceScene(new j());return this});return this.timer.play()};r.prototype.update=function(){if(o.game.input.a){o.game.replaceScene(new j());this}this.timer.tick();if(this.timer.now()<60){return this.kawaz.opacity+=1/60}else{if(this.timer.now()>120){return this.kawaz.opacity-=1/60}}};return r})(Scene)}).call(this);