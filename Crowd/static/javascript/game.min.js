(function(){var e,b,f,o,l,q,c,t,u,j,g,r,w,k,n,i,m,d,s,a,p={}.hasOwnProperty,v=function(A,y){for(var x in y){if(p.call(y,x)){A[x]=y[x]}}function z(){this.constructor=A}z.prototype=y.prototype;A.prototype=new z();A.__super__=y.prototype;return A},h=[].indexOf||function(z){for(var y=0,x=this.length;y<x;y++){if(y in this&&this[y]===z){return y}}return -1};a=(function(){function x(z,A){if(z==null){z=0}if(A==null){A=0}this.set(z,A)}x.prototype.set=function(z,A){if(z==null){z=0}if(A==null){A=0}this.x=z;this.y=A;return this};x.prototype.add=function(y){this.x+=y.x;this.y+=y.y;return this};x.prototype.sub=function(y){this.x-=y.x;this.y-=y.y;return this};x.prototype.scale=function(y){this.x*=y;this.y*=y;return this};x.prototype.div=function(y){this.x/=y;this.y/=y;return this};x.prototype.product=function(y){return this.x*y.x+this.y*y.y};x.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};x.prototype.resize=function(y){if(this.length()){this.scale(y/this.length())}return this};x.prototype.normalize=function(){return this.resize(1)};x.prototype.angle=function(){return(180*Math.atan2(this.y,this.x))/Math.PI};x.prototype.rotate=function(C){var A,B,z,D;A=(C*Math.PI)/180;B=this.length();z=this.x;D=this.y;this.x=Math.sin(A)*D+Math.cos(A)*z;this.y=Math.cos(A)*D-Math.sin(A)*z;return this.resize(B)};x.prototype.clone=function(){return new x(this.x,this.y)};x.prototype.reverse=function(){this.x*=-1;this.y*=-1;return this};x.prototype.max=function(y){if(this.length()<=y){return this}return this.resize(y)};x.prototype.min=function(y){if(this.length()>=y){return this}return this.resize(y)};x.prototype.isZero=function(){return this.x===0&&this.y===0};return x})();Array.prototype._index=function(x){var y;if(x<0){y=this.length;return y+x}return x};Array.prototype.at=function(x){return this[this._index(x)]};Array.prototype.map=function(x){var z,y;return([].splice.apply(this,[0,this.length-0].concat(y=(function(){var C,B,A;A=[];for(C=0,B=this.length;C<B;C++){z=this[C];A.push(x(z))}return A}).call(this))),y)};Array.prototype.clone=function(){return this.dup()};Array.prototype.dup=function(){return this.slice(0,this.length)};Array.prototype.each=function(y){var x,A,z;for(x=A=0,z=this.length;0<=z?A<z:A>z;x=0<=z?++A:--A){y(this[x],x)}return this};Array.prototype.deleteAt=function(x){x=this._index(x);if(x>=this.length){return void 0}return this.splice(x,1)};Array.prototype.deleteIf=function(y){var x;return this.replace((function(){var B,A,z;z=[];for(x=B=0,A=this.length;0<=A?B<A:B>A;x=0<=A?++B:--B){if(!y(this[x],x)){z.push(this[x])}}return z}).call(this))};Array.prototype.reject=function(x){var y;y=this.length;this.deleteIf(x);if(y===this.length){return void 0}return this};Array.prototype.isEmpty=function(){return this.length===0};Array.prototype.isEql=function(x,B){var y,A,z;if(B==null){B=function(D,C){return D===C}}if(this.length!==x.length){return false}for(y=A=0,z=this.length;0<=z?A<z:A>z;y=0<=z?++A:--A){if(!B(this[y],x[y])){return false}}return true};Array.prototype.fill=function(A,B,x){var y,z;if(B==null){B=0}if(x==null){x=this.length-1}B=this._index(B);x=this._index(x);[].splice.apply(this,[B,x-B+1].concat(z=(function(){var D,C;C=[];for(y=D=B;B<=x?D<=x:D>=x;y=B<=x?++D:--D){C.push(A)}return C})())),z;return this};Array.prototype.first=function(){return this[0]};Array.prototype.last=function(){var x;x=this._index(-1);return this[x]};Array.prototype.uniq=function(B){var A,z,y,x;if(B==null){B=function(D,C){return D===C}}A=[];for(y=0,x=this.length;y<x;y++){z=this[y];if(!A.isInclude(z,B)){A.push(z)}}return this.replace(A)};Array.prototype.index=function(A,B){var x,z,y;if(B==null){B=function(D,C){return D===C}}for(x=z=0,y=this.length;0<=y?z<y:z>y;x=0<=y?++z:--z){if(B(this[x],A)){return x}}return void 0};Array.prototype.indexes=function(){var z,A,y,x;x=[];for(A=0,y=arguments.length;A<y;A++){z=arguments[A];x.push(this.at(z))}return x};Array.prototype.rindex=function(A,B){var x,z,y;if(B==null){B=function(D,C){return D===C}}for(x=z=y=this.length;y<=0?z<0:z>0;x=y<=0?++z:--z){if(B(this[x],A)){return x}}return void 0};Array.prototype.flatten=function(){return this.replace(this.reduce(function(y,x){return y.concat(x instanceof Array?x.flatten():x)},[]))};Array.prototype.transpose=function(){var D,C,B,A,z,G,F,E;A=this.isEmpty()?0:this.length;D=this.first() instanceof Array?this.first().length:0;if(!A||!D){return this}B=(function(){var y,x;x=[];for(C=y=0;0<=D?y<D:y>D;C=0<=D?++y:--y){x.push([])}return x})();for(z=F=0;0<=A?F<A:F>A;z=0<=A?++F:--F){for(G=E=0;0<=D?E<D:E>D;G=0<=D?++E:--E){B[G][z]=this[z][G]}}return this.replace(B)};Array.prototype.compact=function(){return this.deleteIf(function(x){return x===void 0})};Array.prototype.isInclude=function(A,B){var y,z,x;if(B==null){B=function(D,C){return D===C}}for(z=0,x=this.length;z<x;z++){y=this[z];if(B(y,A)){return true}}return false};Array.prototype.size=function(){return this.length};Array.prototype.swap=function(y,x){var z;y=this._index(y);x=this._index(x);z=this[y];this[y]=this[x];this[x]=z;return this};Array.prototype.shuffle=function(){var x,z,y;for(x=z=0,y=this.length;0<=y?z<y:z>y;x=0<=y?++z:--z){this.swap(x,Math.floor(Math.random()*this.length))}return this};Array.prototype.choice=function(){return this[Math.floor(Math.random()*this.length)]};Array.prototype.count=function(B,C){var x,y,A,z;if(C==null){C=function(E,D){return E===D}}y=0;for(x=A=0,z=this.length;0<=z?A<z:A>z;x=0<=z?++A:--A){if(C(this[x],B)){++y}}return y};Array.prototype.replace=function(x){var z,A,y;this.clear();for(A=0,y=x.length;A<y;A++){z=x[A];this.push(z)}return this};Array.prototype.nitems=function(){return this.clone().compact().size()};Array.prototype.insert=function(){var z,A,y,x,C,B;z=Array.prototype.slice.call(arguments,0,arguments.length);if(z.size()<=1){return this}y=this._index(z[0]);x=z.slice(1,this.length);for(A=C=0,B=x.length;0<=B?C<B:C>B;A=0<=B?++C:--C){this.splice(y+A,0,x[A])}return this};Array.prototype.clear=function(){var x;x=[];while(!this.isEmpty()){x.push(this.deleteAt(0))}return x};Array.prototype.max=function(y){var x;if(y==null){y=function(A,z){if(A===z){return 0}if(A<z){return -1}else{return 1}}}x=this.first();this.reduce(function(A,z){if(y(x,z)<0){return x=z}});return x};Array.prototype.min=function(y){var x;if(y==null){y=function(A,z){if(A===z){return 0}if(A<z){return -1}else{return 1}}}x=this.first();this.reduce(function(A,z){if(y(x,z)>=0){return x=z}});return x};s=(function(){function x(y,A,C,B,z){if(A==null){A=false}if(C==null){C=0}if(B==null){B=false}if(z==null){z=void 0}this.set(y);this._time=C;this._active=B;this._onComplete=z;this._onUpdate=void 0;this._repeat=A}x.prototype.set=function(y){if(y==null){y=0}this._max=y;return this};x.prototype.play=function(){this._active=true;return this};x.prototype.stop=function(){this._active=false;this._time=0;return this};x.prototype.pause=function(){this._active=false;return this};x.prototype.reset=function(){this._time=0;return this};x.prototype.tick=function(){if(this._time<this._max&&this._active){++this._time;if(this._onUpdate!=null){this._onUpdate(this)}if(this._time===this._max){if(this._onComplete!=null){this._onComplete(this)}if(this._repeat){this._time=0}}}return this};x.prototype.now=function(){return this._time};x.prototype.max=function(){return this._max};x.prototype.setNow=function(y){this._time=y;return this};x.prototype.setOnComplete=function(y){this._onComplete=y;return this};x.prototype.setOnUpdate=function(y){return this._onUpdate=y};x.prototype.setRepeat=function(y){this._repeat=y;return this};x.prototype.isActive=function(){return this._active};x.prototype.isOver=function(){return this._time>=this._max};return x})();q=(function(){function x(){}x._sounds=[];x.root="";x.load=function(){var C,y,B,A,z;y=Array.prototype.slice.call(arguments);z=[];for(B=0,A=y.length;B<A;B++){C=y[B];z.push(x._loadSound(C))}return z};x.play=function(y){if(!(x._sounds[y]!=null)){x._loadSound(y)}x.stop(y);return x._sounds[y].play()};x.pause=function(y){if(y!=null){return x._sounds[y].pause()}};x.stop=function(y){if(y!=null){return x._sounds[y].stop()}};x._loadSound=function(z,y){if(!(x._sounds[z]!=null)){if(y!=null){return x._sounds[z]=Sound.load(""+x.root+z,y)}else{return x._sounds[z]=Sound.load(""+x.root+z)}}};return x})();enchant();t=(function(y){v(x,y);x.prototype.config={WIDTH:640,HEIGHT:480,FPS:30,FONT:"Helvetica",IMAGE_PATH:"/image/",IMAGES:["kawaz.png","characters/player.png","chips/grass/ground.png","chips/grass/goal.png","chips/grass/hole.png","chips/grass/rock.png","chips/cave/ground.png","chips/cave/goal.png","chips/cave/hole.png","chips/cave/rock.png","chips/cave/needle.png","chips/cave/broken.png","chips/ice.png","chips/none.png","cursor0.png"],SOUND_PATH:"/sound/",SOUNDS:[],INITIAL_LEVEL:1,LAST_LEVEL:7,LEVEL_TIME:30};function x(){var D,A,C,z,B;x.__super__.constructor.call(this,this.config.WIDTH,this.config.HEIGHT);this.fps=this.config.FPS;this.keybind(90,"a");this.keybind(88,"b");x.game=this;x.config=this.config;B=this.config.IMAGES;for(C=0,z=B.length;C<z;C++){D=B[C];this.preload(""+this.config.IMAGE_PATH+D)}A=new c();this.onload=function(){A.setup();return this.pushScene(A)};this.start()}return x})(Game);window.onload=function(){return new t()};w=(function(){x.CSRF="csrfmiddlewaretoken";function x(z,y,B){var A;A=$("input[name="+x.CSRF+"]").val();y[x.CSRF]=A;$.post(z,y,B)}return x})();o=(function(x){v(y,x);function y(A,B,z,C){if(z==null){z=0}if(C==null){C=0}y.__super__.constructor.call(this,A,B);this.removeEventListener("enterframe");this.x=z;this.y=C;this.velocity=new a();this.speed=7}y.prototype.update=function(z){this.x+=this.velocity.x;return this.y+=this.velocity.y};y.prototype.setImage=function(z){return this.image=t.game.assets[""+t.config.IMAGE_PATH+z]};y.prototype.getPosition=function(){return new a(this.x,this.y)};y.prototype.getCenter=function(){return new a(this.x+this.width/2,this.y+this.height/2)};y.prototype.setPosition=function(z){this.x=z.x;return this.y=z.y};return y})(Sprite);g=(function(x){v(y,x);function y(z,A){y.__super__.constructor.call(this,z,A);this.addEventListener("enterframe",this.update)}y.prototype.update=function(B){var A,z;if((A=this.timer)!=null){A.tick()}if((z=this.timer)!=null?z.isOver():void 0){return this}};y.prototype.setMoveAnimation=function(C,B,A){var z;if(!(this.timer!=null)||this.timer.isOver()){this.timer=new s(A);this.timer.play();z=this;this.timer.setOnUpdate(function(){var D,E;D=B.clone().sub(C);E=D.div(A);z.x+=E.x;return z.y+=E.y});return this.timer.setOnComplete(function(){return z.setPosition(B)})}};y.prototype.isMoving=function(){var z;return(this.timer!=null)&&!((z=this.timer)!=null?z.isOver():void 0)};return y})(o);b={Up:0,Right:1,Down:2,Left:3};e=(function(x){v(y,x);function y(z){y.__super__.constructor.call(this,48,48);this.maxFrame=z;this.fps=10;this.setDirection(b.Right)}y.prototype.setDirection=function(H){var F,E,C,G,B,A,D,z;H=(H+4)%4;G=this.maxFrame*((H+2)%4);F=[];for(E=B=G,D=G+this.maxFrame;G<=D?B<D:B>D;E=G<=D?++B:--B){for(C=A=0,z=this.fps;0<=z?A<z:A>z;C=0<=z?++A:--A){F.push(E)}}this.frame=F;return this.direction=H};return y})(g);r=(function(y){v(x,y);function x(){x.__super__.constructor.call(this,3);this.setImage("characters/player.png");this.setDirection(b.Up)}return x})(e);n={Grass:0,Lake:1,Tower:2,Castle:3,Cave:4,Forest:5};d={None:0,Ground:1,Goal:2,Wall:3,BrokenGround:4,Hole:5,Rock:6,Ice:7,NeedleLeft:224,NeedleUp:225,NeedleRight:226,NeedleDown:227};i=(function(y){v(x,y);x.WIDTH=48;x.HEIGHT=48;function x(A,z,B){x.__super__.constructor.call(this,x.WIDTH,x.HEIGHT);this.setType(B);this.addEventListener("enterframe",this.update);this.localX=A;this.localY=z;this.x=A*x.WIDTH;this.y=z*x.HEIGHT;if(this.type===d.NeedleRight){this.setDirection(b.Right)}else{if(this.type===d.NeedleUp){this.setDirection(b.Up)}else{if(this.type===d.NeedleLeft){this.setDirection(b.Left)}else{this.setDirection(b.Down)}}}}x.prototype.update=function(z){return this.rotaiton=this.direction*90};x.prototype.setType=function(z){this.type=z;return this.setImage(this.getFilePath(n.Cave,z))};x.prototype.getFilePath=function(z,B){var C,D,A;C="chips";D=["grass","lake","tower","castle","cave","forest"];if(B===d.None){return""+C+"/none.png"}else{if(B===d.Ice){return""+C+"/ice.png"}else{if(B===d.NeedleRight||B===d.NeedleDown||B===d.NeedleUp||B===d.NeedleLeft){return""+C+"/"+D[z]+"/needle.png"}else{A=["ground","goal","rock","broken","hole","rock"];return""+C+"/"+D[z]+"/"+A[B-1]+".png"}}}};x.prototype.getTileType=function(){return this.type};x.prototype.onAfterMove=function(z){if(this.type===d.BrokenGround){return this.setType(d.Hole)}};x.prototype.isDangerous=function(A){var B,z;if((B=this.type)===d.NeedleRight||B===d.NeedleDown||B===d.NeedleUp||B===d.NeedleLeft){return A===((this.direction+2)%4)}return(z=this.type)===d.Hole||z===d.Needle||z===d.None};x.prototype.isWalkable=function(A){var B,z;if((B=this.type)===d.NeedleRight||B===d.NeedleDown||B===d.NeedleUp||B===d.NeedleLeft){return A===(this.direction+2)%4}return !((z=this.type)===d.Rock||z===d.Wall)};x.prototype.isRotatable=function(){var z;return !((z=this.type)===d.None)};x.prototype.setDirection=function(z){this.originX=x.WIDTH*0.5;this.originY=x.HEIGHT*0.5;this.direction=z;return this.rotation=90*((z+2)%4)};return x})(o);k={Left:0,Right:1};m=(function(y){v(x,y);x.speed=10;function x(N,G,E,L){var K,I,J,P,O,H,B,z,M,Q,F,D,C,A;x.__super__.constructor.call(this);this.map=N;this.lu=this.map.getTile(G,E);this.ld=this.map.getTile(G,E+1);this.ru=this.map.getTile(G+1,E);this.rd=this.map.getTile(G+1,E+1);this.root=this.lu.getPosition().clone();this.end=this.lu.getPosition().clone().add(new a(i.WIDTH*2,i.HEIGHT*2));F=[this.lu,this.ld,this.ru,this.rd];for(B=0,M=F.length;B<M;B++){J=F[B];J.parentNode.removeChild(J);this.addChild(J);J.x-=this.root.x;J.y-=this.root.y}this.objects=[];D=this.map.objects;for(z=0,Q=D.length;z<Q;z++){P=D[z];if((this.root.x<=(C=P.x)&&C<this.end.x)&&(this.root.y<=(A=P.y)&&A<this.end.y)){I=this.map.globalToLocal(P.getPosition().x,P.getPosition().y);O=this.map.getTile(I.x,I.y);this.objects.push([P,O]);this.map.objectLayer.removeChild(P);this.addChild(P);P.setPosition(this.globalToNodePosition(P.getPosition()))}}H=i.WIDTH;K=i.HEIGHT;this.originX=H;this.originY=K;this.x=this.root.x;this.y=this.root.y;this.count=0;this.direction=L;this.addEventListener("enterframe",this.update)}x.prototype.update=function(H){var G,L,D,K,J,A,I,E,C,M,z,F,B;if(!this.isEnd()){if(this.direction===k.Left){A=-x.speed}else{A=x.speed}this.rotation+=A;this.count+=1}if(this.isEnd()){L=this.map.globalToLocal(this.root.x,this.root.y);K=L.x;J=L.y;if(this.direction===k.Left){this.map.setTile(K,J+1,this.lu);this.map.setTile(K,J,this.ru);this.map.setTile(K+1,J,this.rd);this.map.setTile(K+1,J+1,this.ld)}else{this.map.setTile(K,J+1,this.rd);this.map.setTile(K,J,this.ld);this.map.setTile(K+1,J,this.lu);this.map.setTile(K+1,J+1,this.ru)}F=[this.lu,this.ld,this.ru,this.rd];for(E=0,M=F.length;E<M;E++){I=F[E];I.rotation=0;I.originX=i.WIDTH*0.5;I.originY=i.HEIGHT*0.5;this.removeChild(I);this.map.tileLayer.addChild(I);if(this.direction===k.Left){I.setDirection((I.direction-1)%4)}else{I.setDirection((I.direction+1)%4)}}B=this.objects;for(C=0,z=B.length;C<z;C++){G=B[C];D=G[0];I=G[1];this.removeChild(D);this.map.objectLayer.addChild(D);if(this.direction===k.Left){D.setDirection((D.direction-1)%4)}else{D.setDirection((D.direction+1)%4)}D.setPosition(I.getPosition())}return this.map.removeChild(this)}};x.prototype.isEnd=function(){return this.count>=90/x.speed};x.prototype.globalToNodePosition=function(z){return z.clone().sub(this.root)};x.prototype.nodeToGlobalPosition=function(z){return z.clone().add(this.root)};return x})(Group);j=(function(y){v(x,y);function x(z,I,D){var G,A,E,H,F,C,B;x.__super__.constructor.apply(this,arguments);this.tileLayer=new Group();this.objectLayer=new Group();this.addChild(this.tileLayer);this._map=[];for(H=C=0;0<=z?C<z:C>z;H=0<=z?++C:--C){this._map.push([]);for(F=B=0;0<=I?B<I:B>I;F=0<=I?++B:--B){A=D.map[H][F];E=new i(H,F,A);this._map[H].push(E);this.tileLayer.addChild(E)}}this.width=z;this.height=I;this.player=new r();this.player.setPosition(this.localToGlobal(D.player[0],D.player[1]));G=((b.Left+D.player[2])+4)%4;this.player.setDirection(G);this.characters=[this.player];this.objects=[this.player];this.addChild(this.objectLayer);this.objectLayer.addChild(this.player)}x.prototype.getTile=function(z,A){if(z<0||A<0||z>=this.width||A>=this.height){return void 0}return this._map[z][A]};x.prototype.setTile=function(z,C,B){var A;A=this.localToGlobal(z,C);B.localX=z;B.localY=C;B.x=A.x;B.y=A.y;return this._map[z][C]=B};x.prototype.rotate=function(F,D,E){var C,z,B,I,A,H,G;if(F<0||F>=this.width-1||D<0||D>=this.height){return null}B=this.getTile(F,D);z=this.getTile(F,D+1);A=this.getTile(F+1,D);I=this.getTile(F+1,D+1);G=B.width;C=B.height;H=new m(this,F,D,E);return H};x.prototype.localToGlobal=function(z,A){return new a(z*i.WIDTH,A*i.HEIGHT)};x.prototype.globalToLocal=function(z,A){return new a(Math.floor(z/i.WIDTH),Math.floor(A/i.HEIGHT))};x.prototype.getPointWithDirection=function(z,A){switch(A){case b.Up:return new a(z.x,z.y-1);case b.Left:return new a(z.x-1,z.y);case b.Down:return new a(z.x,z.y+1);case b.Right:return new a(z.x+1,z.y)}};x.prototype.canRotate=function(A,E){var B,D,C,z;D=this.getTile(A,E);B=this.getTile(A,E+1);z=this.getTile(A+1,E);C=this.getTile(A+1,E+1);return D.isRotatable()&&B.isRotatable()&&z.isRotatable()&&C.isRotatable()};return x})(Group);f={Play:0,Metric:1};l={Ready:0,Main:1,Rotation:2,Move:3,Goal:4,GameOver:5};u=(function(y){v(x,y);function x(D,z,C,A){var B;if(C==null){C=f.Play}if(A==null){A=void 0}x.__super__.constructor.apply(this,arguments);this.mode=C;this.metric_url=A;this.map=new j(10,10,D);this.addChild(this.map);this.addEventListener("enterframe",this.update);this.cursor=new o(144,144);this.cursor.setImage("cursor0.png");cursor.x=i.WIDTH-144/2;cursor.y=i.HEIGHT-144/2;this.metricPK=z;B=document.getElementById("enchant-stage");B.scene=this;if(this.mode===f.Play){B.addEventListener("mousemove",this.updateMousePosition);B.addEventListener("mousedown",this.onMousePressed)}B.oncontextmenu=function(){return false};this.addChild(this.cursor);this.rotationSet=void 0;this.state=l.Main;this.prevTile=void 0}x.prototype.setup=function(){return this};x.prototype.update=function(A){var z;if(this.state===l.Rotation){if(this.rotationSet.isEnd()){this.rotationSet=void 0;this.state=l.Move;z=this.map.globalToLocal(this.map.player.x,this.map.player.y);this.prevTile=this.map.getTile(z.x,z.y);if(!this.moveNext(this.map.player,this.map.player.direction)){return this.state=l.Main}}}else{if(this.state===l.Move){if(!this.map.player.isMoving()){return this.onMoveCompleted()}}}};x.prototype.onMoveCompleted=function(){var z,C,A,B;z=this.map.globalToLocal(this.map.player.getPosition().x,this.map.player.getPosition().y);A=this.map.getTile(z.x,z.y);if((B=this.prevTile)!=null){B.onAfterMove(this.map.player.direction)}if(!(A!=null)||A.isDangerous(this.map.player.direction)){this.state=l.GameOver;if(this.mode===f.Play){C=this;return new w("/metrics/"+this.metricPK+"/update",{state:2},function(D){var E;console.log(D);if(confirm("ゲームオーバー もう一度プレイしますか？")){E=new c();E.setup(C.metricPK);return t.game.replaceScene(E)}else{return location.href="/"}})}}else{if(A.getTileType()===d.Goal){this.state=l.Goal;if(this.mode===f.Play){C=this;return new w("/metrics/"+this.metricPK+"/update",{state:1},function(D){console.log(D);if(confirm("ステージクリア！他のステージを遊びますか？")){return $.get("/levels/json?ignore="+C.metricPK,{},function(E){var G,F;console.log(E);F=E;G=new c();G.setup(C.metricPK,E);return t.game.replaceScene(G)})}})}}else{if(A.type===d.Ice){if(!this.moveNext(this.map.player,this.map.player.direction)){return this.state=l.Main}}else{return this.state=l.Main}}}};x.prototype.moveNext=function(A,C){var B,z;B=this.map.getPointWithDirection(this.map.globalToLocal(A.x,A.y),C);z=this.map.getTile(B.x,B.y);if(!(z!=null)||((z!=null)&&z.isWalkable(C))){this.moveTo(A,C,10);return true}return false};x.prototype.updateMousePosition=function(A){var B,z;B=this.scene.cursor;z=this.scene.map.globalToLocal(A.clientX,A.clientY);B.x=i.WIDTH*z.x-144/2;return B.y=i.HEIGHT*z.y-144/2};x.prototype.onMousePressed=function(A){var C,B,z;z=this.scene.map.globalToLocal(A.clientX,A.clientY).sub(new a(1,1));if(this.scene.map.canRotate(z.x,z.y)){B=false;if(A.button===0){C=k.Left;B=this.scene.rotate(z,k.Left)}else{C=k.Right;B=this.scene.rotate(z,k.Right)}if(B&&this.mode===f.Play){new w("/operations/create",{metric:this.scene.metricPK,x:z.x,y:z.y,direction:C},function(D){return console.log(D)});return true}}return false};x.prototype.rotate=function(z,A){var B;if(this.state===l.Main){B=this.map.rotate(z.x,z.y,A);if(B!==null){this.rotationSet=B;this.map.addChild(B);this.state=l.Rotation;return true}}return false};x.prototype.moveTo=function(B,C,D){var F,A,z,E;if(h.call(this.map.characters,B)>=0){A=this.map.globalToLocal(B.x,B.y);F=this.map.localToGlobal(A.x,A.y);z=this.map.getPointWithDirection(A,C);E=this.map.localToGlobal(z.x,z.y);return B.setMoveAnimation(F,E,D)}};return x})(Scene);c=(function(y){v(x,y);function x(){return x.__super__.constructor.apply(this,arguments)}x.prototype.setup=function(z,B){var D,C,A;if(B==null){B=void 0}if(B!=null){C=B.pk;A="/levels/"+C+"/json";$("#stage_url").attr("stageurl",A)}else{A=$("#stage_url").attr("stageurl");C=A.match(/[0-9]+/)[0]}D=$("#metric_url");return $.getJSON(A,{},function(F){var E,G;if(D.size()>0){E=D.attr("metricurl");return t.game.replaceScene(new u(F.stage_data,void 0,f.Metric),E)}else{G={stage:C};if(z!=null){G.pre_metric=z}return new w("/metrics/create",G,function(H){var I;I=H.pk;return t.game.replaceScene(new u(F.stage_data,I),f.Play)})}})};return x})(Scene)}).call(this);