(function(){var d,a,m,k,o,c,r,s,i,f,p,j,h,l,e,q,b,n={}.hasOwnProperty,t=function(x,v){for(var u in v){if(n.call(v,u)){x[u]=v[u]}}function w(){this.constructor=x}w.prototype=v.prototype;x.prototype=new w();x.__super__=v.prototype;return x},g=[].indexOf||function(w){for(var v=0,u=this.length;v<u;v++){if(v in this&&this[v]===w){return v}}return -1};b=(function(){function u(v,w){if(v==null){v=0}if(w==null){w=0}this.set(v,w)}u.prototype.set=function(v,w){if(v==null){v=0}if(w==null){w=0}this.x=v;this.y=w;return this};u.prototype.add=function(w){this.x+=w.x;this.y+=w.y;return this};u.prototype.sub=function(w){this.x-=w.x;this.y-=w.y;return this};u.prototype.scale=function(v){this.x*=v;this.y*=v;return this};u.prototype.div=function(v){this.x/=v;this.y/=v;return this};u.prototype.product=function(w){return this.x*w.x+this.y*w.y};u.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};u.prototype.resize=function(v){if(this.length()){this.scale(v/this.length())}return this};u.prototype.normalize=function(){return this.resize(1)};u.prototype.angle=function(){return(180*Math.atan2(this.y,this.x))/Math.PI};u.prototype.rotate=function(A){var w,z,v,B;w=(A*Math.PI)/180;z=this.length();v=this.x;B=this.y;this.x=Math.sin(w)*B+Math.cos(w)*v;this.y=Math.cos(w)*B-Math.sin(w)*v;return this.resize(z)};u.prototype.clone=function(){return new u(this.x,this.y)};u.prototype.reverse=function(){this.x*=-1;this.y*=-1;return this};u.prototype.max=function(v){if(this.length()<=v){return this}return this.resize(v)};u.prototype.min=function(v){if(this.length()>=v){return this}return this.resize(v)};u.prototype.isZero=function(){return this.x===0&&this.y===0};return u})();Array.prototype._index=function(u){var v;if(u<0){v=this.length;return v+u}return u};Array.prototype.at=function(u){return this[this._index(u)]};Array.prototype.map=function(u){var w,v;return([].splice.apply(this,[0,this.length-0].concat(v=(function(){var z,y,x;x=[];for(z=0,y=this.length;z<y;z++){w=this[z];x.push(u(w))}return x}).call(this))),v)};Array.prototype.clone=function(){return this.dup()};Array.prototype.dup=function(){return this.slice(0,this.length)};Array.prototype.each=function(v){var u,x,w;for(u=x=0,w=this.length;0<=w?x<w:x>w;u=0<=w?++x:--x){v(this[u],u)}return this};Array.prototype.deleteAt=function(u){u=this._index(u);if(u>=this.length){return void 0}return this.splice(u,1)};Array.prototype.deleteIf=function(v){var u;return this.replace((function(){var y,x,w;w=[];for(u=y=0,x=this.length;0<=x?y<x:y>x;u=0<=x?++y:--y){if(!v(this[u],u)){w.push(this[u])}}return w}).call(this))};Array.prototype.reject=function(u){var v;v=this.length;this.deleteIf(u);if(v===this.length){return void 0}return this};Array.prototype.isEmpty=function(){return this.length===0};Array.prototype.isEql=function(u,y){var v,x,w;if(y==null){y=function(A,z){return A===z}}if(this.length!==u.length){return false}for(v=x=0,w=this.length;0<=w?x<w:x>w;v=0<=w?++x:--x){if(!y(this[v],u[v])){return false}}return true};Array.prototype.fill=function(x,y,u){var v,w;if(y==null){y=0}if(u==null){u=this.length-1}y=this._index(y);u=this._index(u);[].splice.apply(this,[y,u-y+1].concat(w=(function(){var A,z;z=[];for(v=A=y;y<=u?A<=u:A>=u;v=y<=u?++A:--A){z.push(x)}return z})())),w;return this};Array.prototype.first=function(){return this[0]};Array.prototype.last=function(){var u;u=this._index(-1);return this[u]};Array.prototype.uniq=function(y){var x,w,v,u;if(y==null){y=function(A,z){return A===z}}x=[];for(v=0,u=this.length;v<u;v++){w=this[v];if(!x.isInclude(w,y)){x.push(w)}}return this.replace(x)};Array.prototype.index=function(x,y){var u,w,v;if(y==null){y=function(A,z){return A===z}}for(u=w=0,v=this.length;0<=v?w<v:w>v;u=0<=v?++w:--w){if(y(this[u],x)){return u}}return void 0};Array.prototype.indexes=function(){var w,x,v,u;u=[];for(x=0,v=arguments.length;x<v;x++){w=arguments[x];u.push(this.at(w))}return u};Array.prototype.rindex=function(x,y){var u,w,v;if(y==null){y=function(A,z){return A===z}}for(u=w=v=this.length;v<=0?w<0:w>0;u=v<=0?++w:--w){if(y(this[u],x)){return u}}return void 0};Array.prototype.flatten=function(){return this.replace(this.reduce(function(v,u){return v.concat(u instanceof Array?u.flatten():u)},[]))};Array.prototype.transpose=function(){var B,A,z,v,u,E,D,C;v=this.isEmpty()?0:this.length;B=this.first() instanceof Array?this.first().length:0;if(!v||!B){return this}z=(function(){var x,w;w=[];for(A=x=0;0<=B?x<B:x>B;A=0<=B?++x:--x){w.push([])}return w})();for(u=D=0;0<=v?D<v:D>v;u=0<=v?++D:--D){for(E=C=0;0<=B?C<B:C>B;E=0<=B?++C:--C){z[E][u]=this[u][E]}}return this.replace(z)};Array.prototype.compact=function(){return this.deleteIf(function(u){return u===void 0})};Array.prototype.isInclude=function(x,y){var v,w,u;if(y==null){y=function(A,z){return A===z}}for(w=0,u=this.length;w<u;w++){v=this[w];if(y(v,x)){return true}}return false};Array.prototype.size=function(){return this.length};Array.prototype.swap=function(v,u){var w;v=this._index(v);u=this._index(u);w=this[v];this[v]=this[u];this[u]=w;return this};Array.prototype.shuffle=function(){var u,w,v;for(u=w=0,v=this.length;0<=v?w<v:w>v;u=0<=v?++w:--w){this.swap(u,Math.floor(Math.random()*this.length))}return this};Array.prototype.choice=function(){return this[Math.floor(Math.random()*this.length)]};Array.prototype.count=function(y,z){var u,v,x,w;if(z==null){z=function(B,A){return B===A}}v=0;for(u=x=0,w=this.length;0<=w?x<w:x>w;u=0<=w?++x:--x){if(z(this[u],y)){++v}}return v};Array.prototype.replace=function(u){var w,x,v;this.clear();for(x=0,v=u.length;x<v;x++){w=u[x];this.push(w)}return this};Array.prototype.nitems=function(){return this.clone().compact().size()};Array.prototype.insert=function(){var w,x,v,u,z,y;w=Array.prototype.slice.call(arguments,0,arguments.length);if(w.size()<=1){return this}v=this._index(w[0]);u=w.slice(1,this.length);for(x=z=0,y=u.length;0<=y?z<y:z>y;x=0<=y?++z:--z){this.splice(v+x,0,u[x])}return this};Array.prototype.clear=function(){var u;u=[];while(!this.isEmpty()){u.push(this.deleteAt(0))}return u};Array.prototype.max=function(v){var u;if(v==null){v=function(x,w){if(x===w){return 0}if(x<w){return -1}else{return 1}}}u=this.first();this.reduce(function(x,w){if(v(u,w)<0){return u=w}});return u};Array.prototype.min=function(v){var u;if(v==null){v=function(x,w){if(x===w){return 0}if(x<w){return -1}else{return 1}}}u=this.first();this.reduce(function(x,w){if(v(u,w)>=0){return u=w}});return u};q=(function(){function u(v,x,z,y,w){if(x==null){x=false}if(z==null){z=0}if(y==null){y=false}if(w==null){w=void 0}this.set(v);this._time=z;this._active=y;this._onComplete=w;this._onUpdate=void 0;this._repeat=x}u.prototype.set=function(v){if(v==null){v=0}this._max=v;return this};u.prototype.play=function(){this._active=true;return this};u.prototype.stop=function(){this._active=false;this._time=0;return this};u.prototype.pause=function(){this._active=false;return this};u.prototype.reset=function(){this._time=0;return this};u.prototype.tick=function(){if(this._time<this._max&&this._active){++this._time;if(this._onUpdate!=null){this._onUpdate(this)}if(this._time===this._max){if(this._onComplete!=null){this._onComplete(this)}if(this._repeat){this._time=0}}}return this};u.prototype.now=function(){return this._time};u.prototype.max=function(){return this._max};u.prototype.setNow=function(v){this._time=v;return this};u.prototype.setOnComplete=function(v){this._onComplete=v;return this};u.prototype.setOnUpdate=function(v){return this._onUpdate=v};u.prototype.setRepeat=function(v){this._repeat=v;return this};u.prototype.isActive=function(){return this._active};u.prototype.isOver=function(){return this._time>=this._max};return u})();o=(function(){function u(){}u._sounds=[];u.root="";u.load=function(){var z,v,y,x,w;v=Array.prototype.slice.call(arguments);w=[];for(y=0,x=v.length;y<x;y++){z=v[y];w.push(u._loadSound(z))}return w};u.play=function(v){if(!(u._sounds[v]!=null)){u._loadSound(v)}u.stop(v);return u._sounds[v].play()};u.pause=function(v){if(v!=null){return u._sounds[v].pause()}};u.stop=function(v){if(v!=null){return u._sounds[v].stop()}};u._loadSound=function(w,v){if(!(u._sounds[w]!=null)){if(v!=null){return u._sounds[w]=Sound.load(""+u.root+w,v)}else{return u._sounds[w]=Sound.load(""+u.root+w)}}};return u})();enchant();r=(function(v){t(u,v);u.prototype.config={WIDTH:640,HEIGHT:480,FPS:30,FONT:"Helvetica",IMAGE_PATH:"/image/",IMAGES:["kawaz.png","characters/player.png","chips/grass.png","cursor0.png"],SOUND_PATH:"/sound/",SOUNDS:[],INITIAL_LEVEL:1,LAST_LEVEL:7,LEVEL_TIME:30};function u(){var A,x,z,w,y;u.__super__.constructor.call(this,this.config.WIDTH,this.config.HEIGHT);this.fps=this.config.FPS;this.keybind(90,"a");this.keybind(88,"b");u.game=this;u.config=this.config;y=this.config.IMAGES;for(z=0,w=y.length;z<w;z++){A=y[z];this.preload(""+this.config.IMAGE_PATH+A)}x=new c();this.onload=function(){x.setup();return this.pushScene(x)};this.start()}return u})(Game);window.onload=function(){return new r()};m=(function(u){t(v,u);function v(A,B,z,C){if(z==null){z=0}if(C==null){C=0}v.__super__.constructor.call(this,A,B);this.removeEventListener("enterframe");this.x=z;this.y=C;this.velocity=new b();this.speed=7}v.prototype.update=function(w){this.x+=this.velocity.x;return this.y+=this.velocity.y};v.prototype.setImage=function(w){return this.image=r.game.assets[""+r.config.IMAGE_PATH+w]};v.prototype.getPosition=function(){return new b(this.x,this.y)};v.prototype.getCenter=function(){return new b(this.x+this.width/2,this.y+this.height/2)};v.prototype.setPosition=function(w){this.x=w.x;return this.y=w.y};return v})(Sprite);f=(function(u){t(v,u);function v(x,y){v.__super__.constructor.call(this,x,y);this.addEventListener("enterframe",this.update)}v.prototype.update=function(y){var x,w;if((x=this.timer)!=null){x.tick()}if((w=this.timer)!=null?w.isOver():void 0){return this}};v.prototype.setMoveAnimation=function(z,y,x){var w;if(!(this.timer!=null)||this.timer.isOver()){this.timer=new q(x);this.timer.play();w=this;this.timer.setOnUpdate(function(){var A,B;A=y.clone().sub(z);B=A.div(x);w.x+=B.x;return w.y+=B.y});return this.timer.setOnComplete(function(){return w.setPosition(y)})}};v.prototype.isMoving=function(){var w;return(this.timer!=null)&&!((w=this.timer)!=null?w.isOver():void 0)};return v})(m);a={Up:0,Right:1,Down:2,Left:3};d=(function(u){t(v,u);function v(w){v.__super__.constructor.call(this,48,48);this.maxFrame=w;this.fps=10;this.setDirection(a.Right)}v.prototype.setDirection=function(E){var C,B,z,D,y,x,A,w;E=(E+4)%4;D=this.maxFrame*((E+2)%4);C=[];for(B=y=D,A=D+this.maxFrame;D<=A?y<A:y>A;B=D<=A?++y:--y){for(z=x=0,w=this.fps;0<=w?x<w:x>w;z=0<=w?++x:--x){C.push(B)}}this.frame=C;return this.direction=E};return v})(f);p=(function(v){t(u,v);function u(){u.__super__.constructor.call(this,3);this.setImage("characters/player.png");this.setDirection(a.Up)}return u})(d);e={None:0,Floor:1,Wall:2};h=(function(v){t(u,v);u.WIDTH=48;u.HEIGHT=48;function u(x,w){u.__super__.constructor.call(this,u.WIDTH,u.HEIGHT);this.setImage("chips/grass.png");this.direction=0;this.addEventListener("enterframe",this.update);this.localX=x;this.localY=w;this.x=x*u.WIDTH;this.y=w*u.HEIGHT}u.prototype.update=function(w){return this.rotaiton=this.direction*90};return u})(m);j={Left:0,Right:1};l=(function(v){t(u,v);u.speed=10;function u(N,G,E,L){var K,I,J,P,O,H,B,z,M,Q,F,D,C,A;u.__super__.constructor.call(this);this.map=N;this.lu=this.map.getTile(G,E);this.ld=this.map.getTile(G,E+1);this.ru=this.map.getTile(G+1,E);this.rd=this.map.getTile(G+1,E+1);this.root=this.lu.getPosition().clone();this.end=this.lu.getPosition().clone().add(new b(h.WIDTH*2,h.HEIGHT*2));F=[this.lu,this.ld,this.ru,this.rd];for(B=0,M=F.length;B<M;B++){J=F[B];J.parentNode.removeChild(J);this.addChild(J);J.x-=this.root.x;J.y-=this.root.y}this.objects=[];D=this.map.objects;for(z=0,Q=D.length;z<Q;z++){P=D[z];if((this.root.x<=(C=P.x)&&C<this.end.x)&&(this.root.y<=(A=P.y)&&A<this.end.y)){I=this.map.globalToLocal(P.getPosition().x,P.getPosition().y);O=this.map.getTile(I.x,I.y);this.objects.push([P,O]);this.map.objectLayer.removeChild(P);this.addChild(P);P.setPosition(this.globalToNodePosition(P.getPosition()))}}H=h.WIDTH;K=h.HEIGHT;this.originX=H;this.originY=K;this.x=this.root.x;this.y=this.root.y;this.count=0;this.direction=L;this.addEventListener("enterframe",this.update)}u.prototype.update=function(E){var D,I,A,H,G,x,F,B,z,J,w,C,y;if(!this.isEnd()){if(this.direction===j.Left){x=-u.speed}else{x=u.speed}this.rotation+=x;this.count+=1}if(this.isEnd()){if(this.direction===j.Left){I=this.map.globalToLocal(this.root.x,this.root.y);H=I.x;G=I.y;this.map.setTile(H,G+1,this.lu);this.map.setTile(H,G,this.ru);this.map.setTile(H+1,G,this.rd);this.map.setTile(H+1,G+1,this.ld)}else{this.map.setTile(H,G+1,this.rd);this.map.setTile(H,G,this.ld);this.map.setTile(H+1,G,this.lu);this.map.setTile(H+1,G+1,this.ru)}C=[this.lu,this.ld,this.ru,this.rd];for(B=0,J=C.length;B<J;B++){F=C[B];F.rotation=0;F.originX=h.WIDTH*0.5;F.originY=h.HEIGHT*0.5;F.direction=(F.direction+1)%4;this.removeChild(F);this.map.tileLayer.addChild(F)}y=this.objects;for(z=0,w=y.length;z<w;z++){D=y[z];A=D[0];F=D[1];this.removeChild(A);this.map.objectLayer.addChild(A);if(this.direction===j.Left){A.setDirection(A.direction-1)}else{A.setDirection(A.direction+1)}A.setPosition(F.getPosition())}return this.map.removeChild(this)}};u.prototype.isEnd=function(){return this.count>=90/u.speed};u.prototype.globalToNodePosition=function(w){return w.clone().sub(this.root)};u.prototype.nodeToGlobalPosition=function(w){return w.clone().add(this.root)};return u})(Group);i=(function(v){t(u,v);function u(A,z){var C,w,E,D,B;u.__super__.constructor.apply(this,arguments);this.tileLayer=new Group();this.objectLayer=new Group();this.addChild(this.tileLayer);this._map=[];for(w=D=0;0<=A?D<A:D>A;w=0<=A?++D:--D){this._map.push([]);for(E=B=0;0<=z?B<z:B>z;E=0<=z?++B:--B){C=new h(w,E);this._map[w].push(C);this.tileLayer.addChild(C)}}this.width=A;this.height=z;this.player=new p();this.player.setPosition(this.localToGlobal(1,1));this.characters=[this.player];this.objects=[this.player];this.addChild(this.objectLayer);this.objectLayer.addChild(this.player)}u.prototype.getTile=function(w,z){return this._map[w][z]};u.prototype.setTile=function(w,B,A){var z;z=this.localToGlobal(w,B);A.localX=w;A.localY=B;A.x=z.x;A.y=z.y;return this._map[w][B]=A};u.prototype.rotate=function(F,D,E){var C,z,B,I,A,H,G;if(F<0||F>=this.width-1||D<0||D>=this.height){return null}B=this.getTile(F,D);z=this.getTile(F,D+1);A=this.getTile(F+1,D);I=this.getTile(F+1,D+1);G=B.width;C=B.height;H=new l(this,F,D,E);return H};u.prototype.localToGlobal=function(w,z){return new b(w*h.WIDTH,z*h.HEIGHT)};u.prototype.globalToLocal=function(w,z){return new b(Math.floor(w/h.WIDTH),Math.floor(z/h.HEIGHT))};u.prototype.getPointWithDirection=function(w,x){switch(x){case a.Up:return new b(w.x,w.y-1);case a.Left:return new b(w.x-1,w.y);case a.Down:return new b(w.x,w.y+1);case a.Right:return new b(w.x+1,w.y)}};return u})(Group);k={Ready:0,Main:1,Rotation:2,Move:3,Goal:4};s=(function(v){t(u,v);function u(){var w;u.__super__.constructor.apply(this,arguments);this.map=new i(10,10);this.addChild(this.map);this.addEventListener("enterframe",this.update);this.cursor=new m(144,144);this.cursor.setImage("cursor0.png");this.cursor.x=0;this.cursor.y=100;w=document.getElementById("enchant-stage");w.scene=this;w.addEventListener("mousemove",this.updateMousePosition);this.addEventListener("touchstart",this.onMousePressed);this.addChild(this.cursor);this.rotationSet=void 0;this.state=k.Main}u.prototype.setup=function(){return this};u.prototype.update=function(w){if(this.state===k.Rotation){if(this.rotationSet.isEnd()){this.rotationSet=void 0;this.state=k.Move;return this.moveTo(this.map.player,this.map.player.direction,10)}}else{if(this.state===k.Move){if(!this.map.player.isMoving()){return this.state=k.Main}}}};u.prototype.updateMousePosition=function(x){var y,w;y=this.scene.cursor;w=this.scene.map.globalToLocal(x.clientX,x.clientY);y.x=h.WIDTH*w.x-144/2;return y.y=h.HEIGHT*w.y-144/2};u.prototype.onMousePressed=function(x){var w;w=this.map.globalToLocal(x.x,x.y).sub(new b(1,1));return this.rotate(w,j.Left)};u.prototype.rotate=function(w,x){var y;if(this.state===k.Main){y=this.map.rotate(w.x,w.y,x);if(y!==null){this.rotationSet=y;this.map.addChild(y);return this.state=k.Rotation}}};u.prototype.moveTo=function(y,z,A){var C,x,w,B;if(g.call(this.map.characters,y)>=0){x=this.map.globalToLocal(y.x,y.y);C=this.map.localToGlobal(x.x,x.y);w=this.map.getPointWithDirection(x,z);B=this.map.localToGlobal(w.x,w.y);return y.setMoveAnimation(C,B,A)}};return u})(Scene);c=(function(v){t(u,v);function u(){return u.__super__.constructor.apply(this,arguments)}u.prototype.setup=function(){this.kawaz=new m(253,81);this.kawaz.setImage("kawaz.png");this.kawaz.x=193.5;this.kawaz.y=220;this.kawaz.opacity=0;this.addChild(this.kawaz);this.addEventListener("enterframe",this.update);this.timer=new q(180);this.timer.setOnComplete(function(){r.game.replaceScene(new s());return this});return this.timer.play()};u.prototype.update=function(){if(r.game.input.a){r.game.replaceScene(new s());this}this.timer.tick();if(this.timer.now()<60){return this.kawaz.opacity+=1/60}else{if(this.timer.now()>120){return this.kawaz.opacity-=1/60}}};return u})(Scene)}).call(this);