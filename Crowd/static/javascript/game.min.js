(function(){var e,b,f,o,l,r,c,u,v,j,g,p,s,x,k,n,i,m,d,t,a,q={}.hasOwnProperty,w=function(B,z){for(var y in z){if(q.call(z,y)){B[y]=z[y]}}function A(){this.constructor=B}A.prototype=z.prototype;B.prototype=new A();B.__super__=z.prototype;return B},h=[].indexOf||function(A){for(var z=0,y=this.length;z<y;z++){if(z in this&&this[z]===A){return z}}return -1};a=(function(){function y(z,A){if(z==null){z=0}if(A==null){A=0}this.set(z,A)}y.prototype.set=function(z,A){if(z==null){z=0}if(A==null){A=0}this.x=z;this.y=A;return this};y.prototype.add=function(z){this.x+=z.x;this.y+=z.y;return this};y.prototype.sub=function(z){this.x-=z.x;this.y-=z.y;return this};y.prototype.scale=function(z){this.x*=z;this.y*=z;return this};y.prototype.div=function(z){this.x/=z;this.y/=z;return this};y.prototype.product=function(z){return this.x*z.x+this.y*z.y};y.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};y.prototype.resize=function(z){if(this.length()){this.scale(z/this.length())}return this};y.prototype.normalize=function(){return this.resize(1)};y.prototype.angle=function(){return(180*Math.atan2(this.y,this.x))/Math.PI};y.prototype.rotate=function(C){var A,B,z,D;A=(C*Math.PI)/180;B=this.length();z=this.x;D=this.y;this.x=Math.sin(A)*D+Math.cos(A)*z;this.y=Math.cos(A)*D-Math.sin(A)*z;return this.resize(B)};y.prototype.clone=function(){return new y(this.x,this.y)};y.prototype.reverse=function(){this.x*=-1;this.y*=-1;return this};y.prototype.max=function(z){if(this.length()<=z){return this}return this.resize(z)};y.prototype.min=function(z){if(this.length()>=z){return this}return this.resize(z)};y.prototype.isZero=function(){return this.x===0&&this.y===0};return y})();Array.prototype._index=function(y){var z;if(y<0){z=this.length;return z+y}return y};Array.prototype.at=function(y){return this[this._index(y)]};Array.prototype.map=function(y){var A,z;return([].splice.apply(this,[0,this.length-0].concat(z=(function(){var D,C,B;B=[];for(D=0,C=this.length;D<C;D++){A=this[D];B.push(y(A))}return B}).call(this))),z)};Array.prototype.clone=function(){return this.dup()};Array.prototype.dup=function(){return this.slice(0,this.length)};Array.prototype.each=function(z){var y,B,A;for(y=B=0,A=this.length;0<=A?B<A:B>A;y=0<=A?++B:--B){z(this[y],y)}return this};Array.prototype.deleteAt=function(y){y=this._index(y);if(y>=this.length){return void 0}return this.splice(y,1)};Array.prototype.deleteIf=function(z){var y;return this.replace((function(){var C,B,A;A=[];for(y=C=0,B=this.length;0<=B?C<B:C>B;y=0<=B?++C:--C){if(!z(this[y],y)){A.push(this[y])}}return A}).call(this))};Array.prototype.reject=function(y){var z;z=this.length;this.deleteIf(y);if(z===this.length){return void 0}return this};Array.prototype.isEmpty=function(){return this.length===0};Array.prototype.isEql=function(y,C){var z,B,A;if(C==null){C=function(E,D){return E===D}}if(this.length!==y.length){return false}for(z=B=0,A=this.length;0<=A?B<A:B>A;z=0<=A?++B:--B){if(!C(this[z],y[z])){return false}}return true};Array.prototype.fill=function(B,C,y){var z,A;if(C==null){C=0}if(y==null){y=this.length-1}C=this._index(C);y=this._index(y);[].splice.apply(this,[C,y-C+1].concat(A=(function(){var E,D;D=[];for(z=E=C;C<=y?E<=y:E>=y;z=C<=y?++E:--E){D.push(B)}return D})())),A;return this};Array.prototype.first=function(){return this[0]};Array.prototype.last=function(){var y;y=this._index(-1);return this[y]};Array.prototype.uniq=function(C){var B,A,z,y;if(C==null){C=function(E,D){return E===D}}B=[];for(z=0,y=this.length;z<y;z++){A=this[z];if(!B.isInclude(A,C)){B.push(A)}}return this.replace(B)};Array.prototype.index=function(B,C){var y,A,z;if(C==null){C=function(E,D){return E===D}}for(y=A=0,z=this.length;0<=z?A<z:A>z;y=0<=z?++A:--A){if(C(this[y],B)){return y}}return void 0};Array.prototype.indexes=function(){var A,B,z,y;y=[];for(B=0,z=arguments.length;B<z;B++){A=arguments[B];y.push(this.at(A))}return y};Array.prototype.rindex=function(B,C){var y,A,z;if(C==null){C=function(E,D){return E===D}}for(y=A=z=this.length;z<=0?A<0:A>0;y=z<=0?++A:--A){if(C(this[y],B)){return y}}return void 0};Array.prototype.flatten=function(){return this.replace(this.reduce(function(z,y){return z.concat(y instanceof Array?y.flatten():y)},[]))};Array.prototype.transpose=function(){var D,C,B,A,z,G,F,E;A=this.isEmpty()?0:this.length;D=this.first() instanceof Array?this.first().length:0;if(!A||!D){return this}B=(function(){var H,y;y=[];for(C=H=0;0<=D?H<D:H>D;C=0<=D?++H:--H){y.push([])}return y})();for(z=F=0;0<=A?F<A:F>A;z=0<=A?++F:--F){for(G=E=0;0<=D?E<D:E>D;G=0<=D?++E:--E){B[G][z]=this[z][G]}}return this.replace(B)};Array.prototype.compact=function(){return this.deleteIf(function(y){return y===void 0})};Array.prototype.isInclude=function(B,C){var z,A,y;if(C==null){C=function(E,D){return E===D}}for(A=0,y=this.length;A<y;A++){z=this[A];if(C(z,B)){return true}}return false};Array.prototype.size=function(){return this.length};Array.prototype.swap=function(z,y){var A;z=this._index(z);y=this._index(y);A=this[z];this[z]=this[y];this[y]=A;return this};Array.prototype.shuffle=function(){var y,A,z;for(y=A=0,z=this.length;0<=z?A<z:A>z;y=0<=z?++A:--A){this.swap(y,Math.floor(Math.random()*this.length))}return this};Array.prototype.choice=function(){return this[Math.floor(Math.random()*this.length)]};Array.prototype.count=function(C,D){var y,z,B,A;if(D==null){D=function(F,E){return F===E}}z=0;for(y=B=0,A=this.length;0<=A?B<A:B>A;y=0<=A?++B:--B){if(D(this[y],C)){++z}}return z};Array.prototype.replace=function(y){var A,B,z;this.clear();for(B=0,z=y.length;B<z;B++){A=y[B];this.push(A)}return this};Array.prototype.nitems=function(){return this.clone().compact().size()};Array.prototype.insert=function(){var A,B,z,y,D,C;A=Array.prototype.slice.call(arguments,0,arguments.length);if(A.size()<=1){return this}z=this._index(A[0]);y=A.slice(1,this.length);for(B=D=0,C=y.length;0<=C?D<C:D>C;B=0<=C?++D:--D){this.splice(z+B,0,y[B])}return this};Array.prototype.clear=function(){var y;y=[];while(!this.isEmpty()){y.push(this.deleteAt(0))}return y};Array.prototype.max=function(z){var y;if(z==null){z=function(B,A){if(B===A){return 0}if(B<A){return -1}else{return 1}}}y=this.first();this.reduce(function(B,A){if(z(y,A)<0){return y=A}});return y};Array.prototype.min=function(z){var y;if(z==null){z=function(B,A){if(B===A){return 0}if(B<A){return -1}else{return 1}}}y=this.first();this.reduce(function(B,A){if(z(y,A)>=0){return y=A}});return y};t=(function(){function y(z,B,D,C,A){if(B==null){B=false}if(D==null){D=0}if(C==null){C=false}if(A==null){A=void 0}this.set(z);this._time=D;this._active=C;this._onComplete=A;this._onUpdate=void 0;this._repeat=B}y.prototype.set=function(z){if(z==null){z=0}this._max=z;return this};y.prototype.play=function(){this._active=true;return this};y.prototype.stop=function(){this._active=false;this._time=0;return this};y.prototype.pause=function(){this._active=false;return this};y.prototype.reset=function(){this._time=0;return this};y.prototype.tick=function(){if(this._time<this._max&&this._active){++this._time;if(this._onUpdate!=null){this._onUpdate(this)}if(this._time===this._max){if(this._onComplete!=null){this._onComplete(this)}if(this._repeat){this._time=0}}}return this};y.prototype.now=function(){return this._time};y.prototype.max=function(){return this._max};y.prototype.setNow=function(z){this._time=z;return this};y.prototype.setOnComplete=function(z){this._onComplete=z;return this};y.prototype.setOnUpdate=function(z){return this._onUpdate=z};y.prototype.setRepeat=function(z){this._repeat=z;return this};y.prototype.isActive=function(){return this._active};y.prototype.isOver=function(){return this._time>=this._max};return y})();r=(function(){function y(){}y._sounds=[];y.root="";y.load=function(){var D,z,C,B,A;z=Array.prototype.slice.call(arguments);A=[];for(C=0,B=z.length;C<B;C++){D=z[C];A.push(y._loadSound(D))}return A};y.play=function(z){if(!(y._sounds[z]!=null)){y._loadSound(z)}y.stop(z);return y._sounds[z].play()};y.pause=function(z){if(z!=null){return y._sounds[z].pause()}};y.stop=function(z){if(z!=null){return y._sounds[z].stop()}};y._loadSound=function(A,z){if(!(y._sounds[A]!=null)){if(z!=null){return y._sounds[A]=Sound.load(""+y.root+A,z)}else{return y._sounds[A]=Sound.load(""+y.root+A)}}};return y})();enchant();u=(function(z){w(y,z);y.prototype.config={WIDTH:640,HEIGHT:480,FPS:30,FONT:"Helvetica",IMAGE_PATH:"/image/",IMAGES:["kawaz.png","characters/player.png","chips/grass/ground.png","chips/grass/goal.png","chips/grass/hole.png","chips/grass/rock.png","chips/cave/ground.png","chips/cave/goal.png","chips/cave/hole.png","chips/cave/rock.png","chips/cave/needle.png","chips/cave/broken.png","chips/ice.png","chips/none.png","cursor0.png"],SOUND_PATH:"/sound/",SOUNDS:[],INITIAL_LEVEL:1,LAST_LEVEL:7,LEVEL_TIME:30};function y(){var E,B,D,A,C;y.__super__.constructor.call(this,this.config.WIDTH,this.config.HEIGHT);this.fps=this.config.FPS;this.keybind(90,"a");this.keybind(88,"b");y.game=this;y.config=this.config;C=this.config.IMAGES;for(D=0,A=C.length;D<A;D++){E=C[D];this.preload(""+this.config.IMAGE_PATH+E)}B=new c();this.onload=function(){B.setup();return this.pushScene(B)};this.start()}return y})(Game);window.onload=function(){return new u()};x=(function(){y.CSRF="csrfmiddlewaretoken";function y(A,z,C){var B;B=$("input[name="+y.CSRF+"]").val();z[y.CSRF]=B;$.post(A,z,C)}return y})();o=(function(y){w(z,y);function z(B,C,A,D){if(A==null){A=0}if(D==null){D=0}z.__super__.constructor.call(this,B,C);this.removeEventListener("enterframe");this.x=A;this.y=D;this.velocity=new a();this.speed=7}z.prototype.update=function(A){this.x+=this.velocity.x;return this.y+=this.velocity.y};z.prototype.setImage=function(A){return this.image=u.game.assets[""+u.config.IMAGE_PATH+A]};z.prototype.getPosition=function(){return new a(this.x,this.y)};z.prototype.getCenter=function(){return new a(this.x+this.width/2,this.y+this.height/2)};z.prototype.setPosition=function(A){this.x=A.x;return this.y=A.y};return z})(Sprite);g=(function(y){w(z,y);function z(A,B){z.__super__.constructor.call(this,A,B);this.addEventListener("enterframe",this.update)}z.prototype.update=function(C){var B,A;if((B=this.timer)!=null){B.tick()}if((A=this.timer)!=null?A.isOver():void 0){return this}};z.prototype.setMoveAnimation=function(D,C,B){var A;if(!(this.timer!=null)||this.timer.isOver()){this.timer=new t(B);this.timer.play();A=this;this.timer.setOnUpdate(function(){var E,F;E=C.clone().sub(D);F=E.div(B);A.x+=F.x;return A.y+=F.y});return this.timer.setOnComplete(function(){return A.setPosition(C)})}};z.prototype.isMoving=function(){var A;return(this.timer!=null)&&!((A=this.timer)!=null?A.isOver():void 0)};return z})(o);b={Up:0,Right:1,Down:2,Left:3};e=(function(y){w(z,y);function z(A){z.__super__.constructor.call(this,48,48);this.maxFrame=A;this.fps=10;this.setDirection(b.Right)}z.prototype.setDirection=function(I){var G,F,D,H,C,B,E,A;I=(I+4)%4;H=this.maxFrame*((I+2)%4);G=[];for(F=C=H,E=H+this.maxFrame;H<=E?C<E:C>E;F=H<=E?++C:--C){for(D=B=0,A=this.fps;0<=A?B<A:B>A;D=0<=A?++B:--B){G.push(F)}}this.frame=G;return this.direction=I};return z})(g);s=(function(z){w(y,z);function y(){y.__super__.constructor.call(this,3);this.setImage("characters/player.png");this.setDirection(b.Up)}return y})(e);p=(function(z){w(y,z);function y(){y.__super__.constructor.call(this);this.time=0}y.prototype.load=function(B,C){var A;A=this;return $.getJSON(B,{},function(D){C(D);A.data=D;A.operations=D.operations;return A.addEventListener("enterframe",A.update)})};y.prototype.setScene=function(A){return this.scene=A};y.prototype.update=function(B){var A;if(!this.operations.isEmpty()){A=this.operations[0];if(A.offset<this.time){this.performOperation(A);this.operations.shift()}}return this.time+=B.elapsed/1000};y.prototype.performOperation=function(B){var A;if(this.scene!=null){A=new a(B.x,B.y);this.scene.setCursorPosition(A.clone().add(new a(1,1)));return this.scene.rotate(A,B.direction)}};return y})(Group);n={Grass:0,Lake:1,Tower:2,Castle:3,Cave:4,Forest:5};d={None:0,Ground:1,Goal:2,Wall:3,BrokenGround:4,Hole:5,Rock:6,Ice:7,NeedleLeft:224,NeedleUp:225,NeedleRight:226,NeedleDown:227};i=(function(z){w(y,z);y.WIDTH=48;y.HEIGHT=48;function y(B,A,C){y.__super__.constructor.call(this,y.WIDTH,y.HEIGHT);this.setType(C);this.addEventListener("enterframe",this.update);this.localX=B;this.localY=A;this.x=B*y.WIDTH;this.y=A*y.HEIGHT;if(this.type===d.NeedleRight){this.setDirection(b.Right)}else{if(this.type===d.NeedleUp){this.setDirection(b.Up)}else{if(this.type===d.NeedleLeft){this.setDirection(b.Left)}else{this.setDirection(b.Down)}}}}y.prototype.update=function(A){return this.rotaiton=this.direction*90};y.prototype.setType=function(A){this.type=A;return this.setImage(this.getFilePath(n.Cave,A))};y.prototype.getFilePath=function(A,C){var D,E,B;D="chips";E=["grass","lake","tower","castle","cave","forest"];if(C===d.None){return""+D+"/none.png"}else{if(C===d.Ice){return""+D+"/ice.png"}else{if(C===d.NeedleRight||C===d.NeedleDown||C===d.NeedleUp||C===d.NeedleLeft){return""+D+"/"+E[A]+"/needle.png"}else{B=["ground","goal","rock","broken","hole","rock"];return""+D+"/"+E[A]+"/"+B[C-1]+".png"}}}};y.prototype.getTileType=function(){return this.type};y.prototype.onAfterMove=function(A){if(this.type===d.BrokenGround){return this.setType(d.Hole)}};y.prototype.isDangerous=function(B){var C,A;if((C=this.type)===d.NeedleRight||C===d.NeedleDown||C===d.NeedleUp||C===d.NeedleLeft){return B===((this.direction+2)%4)}return(A=this.type)===d.Hole||A===d.Needle||A===d.None};y.prototype.isWalkable=function(B){var C,A;if((C=this.type)===d.NeedleRight||C===d.NeedleDown||C===d.NeedleUp||C===d.NeedleLeft){return B===(this.direction+2)%4}return !((A=this.type)===d.Rock||A===d.Wall)};y.prototype.isRotatable=function(){var A;return !((A=this.type)===d.None)};y.prototype.setDirection=function(A){this.originX=y.WIDTH*0.5;this.originY=y.HEIGHT*0.5;this.direction=A;return this.rotation=90*((A+2)%4)};return y})(o);k={Left:0,Right:1};m=(function(z){w(y,z);y.speed=10;function y(O,H,F,M){var L,J,K,Q,P,I,C,A,N,R,G,E,D,B;y.__super__.constructor.call(this);this.map=O;this.lu=this.map.getTile(H,F);this.ld=this.map.getTile(H,F+1);this.ru=this.map.getTile(H+1,F);this.rd=this.map.getTile(H+1,F+1);this.root=this.lu.getPosition().clone();this.end=this.lu.getPosition().clone().add(new a(i.WIDTH*2,i.HEIGHT*2));G=[this.lu,this.ld,this.ru,this.rd];for(C=0,N=G.length;C<N;C++){K=G[C];K.parentNode.removeChild(K);this.addChild(K);K.x-=this.root.x;K.y-=this.root.y}this.objects=[];E=this.map.objects;for(A=0,R=E.length;A<R;A++){Q=E[A];if((this.root.x<=(D=Q.x)&&D<this.end.x)&&(this.root.y<=(B=Q.y)&&B<this.end.y)){J=this.map.globalToLocal(Q.getPosition().x,Q.getPosition().y);P=this.map.getTile(J.x,J.y);this.objects.push([Q,P]);this.map.objectLayer.removeChild(Q);this.addChild(Q);Q.setPosition(this.globalToNodePosition(Q.getPosition()))}}I=i.WIDTH;L=i.HEIGHT;this.originX=I;this.originY=L;this.x=this.root.x;this.y=this.root.y;this.count=0;this.direction=M;this.addEventListener("enterframe",this.update)}y.prototype.update=function(I){var H,M,E,L,K,B,J,F,D,N,A,G,C;if(!this.isEnd()){if(this.direction===k.Left){B=-y.speed}else{B=y.speed}this.rotation+=B;this.count+=1}if(this.isEnd()){M=this.map.globalToLocal(this.root.x,this.root.y);L=M.x;K=M.y;if(this.direction===k.Left){this.map.setTile(L,K+1,this.lu);this.map.setTile(L,K,this.ru);this.map.setTile(L+1,K,this.rd);this.map.setTile(L+1,K+1,this.ld)}else{this.map.setTile(L,K+1,this.rd);this.map.setTile(L,K,this.ld);this.map.setTile(L+1,K,this.lu);this.map.setTile(L+1,K+1,this.ru)}G=[this.lu,this.ld,this.ru,this.rd];for(F=0,N=G.length;F<N;F++){J=G[F];J.rotation=0;J.originX=i.WIDTH*0.5;J.originY=i.HEIGHT*0.5;this.removeChild(J);this.map.tileLayer.addChild(J);if(this.direction===k.Left){J.setDirection((J.direction-1)%4)}else{J.setDirection((J.direction+1)%4)}}C=this.objects;for(D=0,A=C.length;D<A;D++){H=C[D];E=H[0];J=H[1];this.removeChild(E);this.map.objectLayer.addChild(E);if(this.direction===k.Left){E.setDirection((E.direction-1)%4)}else{E.setDirection((E.direction+1)%4)}E.setPosition(J.getPosition())}return this.map.removeChild(this)}};y.prototype.isEnd=function(){return this.count>=90/y.speed};y.prototype.globalToNodePosition=function(A){return A.clone().sub(this.root)};y.prototype.nodeToGlobalPosition=function(A){return A.clone().add(this.root)};return y})(Group);j=(function(z){w(y,z);function y(A,J,E){var H,B,F,I,G,D,C;y.__super__.constructor.apply(this,arguments);this.tileLayer=new Group();this.objectLayer=new Group();this.addChild(this.tileLayer);this._map=[];for(I=D=0;0<=A?D<A:D>A;I=0<=A?++D:--D){this._map.push([]);for(G=C=0;0<=J?C<J:C>J;G=0<=J?++C:--C){B=E.map[I][G];F=new i(I,G,B);this._map[I].push(F);this.tileLayer.addChild(F)}}this.width=A;this.height=J;this.player=new s();this.player.setPosition(this.localToGlobal(E.player[0],E.player[1]));H=((b.Left+E.player[2])+4)%4;this.player.setDirection(H);this.characters=[this.player];this.objects=[this.player];this.addChild(this.objectLayer);this.objectLayer.addChild(this.player)}y.prototype.getTile=function(A,B){if(A<0||B<0||A>=this.width||B>=this.height){return void 0}return this._map[A][B]};y.prototype.setTile=function(A,D,C){var B;B=this.localToGlobal(A,D);C.localX=A;C.localY=D;C.x=B.x;C.y=B.y;return this._map[A][D]=C};y.prototype.rotate=function(G,E,F){var D,A,C,J,B,I,H;if(G<0||G>=this.width-1||E<0||E>=this.height){return null}C=this.getTile(G,E);A=this.getTile(G,E+1);B=this.getTile(G+1,E);J=this.getTile(G+1,E+1);H=C.width;D=C.height;I=new m(this,G,E,F);return I};y.prototype.localToGlobal=function(A,B){return new a(A*i.WIDTH,B*i.HEIGHT)};y.prototype.globalToLocal=function(A,B){return new a(Math.floor(A/i.WIDTH),Math.floor(B/i.HEIGHT))};y.prototype.getPointWithDirection=function(A,B){switch(B){case b.Up:return new a(A.x,A.y-1);case b.Left:return new a(A.x-1,A.y);case b.Down:return new a(A.x,A.y+1);case b.Right:return new a(A.x+1,A.y)}};y.prototype.canRotate=function(B,F){var C,E,D,A;E=this.getTile(B,F);C=this.getTile(B,F+1);A=this.getTile(B+1,F);D=this.getTile(B+1,F+1);return E.isRotatable()&&C.isRotatable()&&A.isRotatable()&&D.isRotatable()};return y})(Group);f={Play:0,Metric:1};l={Ready:0,Main:1,Rotation:2,Move:3,Goal:4,GameOver:5};v=(function(z){w(y,z);function y(E,A,D,C){var B;if(D==null){D=f.Play}if(C==null){C=void 0}y.__super__.constructor.apply(this,arguments);this.mode=D;this.metric=C;this.map=new j(10,10,E);this.addChild(this.map);this.addEventListener("enterframe",this.update);this.cursor=new o(144,144);this.cursor.setImage("cursor0.png");this.cursor.x=i.WIDTH-144/2;this.cursor.y=i.HEIGHT-144/2;this.metricPK=A;B=document.getElementById("enchant-stage");B.scene=this;if(this.mode===f.Play){B.addEventListener("mousemove",this.updateMousePosition);B.addEventListener("mousedown",this.onMousePressed)}else{C.setScene(this);this.addChild(C)}B.oncontextmenu=function(){return false};this.addChild(this.cursor);this.rotationSet=void 0;this.state=l.Main;this.prevTile=void 0}y.prototype.setup=function(){return this};y.prototype.update=function(B){var A;if(this.state===l.Rotation){if(this.rotationSet.isEnd()){this.rotationSet=void 0;this.state=l.Move;A=this.map.globalToLocal(this.map.player.x,this.map.player.y);this.prevTile=this.map.getTile(A.x,A.y);if(!this.moveNext(this.map.player,this.map.player.direction)){return this.state=l.Main}}}else{if(this.state===l.Move){if(!this.map.player.isMoving()){return this.onMoveCompleted()}}}};y.prototype.onMoveCompleted=function(){var A,D,B,C;A=this.map.globalToLocal(this.map.player.getPosition().x,this.map.player.getPosition().y);B=this.map.getTile(A.x,A.y);if((C=this.prevTile)!=null){C.onAfterMove(this.map.player.direction)}if(!(B!=null)||B.isDangerous(this.map.player.direction)){this.state=l.GameOver;if(this.mode===f.Play){D=this;return new x("/metrics/"+this.metricPK+"/update",{state:2},function(E){var F;console.log(E);if(confirm("ゲームオーバー もう一度プレイしますか？")){F=new c();F.setup(D.metricPK);return u.game.replaceScene(F)}else{return location.href="/"}})}}else{if(B.getTileType()===d.Goal){this.state=l.Goal;if(this.mode===f.Play){D=this;return new x("/metrics/"+this.metricPK+"/update",{state:1},function(E){console.log(E);if(confirm("ステージクリア！他のステージを遊びますか？")){return $.get("/levels/json?ignore="+D.metricPK,{},function(F){var H,G;console.log(F);G=F;H=new c();H.setup(D.metricPK,F);return u.game.replaceScene(H)})}})}}else{if(B.type===d.Ice){if(!this.moveNext(this.map.player,this.map.player.direction)){return this.state=l.Main}}else{return this.state=l.Main}}}};y.prototype.setCursorPosition=function(A){this.cursor.x=i.WIDTH*A.x-144/2;return this.cursor.y=i.HEIGHT*A.y-144/2};y.prototype.moveNext=function(B,D){var C,A;C=this.map.getPointWithDirection(this.map.globalToLocal(B.x,B.y),D);A=this.map.getTile(C.x,C.y);if(!(A!=null)||((A!=null)&&A.isWalkable(D))){this.moveTo(B,D,10);return true}return false};y.prototype.updateMousePosition=function(B){var A;A=this.scene.map.globalToLocal(B.clientX,B.clientY);return this.scene.setCursorPosition(A)};y.prototype.onMousePressed=function(B){var D,C,A;A=this.scene.map.globalToLocal(B.clientX,B.clientY).sub(new a(1,1));if(this.scene.map.canRotate(A.x,A.y)){C=false;if(B.button===0){D=k.Left;C=this.scene.rotate(A,k.Left)}else{D=k.Right;C=this.scene.rotate(A,k.Right)}if(C&&this.scene.mode===f.Play){new x("/operations/create",{metric:this.scene.metricPK,x:A.x,y:A.y,direction:D},function(E){return console.log(E)});return true}}return false};y.prototype.rotate=function(A,B){var C;if(this.state===l.Main){C=this.map.rotate(A.x,A.y,B);if(C!==null){this.rotationSet=C;this.map.addChild(C);this.state=l.Rotation;return true}}return false};y.prototype.moveTo=function(C,D,E){var G,B,A,F;if(h.call(this.map.characters,C)>=0){B=this.map.globalToLocal(C.x,C.y);G=this.map.localToGlobal(B.x,B.y);A=this.map.getPointWithDirection(B,D);F=this.map.localToGlobal(A.x,A.y);return C.setMoveAnimation(G,F,E)}};return y})(Scene);c=(function(z){w(y,z);function y(){return y.__super__.constructor.apply(this,arguments)}y.prototype.setup=function(A,C){var E,D,B;if(C==null){C=void 0}if(C!=null){D=C.pk;B="/levels/"+D+"/json";$("#stage_url").attr("stageurl",B)}else{B=$("#stage_url").attr("stageurl");D=B.match(/[0-9]+/)[0]}E=$("#metric_url");return $.getJSON(B,{},function(H){var F,G,I;if(E.size()>0){G=E.attr("metricurl");F=new p();return F.load(G,function(J){return u.game.replaceScene(new v(H.stage_data,void 0,f.Metric,F))})}else{I={stage:D};if(A!=null){I.pre_metric=A}return new x("/metrics/create",I,function(J){var K;K=J.pk;return u.game.replaceScene(new v(H.stage_data,K),f.Play)})}})};return y})(Scene)}).call(this);