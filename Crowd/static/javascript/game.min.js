(function(){var d,a,l,m,c,q,r,i,f,o,j,h,k,e,p,b,n={}.hasOwnProperty,s=function(w,u){for(var t in u){if(n.call(u,t)){w[t]=u[t]}}function v(){this.constructor=w}v.prototype=u.prototype;w.prototype=new v();w.__super__=u.prototype;return w},g=[].indexOf||function(v){for(var u=0,t=this.length;u<t;u++){if(u in this&&this[u]===v){return u}}return -1};b=(function(){function t(u,v){if(u==null){u=0}if(v==null){v=0}this.set(u,v)}t.prototype.set=function(u,v){if(u==null){u=0}if(v==null){v=0}this.x=u;this.y=v;return this};t.prototype.add=function(u){this.x+=u.x;this.y+=u.y;return this};t.prototype.sub=function(u){this.x-=u.x;this.y-=u.y;return this};t.prototype.scale=function(u){this.x*=u;this.y*=u;return this};t.prototype.div=function(u){this.x/=u;this.y/=u;return this};t.prototype.product=function(u){return this.x*u.x+this.y*u.y};t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};t.prototype.resize=function(u){if(this.length()){this.scale(u/this.length())}return this};t.prototype.normalize=function(){return this.resize(1)};t.prototype.angle=function(){return(180*Math.atan2(this.y,this.x))/Math.PI};t.prototype.rotate=function(z){var v,w,u,A;v=(z*Math.PI)/180;w=this.length();u=this.x;A=this.y;this.x=Math.sin(v)*A+Math.cos(v)*u;this.y=Math.cos(v)*A-Math.sin(v)*u;return this.resize(w)};t.prototype.clone=function(){return new t(this.x,this.y)};t.prototype.reverse=function(){this.x*=-1;this.y*=-1;return this};t.prototype.max=function(u){if(this.length()<=u){return this}return this.resize(u)};t.prototype.min=function(u){if(this.length()>=u){return this}return this.resize(u)};t.prototype.isZero=function(){return this.x===0&&this.y===0};return t})();Array.prototype._index=function(t){var u;if(t<0){u=this.length;return u+t}return t};Array.prototype.at=function(t){return this[this._index(t)]};Array.prototype.map=function(t){var v,u;return([].splice.apply(this,[0,this.length-0].concat(u=(function(){var y,x,w;w=[];for(y=0,x=this.length;y<x;y++){v=this[y];w.push(t(v))}return w}).call(this))),u)};Array.prototype.clone=function(){return this.dup()};Array.prototype.dup=function(){return this.slice(0,this.length)};Array.prototype.each=function(u){var t,w,v;for(t=w=0,v=this.length;0<=v?w<v:w>v;t=0<=v?++w:--w){u(this[t],t)}return this};Array.prototype.deleteAt=function(t){t=this._index(t);if(t>=this.length){return void 0}return this.splice(t,1)};Array.prototype.deleteIf=function(u){var t;return this.replace((function(){var x,w,v;v=[];for(t=x=0,w=this.length;0<=w?x<w:x>w;t=0<=w?++x:--x){if(!u(this[t],t)){v.push(this[t])}}return v}).call(this))};Array.prototype.reject=function(t){var u;u=this.length;this.deleteIf(t);if(u===this.length){return void 0}return this};Array.prototype.isEmpty=function(){return this.length===0};Array.prototype.isEql=function(t,x){var u,w,v;if(x==null){x=function(z,y){return z===y}}if(this.length!==t.length){return false}for(u=w=0,v=this.length;0<=v?w<v:w>v;u=0<=v?++w:--w){if(!x(this[u],t[u])){return false}}return true};Array.prototype.fill=function(w,x,t){var u,v;if(x==null){x=0}if(t==null){t=this.length-1}x=this._index(x);t=this._index(t);[].splice.apply(this,[x,t-x+1].concat(v=(function(){var z,y;y=[];for(u=z=x;x<=t?z<=t:z>=t;u=x<=t?++z:--z){y.push(w)}return y})())),v;return this};Array.prototype.first=function(){return this[0]};Array.prototype.last=function(){var t;t=this._index(-1);return this[t]};Array.prototype.uniq=function(x){var w,v,u,t;if(x==null){x=function(z,y){return z===y}}w=[];for(u=0,t=this.length;u<t;u++){v=this[u];if(!w.isInclude(v,x)){w.push(v)}}return this.replace(w)};Array.prototype.index=function(w,x){var t,v,u;if(x==null){x=function(z,y){return z===y}}for(t=v=0,u=this.length;0<=u?v<u:v>u;t=0<=u?++v:--v){if(x(this[t],w)){return t}}return void 0};Array.prototype.indexes=function(){var v,w,u,t;t=[];for(w=0,u=arguments.length;w<u;w++){v=arguments[w];t.push(this.at(v))}return t};Array.prototype.rindex=function(w,x){var t,v,u;if(x==null){x=function(z,y){return z===y}}for(t=v=u=this.length;u<=0?v<0:v>0;t=u<=0?++v:--v){if(x(this[t],w)){return t}}return void 0};Array.prototype.flatten=function(){return this.replace(this.reduce(function(u,t){return u.concat(t instanceof Array?t.flatten():t)},[]))};Array.prototype.transpose=function(){var B,A,z,v,u,E,D,C;v=this.isEmpty()?0:this.length;B=this.first() instanceof Array?this.first().length:0;if(!v||!B){return this}z=(function(){var w,t;t=[];for(A=w=0;0<=B?w<B:w>B;A=0<=B?++w:--w){t.push([])}return t})();for(u=D=0;0<=v?D<v:D>v;u=0<=v?++D:--D){for(E=C=0;0<=B?C<B:C>B;E=0<=B?++C:--C){z[E][u]=this[u][E]}}return this.replace(z)};Array.prototype.compact=function(){return this.deleteIf(function(t){return t===void 0})};Array.prototype.isInclude=function(w,x){var u,v,t;if(x==null){x=function(z,y){return z===y}}for(v=0,t=this.length;v<t;v++){u=this[v];if(x(u,w)){return true}}return false};Array.prototype.size=function(){return this.length};Array.prototype.swap=function(u,t){var v;u=this._index(u);t=this._index(t);v=this[u];this[u]=this[t];this[t]=v;return this};Array.prototype.shuffle=function(){var t,v,u;for(t=v=0,u=this.length;0<=u?v<u:v>u;t=0<=u?++v:--v){this.swap(t,Math.floor(Math.random()*this.length))}return this};Array.prototype.choice=function(){return this[Math.floor(Math.random()*this.length)]};Array.prototype.count=function(x,y){var t,u,w,v;if(y==null){y=function(A,z){return A===z}}u=0;for(t=w=0,v=this.length;0<=v?w<v:w>v;t=0<=v?++w:--w){if(y(this[t],x)){++u}}return u};Array.prototype.replace=function(t){var v,w,u;this.clear();for(w=0,u=t.length;w<u;w++){v=t[w];this.push(v)}return this};Array.prototype.nitems=function(){return this.clone().compact().size()};Array.prototype.insert=function(){var v,w,u,t,y,x;v=Array.prototype.slice.call(arguments,0,arguments.length);if(v.size()<=1){return this}u=this._index(v[0]);t=v.slice(1,this.length);for(w=y=0,x=t.length;0<=x?y<x:y>x;w=0<=x?++y:--y){this.splice(u+w,0,t[w])}return this};Array.prototype.clear=function(){var t;t=[];while(!this.isEmpty()){t.push(this.deleteAt(0))}return t};Array.prototype.max=function(u){var t;if(u==null){u=function(w,v){if(w===v){return 0}if(w<v){return -1}else{return 1}}}t=this.first();this.reduce(function(w,v){if(u(t,v)<0){return t=v}});return t};Array.prototype.min=function(u){var t;if(u==null){u=function(w,v){if(w===v){return 0}if(w<v){return -1}else{return 1}}}t=this.first();this.reduce(function(w,v){if(u(t,v)>=0){return t=v}});return t};p=(function(){function t(u,w,y,x,v){if(w==null){w=false}if(y==null){y=0}if(x==null){x=false}if(v==null){v=void 0}this.set(u);this._time=y;this._active=x;this._onComplete=v;this._onUpdate=void 0;this._repeat=w}t.prototype.set=function(u){if(u==null){u=0}this._max=u;return this};t.prototype.play=function(){this._active=true;return this};t.prototype.stop=function(){this._active=false;this._time=0;return this};t.prototype.pause=function(){this._active=false;return this};t.prototype.reset=function(){this._time=0;return this};t.prototype.tick=function(){if(this._time<this._max&&this._active){++this._time;if(this._onUpdate!=null){this._onUpdate(this)}if(this._time===this._max){if(this._onComplete!=null){this._onComplete(this)}if(this._repeat){this._time=0}}}return this};t.prototype.now=function(){return this._time};t.prototype.max=function(){return this._max};t.prototype.setNow=function(u){this._time=u;return this};t.prototype.setOnComplete=function(u){this._onComplete=u;return this};t.prototype.setOnUpdate=function(u){return this._onUpdate=u};t.prototype.setRepeat=function(u){this._repeat=u;return this};t.prototype.isActive=function(){return this._active};t.prototype.isOver=function(){return this._time>=this._max};return t})();m=(function(){function t(){}t._sounds=[];t.root="";t.load=function(){var y,u,x,w,v;u=Array.prototype.slice.call(arguments);v=[];for(x=0,w=u.length;x<w;x++){y=u[x];v.push(t._loadSound(y))}return v};t.play=function(u){if(!(t._sounds[u]!=null)){t._loadSound(u)}t.stop(u);return t._sounds[u].play()};t.pause=function(u){if(u!=null){return t._sounds[u].pause()}};t.stop=function(u){if(u!=null){return t._sounds[u].stop()}};t._loadSound=function(v,u){if(!(t._sounds[v]!=null)){if(u!=null){return t._sounds[v]=Sound.load(""+t.root+v,u)}else{return t._sounds[v]=Sound.load(""+t.root+v)}}};return t})();enchant();q=(function(u){s(t,u);t.prototype.config={WIDTH:640,HEIGHT:480,FPS:30,FONT:"Helvetica",IMAGE_PATH:"/image/",IMAGES:["kawaz.png","characters/player.png","chips/grass.png","cursor0.png"],SOUND_PATH:"/sound/",SOUNDS:[],INITIAL_LEVEL:1,LAST_LEVEL:7,LEVEL_TIME:30};function t(){var z,w,y,v,x;t.__super__.constructor.call(this,this.config.WIDTH,this.config.HEIGHT);this.fps=this.config.FPS;this.keybind(90,"a");this.keybind(88,"b");t.game=this;t.config=this.config;x=this.config.IMAGES;for(y=0,v=x.length;y<v;y++){z=x[y];this.preload(""+this.config.IMAGE_PATH+z)}w=new c();this.onload=function(){w.setup();return this.pushScene(w)};this.start()}return t})(Game);window.onload=function(){return new q()};l=(function(t){s(u,t);function u(z,A,v,B){if(v==null){v=0}if(B==null){B=0}u.__super__.constructor.call(this,z,A);this.removeEventListener("enterframe");this.x=v;this.y=B;this.velocity=new b();this.speed=7}u.prototype.update=function(v){this.x+=this.velocity.x;return this.y+=this.velocity.y};u.prototype.setImage=function(v){return this.image=q.game.assets[""+q.config.IMAGE_PATH+v]};u.prototype.getPosition=function(){return new b(this.x,this.y)};u.prototype.getCenter=function(){return new b(this.x+this.width/2,this.y+this.height/2)};u.prototype.setPosition=function(w){this.x=w.x;return this.y=w.y};return u})(Sprite);f=(function(t){s(u,t);function u(v,x){u.__super__.constructor.call(this,v,x);this.addEventListener("enterframe",this.update)}u.prototype.update=function(w){var v;if((v=this.timer)!=null){v.tick()}if(this.timer.isOver()){return this}};u.prototype.setMoveAnimation=function(y,x,w){var v;if(!(this.timer!=null)||this.timer.isOver()){this.timer=new p(w);this.timer.play();v=this;return this.timer.setOnUpdate(function(){var z,A;z=x.clone().sub(y);A=z.div(w);v.x+=A.x;return v.y+=A.y})}};return u})(l);a={Up:0,Right:1,Down:2,Left:3};d=(function(t){s(u,t);function u(v){u.__super__.constructor.call(this,48,48);this.maxFrame=v;this.fps=10}u.prototype.setDirection=function(D){var B,A,y,C,x,w,z,v;C=this.maxFrame*((D+2)%4);B=[];for(A=x=C,z=C+this.maxFrame;C<=z?x<z:x>z;A=C<=z?++x:--x){for(y=w=0,v=this.fps;0<=v?w<v:w>v;y=0<=v?++w:--w){B.push(A)}}return this.frame=B};return u})(f);o=(function(u){s(t,u);function t(){t.__super__.constructor.call(this,3);this.setImage("characters/player.png");this.setDirection(a.Up)}return t})(d);e={None:0,Floor:1,Wall:2};h=(function(u){s(t,u);t.WIDTH=48;t.HEIGHT=48;function t(){t.__super__.constructor.call(this,t.WIDTH,t.HEIGHT);this.setImage("chips/grass.png");this.direction=0;this.addEventListener("enterframe",this.update)}t.prototype.update=function(v){return this.rotaiton=this.direction*90};return t})(l);j={Left:0,Right:1};k=(function(u){s(t,u);t.speed=10;function t(v,H,D,G){var C,z,E,I,A,F,B;t.__super__.constructor.call(this);this.map=v;this.lu=this.map.getTile(H,D);this.ld=this.map.getTile(H,D+1);this.ru=this.map.getTile(H+1,D);this.rd=this.map.getTile(H+1,D+1);E=this.lu.getPosition().clone();B=[this.lu,this.ld,this.ru,this.rd];for(A=0,F=B.length;A<F;A++){z=B[A];this.map.removeChild(z);this.addChild(z);z.x-=E.x;z.y-=E.y}this.map.addChild(this);I=h.WIDTH;C=h.HEIGHT;this.originX=I;this.originY=C;this.rootx=H;this.rooty=D;this.x=E.x;this.y=E.y;this.count=0;this.direction=G}t.prototype.update=function(A){var z,w,y,v,x;if(!this.isEnd()){if(this.direction===j.Left){z=-t.speed}else{z=t.speed}this.rotation+=z;this.count+=1}if(this.isEnd()){if(this.direction===j.Left){this.map.setTile(this.rootx,this.rooty+1,this.lu);this.map.setTile(this.rootx,this.rooty,this.ru);this.map.setTile(this.rootx+1,this.rooty,this.rd);this.map.setTile(this.rootx+1,this.rooty+1,this.ld)}else{this.map.setTile(this.rootx,this.rooty+1,this.rd);this.map.setTile(this.rootx,this.rooty,this.ld);this.map.setTile(this.rootx+1,this.rooty,this.lu);this.map.setTile(this.rootx+1,this.rooty+1,this.ru)}x=[this.lu,this.ld,this.ru,this.rd];for(y=0,v=x.length;y<v;y++){w=x[y];w.rotation=0;w.originX=h.WIDTH*0.5;w.originY=h.HEIGHT*0.5;w.direction=(w.direction+1)%4;this.removeChild(w);this.map.addChild(w)}console.log("hoge");return this.map.removeChild(this)}};t.prototype.isEnd=function(){return this.count>=90/t.speed};return t})(Group);i=(function(u){s(t,u);function t(z,w){var B,v,D,C,A;t.__super__.constructor.apply(this,arguments);this._map=[];for(v=C=0;0<=z?C<z:C>z;v=0<=z?++C:--C){this._map.push([]);for(D=A=0;0<=w?A<w:A>w;D=0<=w?++A:--A){B=new h();B.x=v*48;B.y=D*48;this._map[v].push(B);this.addChild(B)}}this.width=z;this.height=w;this.player=new o();this.player.setPosition(this.localToGlobal(1,1));this.characters=[this.player];this.addChild(this.player)}t.prototype.getTile=function(v,w){return this._map[v][w]};t.prototype.setTile=function(w,B,A){var z;z=this.localToGlobal(w,B);A.x=z.x;A.y=z.y;return this._map[w][B]=A};t.prototype.rotate=function(E,C,D){var B,v,A,H,z,G,F;if(E<0||E>=this.width-1||C<0||C>=this.height){return null}A=this.getTile(E,C);v=this.getTile(E,C+1);z=this.getTile(E+1,C);H=this.getTile(E+1,C+1);F=A.width;B=A.height;G=new k(this,E,C,D);return G};t.prototype.localToGlobal=function(v,w){return new b(v*h.WIDTH,w*h.HEIGHT)};t.prototype.globalToLocal=function(v,w){return new b(Math.floor(v/h.WIDTH),Math.floor(w/h.HEIGHT))};t.prototype.getTileWithDirection=function(w,x){switch(x){case a.Up:return this.getTile(w.x,w.y-1);case a.Left:return this.getTile(w.x-1,w.y);case a.Down:return this.getTile(w.x,w.y+1);case a.Right:return this.getTile(w.x+1,w.y)}};return t})(Group);r=(function(u){s(t,u);function t(){var v;t.__super__.constructor.apply(this,arguments);this.map=new i(10,10);this.addChild(this.map);this.addEventListener("enterframe",this.update);this.cursor=new l(144,144);this.cursor.setImage("cursor0.png");this.cursor.x=0;this.cursor.y=100;v=document.getElementById("enchant-stage");v.scene=this;v.addEventListener("mousemove",this.updateMousePosition);this.addEventListener("touchstart",this.onMousePressed);this.addChild(this.cursor);this.tileSetQueue=[];this.moveTo(this.map.player,a.Up,10)}t.prototype.setup=function(){return this};t.prototype.update=function(z){var A,y,w,x,v;x=this.tileSetQueue;v=[];for(y=0,w=x.length;y<w;y++){A=x[y];A.update();if(A.isEnd()){v.push(this.tileSetQueue.deleteAt(this.tileSetQueue.index(A)))}else{v.push(void 0)}}return v};t.prototype.updateMousePosition=function(x){var y,w;y=this.scene.cursor;w=this.scene.map.globalToLocal(x.clientX,x.clientY);y.x=h.WIDTH*w.x-144/2;return y.y=h.HEIGHT*w.y-144/2};t.prototype.onMousePressed=function(x){var y,w;w=this.map.globalToLocal(x.x-h.WIDTH,x.y-h.HEIGHT);y=this.map.rotate(w.x,w.y,j.Left);if(y!==null){return this.tileSetQueue.push(y)}};t.prototype.rotate=function(v){return this};t.prototype.moveTo=function(y,z,A){var x,v,w;if(g.call(this.map.characters,y)>=0){v=this.map.globalToLocal(y.x,y.y);x=this.map.getTile(v.x,v.y);w=this.map.getTileWithDirection(v,z);return y.setMoveAnimation(x.getPosition(),w.getPosition(),A)}};return t})(Scene);c=(function(u){s(t,u);function t(){return t.__super__.constructor.apply(this,arguments)}t.prototype.setup=function(){this.kawaz=new l(253,81);this.kawaz.setImage("kawaz.png");this.kawaz.x=193.5;this.kawaz.y=220;this.kawaz.opacity=0;this.addChild(this.kawaz);this.addEventListener("enterframe",this.update);this.timer=new p(180);this.timer.setOnComplete(function(){q.game.replaceScene(new r());return this});return this.timer.play()};t.prototype.update=function(){if(q.game.input.a){q.game.replaceScene(new r());this}this.timer.tick();if(this.timer.now()<60){return this.kawaz.opacity+=1/60}else{if(this.timer.now()>120){return this.kawaz.opacity-=1/60}}};return t})(Scene)}).call(this);